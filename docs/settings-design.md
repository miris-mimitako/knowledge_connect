# 設定項目詳細設計書

## 概要

本ドキュメントでは、Knowledge Connectプラグインの設定項目について、詳細な仕様を定義します。

## 設定項目一覧

### 必須設定項目

#### 1. AI APIキー (apiKey)

**型**: `string`  
**デフォルト値**: `""` (空文字列)  
**説明**: 使用するAIサービスプロバイダーのAPIキーを設定します。  
**バリデーション**:
- 空文字列の場合は警告を表示（機能は使用不可）
- 最小長: 10文字（概算）
- 最大長: 500文字

**UI要素**:
- タイプ: パスワード入力フィールド（`addText` with `inputEl.type = "password"`）
- プレースホルダー: "APIキーを入力してください"
- 説明文: "選択したAIサービスプロバイダーのAPIキーを設定します。OpenRouterの場合は https://openrouter.ai/ でAPIキーを取得できます。"
- 表示順序: 1

**セキュリティ**:
- 入力値は暗号化して保存（Obsidianの`loadData`/`saveData`を使用）
- 設定画面ではマスク表示（`*`で表示）
- コピーボタンを提供（オプション）

---

#### 2. AIサービス選択 (aiService)

**型**: `enum` (`"openrouter" | "litellm"`)  
**デフォルト値**: `"openrouter"`  
**説明**: 使用するAIサービスプロバイダーを選択します。  
**バリデーション**:
- 指定された値のみ許可

**UI要素**:
- タイプ: ドロップダウン（`addDropdown`）
- オプション:
  - `"openrouter"`: "OpenRouter（初期実装）"
  - `"litellm"`: "LiteLLM（将来実装）"
- 説明文: "使用するAIサービスプロバイダーを選択してください。OpenRouterは複数のAIモデル（GPT-4、Claude、Geminiなど）に統一APIでアクセスできます。"
- 表示順序: 2

**実装状況**:
- **v1.0**: OpenRouterのみ実装
- **将来**: LiteLLM対応を追加予定

**依存関係**:
- `apiKey`が設定されている場合のみ有効化
- サービス変更時は、対応するAPIキーの形式を確認

**補足**:
- OpenRouterを使用することで、複数のAIモデル（OpenAI、Anthropic、Googleなど）に単一のAPIキーでアクセス可能
- OpenRouterのAPIキーは https://openrouter.ai/ で取得可能

---

#### 3. デフォルトの保存先フォルダ (defaultSaveFolder)

**型**: `string`  
**デフォルト値**: `""` (空文字列、保存時は現在のVaultルート)  
**説明**: AIが生成したデータのデフォルト保存先フォルダを指定します。  
**バリデーション**:
- 相対パス形式（Vaultルートからの相対パス）
- 無効な文字（`<`, `>`, `:`, `"`, `|`, `?`, `*`）を含まない
- フォルダが存在しない場合は、保存時に作成を提案

**UI要素**:
- タイプ: テキスト入力 + フォルダ選択ボタン
- プレースホルダー: "例: AI出力/チャット履歴"
- 説明文: "AIが生成したデータのデフォルト保存先フォルダを指定します。空欄の場合はVaultルートに保存されます。"
- フォルダ選択ボタン: Obsidianのフォルダ選択ダイアログを開く
- 表示順序: 3

**補足**:
- パス区切り文字は`/`を使用（Windows/Mac/Linux共通）
- 先頭の`/`は省略可能（Vaultルートからの相対パス）

---

### オプション設定項目

#### 4. チャット履歴の保持期間 (chatHistoryRetentionDays)

**型**: `number`  
**デフォルト値**: `30`  
**説明**: チャット履歴を保持する日数を指定します。  
**バリデーション**:
- 最小値: 1
- 最大値: 365
- 整数のみ

**UI要素**:
- タイプ: 数値入力（`addText` with `inputEl.type = "number"`）
- プレースホルダー: "30"
- 説明文: "チャット履歴を保持する日数です。この期間を過ぎた履歴は自動的に削除されます。"
- 単位表示: "日"
- 表示順序: 4

**補足**:
- 0を設定した場合は無期限保持
- プラグイン起動時または定期実行で古い履歴を削除

---

#### 5. 要約のデフォルト詳細度 (summaryDefaultDetail)

**型**: `enum` (`"brief" | "standard" | "detailed"`)  
**デフォルト値**: `"standard"`  
**説明**: 要約機能のデフォルト詳細度を設定します。  
**バリデーション**:
- 指定された値のみ許可

**UI要素**:
- タイプ: ドロップダウン（`addDropdown`）
- オプション:
  - `"brief"`: "簡潔（要点のみ）"
  - `"standard"`: "標準（バランス型）"
  - `"detailed"`: "詳細（包括的）"
- 説明文: "要約機能のデフォルト詳細度を設定します。実行時にも変更可能です。"
- 表示順序: 5

**補足**:
- 各実行時に詳細度を変更できるため、デフォルト値は参考程度

---

#### 6. Web検索結果の最大取得数 (searchMaxResults)

**型**: `number`  
**デフォルト値**: `10`  
**説明**: Web検索で取得する結果の最大数を指定します。  
**バリデーション**:
- 最小値: 1
- 最大値: 50
- 整数のみ

**UI要素**:
- タイプ: 数値入力（`addText` with `inputEl.type = "number"`）
- プレースホルダー: "10"
- 説明文: "Web検索で取得する結果の最大数です。多いほど情報量は増えますが、処理時間とAPIコストが増加します。"
- 単位表示: "件"
- 表示順序: 6

**補足**:
- APIのレート制限を考慮して上限を設定

---

#### 7. 通知設定 (notificationSettings)

**型**: `object`  
**デフォルト値**: 
```typescript
{
  showSuccess: true,
  showError: true,
  showInfo: false
}
```

**説明**: 各種通知の表示/非表示を設定します。

**サブ設定項目**:

##### 7.1. 成功通知を表示 (showSuccess)
- **型**: `boolean`
- **デフォルト値**: `true`
- **説明**: 操作成功時の通知を表示するかどうか

##### 7.2. エラー通知を表示 (showError)
- **型**: `boolean`
- **デフォルト値**: `true`
- **説明**: エラー発生時の通知を表示するかどうか

##### 7.3. 情報通知を表示 (showInfo)
- **型**: `boolean`
- **デフォルト値**: `false`
- **説明**: 情報通知（処理開始など）を表示するかどうか

**UI要素**:
- タイプ: 折りたたみ可能なセクション（`addCollapsible`または個別のチェックボックス）
- 各サブ項目をチェックボックス（`addToggle`）で表示
- 説明文: "各種通知の表示/非表示を設定します。"
- 表示順序: 7

---

#### 8. テーマ設定 (theme)

**型**: `enum` (`"auto" | "light" | "dark"`)  
**デフォルト値**: `"auto"`  
**説明**: Viewのテーマを設定します。  
**バリデーション**:
- 指定された値のみ許可

**UI要素**:
- タイプ: ドロップダウン（`addDropdown`）
- オプション:
  - `"auto"`: "自動（Obsidianの設定に従う）"
  - `"light"`: "ライト"
  - `"dark"`: "ダーク"
- 説明文: "Viewのテーマを設定します。「自動」を選択すると、Obsidianのテーマ設定に従います。"
- 表示順序: 8

**補足**:
- `"auto"`の場合、Obsidianのテーマ変更に自動追従

---

#### 9. コンテキストメニューを有効化 (enableContextMenu)

**型**: `boolean`  
**デフォルト値**: `true`  
**説明**: 右クリックメニューからのAI問い合わせ機能を有効化します。  
**バリデーション**:
- なし

**UI要素**:
- タイプ: トグルスイッチ（`addToggle`）
- 説明文: "エディタでテキストを選択して右クリックした際に、AI問い合わせメニューを表示します。"
- 表示順序: 9

---

#### 10. 自動保存を有効化 (enableAutoSave)

**型**: `boolean`  
**デフォルト値**: `false`  
**説明**: AIの応答を自動的にファイルに保存するかどうか。  
**バリデーション**:
- なし

**UI要素**:
- タイプ: トグルスイッチ（`addToggle`）
- 説明文: "AIの応答を自動的にデフォルト保存先フォルダに保存します。無効の場合は、手動で保存する必要があります。"
- 表示順序: 10

**依存関係**:
- `defaultSaveFolder`が設定されている場合のみ有効化可能

---

#### 11. タイムアウト設定 (timeoutSeconds)

**型**: `number`  
**デフォルト値**: `60`  
**説明**: AI API呼び出しのタイムアウト時間（秒）を設定します。  
**バリデーション**:
- 最小値: 10
- 最大値: 300
- 整数のみ

**UI要素**:
- タイプ: 数値入力（`addText` with `inputEl.type = "number"`）
- プレースホルダー: "60"
- 説明文: "AI API呼び出しのタイムアウト時間です。応答が遅い場合はこの値を増やしてください。"
- 単位表示: "秒"
- 表示順序: 11

---

#### 12. 最大トークン数 (maxTokens)

**型**: `number`  
**デフォルト値**: `2000`  
**説明**: AIの応答の最大トークン数を設定します。  
**バリデーション**:
- 最小値: 100
- 最大値: 8000（サービスによって異なる）
- 整数のみ

**UI要素**:
- タイプ: 数値入力（`addText` with `inputEl.type = "number"`）
- プレースホルダー: "2000"
- 説明文: "AIの応答の最大トークン数です。多いほど長い応答が可能ですが、APIコストが増加します。"
- 単位表示: "トークン"
- 表示順序: 12

**補足**:
- サービスごとに上限が異なるため、選択されたサービスに応じて最大値を動的に変更

---

## 設定インターフェース定義（TypeScript）

```typescript
export interface KnowledgeConnectSettings {
  // 必須設定
  apiKey: string;
  aiService: "openrouter" | "litellm";
  defaultSaveFolder: string;

  // オプション設定
  chatHistoryRetentionDays: number;
  summaryDefaultDetail: "brief" | "standard" | "detailed";
  searchMaxResults: number;
  notificationSettings: {
    showSuccess: boolean;
    showError: boolean;
    showInfo: boolean;
  };
  theme: "auto" | "light" | "dark";
  enableContextMenu: boolean;
  enableAutoSave: boolean;
  timeoutSeconds: number;
  maxTokens: number;
}

export const DEFAULT_SETTINGS: KnowledgeConnectSettings = {
  // 必須設定
  apiKey: "",
  aiService: "openrouter",
  defaultSaveFolder: "",

  // オプション設定
  chatHistoryRetentionDays: 30,
  summaryDefaultDetail: "standard",
  searchMaxResults: 10,
  notificationSettings: {
    showSuccess: true,
    showError: true,
    showInfo: false,
  },
  theme: "auto",
  enableContextMenu: true,
  enableAutoSave: false,
  timeoutSeconds: 60,
  maxTokens: 2000,
};
```

---

## 設定画面のレイアウト

### セクション構成

1. **基本設定**（必須設定項目）
   - AIサービス選択
   - AI APIキー
   - デフォルトの保存先フォルダ

2. **機能設定**（オプション設定項目）
   - チャット履歴の保持期間
   - 要約のデフォルト詳細度
   - Web検索結果の最大取得数
   - コンテキストメニューを有効化
   - 自動保存を有効化

3. **表示設定**（オプション設定項目）
   - テーマ設定
   - 通知設定

4. **高度な設定**（オプション設定項目）
   - タイムアウト設定
   - 最大トークン数

---

## バリデーションルール

### 全体のバリデーション

1. **必須設定の確認**
   - `apiKey`が空の場合、警告を表示（機能は使用不可）
   - `aiService`が選択されていない場合、エラーを表示

2. **依存関係の確認**
   - `enableAutoSave`が`true`の場合、`defaultSaveFolder`が設定されている必要がある
   - `aiService`が変更された場合、対応するAPIキーの形式を確認

3. **値の範囲確認**
   - 数値項目は指定された範囲内であることを確認
   - 文字列項目は無効な文字を含まないことを確認

### 保存時の処理

1. バリデーション実行
2. エラーがある場合は保存をキャンセルし、エラーメッセージを表示
3. 正常な場合は設定を保存
4. 設定変更を反映（必要に応じてViewを再読み込み）

---

## エラーハンドリング

### エラーメッセージ

- **APIキー未設定**: "APIキーを設定してください。機能を使用するには必須です。"
- **無効なAPIキー形式**: "APIキーの形式が正しくありません。"
- **無効なフォルダパス**: "フォルダパスに無効な文字が含まれています。"
- **数値範囲外**: "値は{最小値}から{最大値}の範囲で入力してください。"

### 警告メッセージ

- **APIキー未設定（機能使用時）**: "APIキーが設定されていません。設定画面でAPIキーを設定してください。"
- **フォルダが存在しない**: "指定されたフォルダが存在しません。保存時に作成されます。"

---

## 将来の拡張項目

以下の設定項目は将来のバージョンで追加を検討：

1. **LiteLLM対応**（v1.1以降）
   - LiteLLMプロバイダーの実装
   - ローカルLLMサーバーへの接続対応

2. **モデル選択機能**（v1.1以降）
   - OpenRouterで使用するモデルの選択（GPT-4、Claude、Geminiなど）
   - モデルごとの設定（温度、最大トークン数など）

3. **カスタムプロンプトテンプレート**
   - プロンプトテンプレートの作成・編集・削除
   - テンプレートのインポート/エクスポート

4. **複数AIサービスの同時使用**
   - 複数のAPIキー設定
   - サービスごとの使用優先順位

5. **レート制限設定**
   - リクエスト間隔の設定
   - 1日あたりのリクエスト数制限

6. **プロキシ設定**
   - プロキシサーバーの設定
   - 認証情報の設定

