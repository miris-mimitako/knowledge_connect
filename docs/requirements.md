# 要件定義書

## プロジェクト概要

本プロジェクトは、Obsidian用のコミュニティプラグインです。AIを活用した機能を提供し、ユーザーの知識管理と情報処理を支援します。

## 機能要件

### 1. AIチャット機能

**概要**
- AIと対話形式で会話できるチャット機能を提供します。

**詳細要件**
- チャットインターフェースを表示するUIを提供する
- ユーザーがテキスト入力でAIに質問や指示を送信できる
- AIからの応答をリアルタイムで表示する
- 会話履歴を保持し、過去のやり取りを参照できる
- チャットウィンドウを開閉できる
- 会話履歴をクリアできる機能を提供する
- チャット履歴から新しいページを作成できる機能を提供する
  - 問い合わせと返答がそのままページを構成する
  - 保存先は設定で指定した場所がデフォルト
  - 実行前にユーザーが保存先とファイル名を指定できる
- AIが要約してページを作成する機能を提供する
  - チャットのモデルをデフォルトとして使用
  - モデルを選択したうえで要約を実行
  - 保存先は設定で指定した場所がデフォルト
  - 実行前にユーザーが保存先とファイル名を指定できる

**UI要件**
- View（サイドパネル）として表示
- ObsidianのUIデザインに統合されたチャットインターフェース
- 入力フィールドと送信ボタン
- 会話履歴の表示エリア
- チャット履歴からページ作成ボタン
- AI要約でページ作成ボタン（モデル選択付き）
- 保存先選択ダイアログ

### 2. AI要約機能

**概要**
- 選択したテキストやファイルの内容をAIに要約してもらう機能を提供します。

**詳細要件**
- エディタで選択したテキストを要約できる
- 現在開いているファイル全体を要約できる
- 要約結果を表示するUIを提供する
- 要約結果をクリップボードにコピーできる
- 要約結果を現在のファイルに挿入できる
- 要約の詳細度（簡潔/標準/詳細）を選択できるオプションを提供する

**UI要件**
- コマンドパレットから実行可能なコマンド
- 要約結果を表示するView（サイドパネル）
- 要約オプションを設定するUI
- 要約結果をクリップボードにコピー、ファイルに挿入するボタン

### 3. AI Web検索機能

**概要**
- AIにWeb検索を依頼し、検索結果を取得・表示する機能を提供します。

**詳細要件**
- ユーザーが検索クエリを入力できる
- AIがWeb検索を実行し、関連情報を収集する
- 検索結果を構造化して表示する
- 検索結果のソース（URL）を表示する
- 検索結果をクリップボードにコピーできる
- 検索結果をファイルに保存できる
- 検索履歴を保持する（オプション）

**UI要件**
- View（サイドパネル）として表示
- 検索クエリ入力フィールド
- 検索結果を表示するエリア
- 検索結果のソースリンクを表示
- 検索履歴を表示する機能（オプション）

### 4. AI出力データ保存機能

**概要**
- AIが生成したデータ（チャット履歴、要約結果、検索結果など）を任意のフォルダやファイルに保存する機能を提供します。

**詳細要件**
- 保存先のフォルダを選択できる
- ファイル名を指定できる
- 保存形式を選択できる（Markdown、テキスト、JSONなど）
- 既存ファイルに追記するか、新規ファイルを作成するかを選択できる
- 保存前にプレビューを表示できる
- 保存成功/失敗の通知を表示する
- デフォルトの保存先フォルダを設定できる

**UI要件**
- 保存先選択ダイアログ
- ファイル名入力フィールド
- 保存形式選択ドロップダウン
- 保存オプション（新規/追記）の選択UI

### 5. コンテキストメニューからのAI問い合わせ機能

**概要**
- エディタで選択したテキスト（単語、行、段落など）を右クリックメニューから直接AIに問い合わせることができる機能を提供します。

**詳細要件**
- エディタでテキストを選択した状態で右クリックすると、コンテキストメニューにAI問い合わせオプションを表示する
- 選択したテキストを自動的にAIへの質問として送信する
- 選択したテキストに対して、以下のような問い合わせアクションを提供する：
  - 「この単語について説明する」
  - 「この内容を要約する」
  - 「この内容について質問する」
  - 「この内容を翻訳する」（オプション）
  - 「この内容を改善する」（オプション）
- AIの応答をView（サイドパネル）に表示する
- 応答結果をクリップボードにコピーできる
- 応答結果を現在のファイルに挿入できる
- 応答結果を別ファイルに保存できる
- テキストが選択されていない場合は、コンテキストメニューにAI問い合わせオプションを表示しない（または無効化する）

**UI要件**
- Obsidianの標準コンテキストメニューに統合されたメニュー項目
- 問い合わせタイプを選択するサブメニュー（オプション）
- AI応答を表示するView（サイドパネル）
- 応答に対するアクションボタン（コピー、挿入、保存など）

**技術要件**
- ObsidianのコンテキストメニューAPIを使用してメニュー項目を追加する
- エディタの選択状態を検出し、選択テキストを取得する
- 選択テキストが空の場合はメニュー項目を非表示または無効化する

### 6. アクティブページ要約機能（ページ右上ボタン）

**概要**
- アクティブページの右上に要約ボタンを配置し、テンプレートプロンプトを選択またはカスタム入力して、AIによる要約を実行し、新しいページとして保存する機能を提供します。

**詳細要件**
- アクティブページ（現在開いているエディタタブ）の右上に要約ボタンを表示する
- ボタンをクリックすると要約設定モーダルを表示する
- モーダル内で以下の操作が可能：
  - テンプレートプロンプトの選択（ラジオボタンまたはドロップダウン）
  - カスタムプロンプトのテキスト入力（テキストエリア）
  - LLMモデルの選択（ドロップダウン）
- 要約実行ボタンをクリックすると、現在のアクティブページの内容を取得する
- 選択したプロンプトテンプレート（またはカスタムプロンプト）とアクティブページの内容を組み合わせて、指定したLLMモデルに送信する
- 要約結果を新しいページとして保存する
  - ファイル名の形式: `summarized_元のページタイトル.md`
  - 保存先は元のページと同じフォルダ（または設定で指定したデフォルトフォルダ）
  - ファイル名が重複する場合は、番号を付与する（例: `summarized_元のページタイトル_1.md`）
- 要約実行中はローディング表示を表示する
- 要約完了後は成功通知を表示し、新しいページを開く（オプション）

**テンプレートプロンプト要件**
- デフォルトで3つのテンプレートプロンプトを用意する：
  1. **簡潔サマリー**: 5行程度の文章でサマライズしたもの
  2. **詳細サマリー**: 詳細情報を残しつつも要点だけが残されたもの
  3. **メール用サマリー**: メール送信用に適した形式の要約
- テンプレートプロンプトは設定画面で編集可能
- ユーザーは4つ目以降のテンプレートプロンプトを追加できる
- テンプレートプロンプトには名前（タイトル）を設定できる
- テンプレートプロンプトは削除可能（ただし、最低1つは残す必要がある）

**UI要件**
- アクティブページの右上に要約アイコンボタンを表示
  - アイコンはObsidianのデザインシステムに準拠
  - ボタンはホバー時にツールチップを表示（「ページを要約」など）
- 要約設定モーダル:
  - モーダルタイトル: 「ページを要約」
  - テンプレートプロンプト選択セクション:
    - ラジオボタンまたはドロップダウンでテンプレートを選択
    - 選択したテンプレートの内容をプレビュー表示（オプション）
  - カスタムプロンプト入力セクション:
    - 「カスタムプロンプトを使用」チェックボックス
    - テキストエリア（複数行入力可能）
    - プレースホルダー: 「カスタムプロンプトを入力してください」
  - LLMモデル選択セクション:
    - ドロップダウンで利用可能なモデルを選択
    - デフォルトは設定で指定したモデル
  - アクションボタン:
    - 「要約を実行」ボタン（プライマリ）
    - 「キャンセル」ボタン
- ローディング表示:
  - 要約実行中はモーダル内にローディングスピナーを表示
  - 「要約を生成中...」などのメッセージを表示
- エラーハンドリング:
  - エラー発生時はエラーメッセージをモーダル内に表示
  - 「閉じる」ボタンでモーダルを閉じられる

**技術要件**
- ObsidianのEditor APIを使用してアクティブページの内容を取得
- ObsidianのWorkspace APIを使用してアクティブタブを検出
- ObsidianのFileSystem APIを使用して新しいページを作成
- モーダルはObsidianのModal APIを使用して実装
- テンプレートプロンプトは設定データとして保存（`this.saveData()`を使用）
- ファイル名の無効文字を処理（Windows/Mac/Linux対応）
- ファイル名の重複チェックと自動番号付与

## 非機能要件

### パフォーマンス
- チャット応答時間は可能な限り短くする（目標: 3秒以内）
- 大量のテキスト要約時もUIがフリーズしないようにする
- Web検索結果の取得は非同期で実行し、UIをブロックしない

### セキュリティ・プライバシー
- APIキーなどの認証情報は安全に保存する（Obsidianの設定システムを使用）
- ユーザーデータを外部に送信する場合は、明示的な同意を得る
- 送信されるデータの内容をユーザーに明示する

### ユーザビリティ
- Obsidianの既存UIデザインと調和する
- 直感的な操作ができる
- エラーメッセージは分かりやすく日本語で表示する
- 設定項目には適切なデフォルト値を設定する

### 互換性
- Obsidianの最新バージョンと互換性を保つ
- モバイル版Obsidianでも動作する（可能な限り）

## 技術要件

### AI API統合
- 使用するAIサービス（OpenAI、Claude、その他）を設定で選択できる
- APIキーの設定機能を提供する
- レート制限やエラーハンドリングを適切に実装する

### データ保存
- ObsidianのファイルシステムAPIを使用してファイルを保存する
- 保存先のパス検証を行う
- ファイル名の無効文字を処理する

### UI実装
- 各機能はObsidianのView APIを使用してサイドパネルとして実装する
- Viewはタブとして表示され、複数のViewを切り替えられる
- Viewの状態（会話履歴、検索履歴など）は適切に保持する
- モーダルは将来的な拡張として検討する（必要に応じて実装）

## 設定項目

### 必須設定
- AI APIキー
- AIサービス選択（OpenAI、Claudeなど）
- デフォルトの保存先フォルダ

### オプション設定
- チャット履歴の保持期間
- 要約のデフォルト詳細度
- Web検索結果の最大取得数
- テーマ設定（ダーク/ライト）
- 通知設定
- ページ要約機能のテンプレートプロンプト設定
  - テンプレートプロンプトの追加・編集・削除
  - テンプレートプロンプトの名前（タイトル）設定
  - テンプレートプロンプトの内容編集
  - デフォルトテンプレートプロンプトの選択
- ページ要約機能のデフォルトLLMモデル設定
- ページ要約結果の保存先フォルダ設定

## 今後の拡張機能（将来の検討事項）

- 複数のAIサービスを同時に使用する機能
- チャット履歴のエクスポート/インポート
- プラグイン間連携機能
- ページ要約機能のテンプレートプロンプトのインポート/エクスポート機能
- ページ要約機能の実行履歴の保持と参照機能

