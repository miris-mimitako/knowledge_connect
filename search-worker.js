/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

(()=>{var Ss=Object.create;var gt=Object.defineProperty;var xs=Object.getOwnPropertyDescriptor;var ws=Object.getOwnPropertyNames;var Is=Object.getPrototypeOf,Es=Object.prototype.hasOwnProperty;var vs=(t,e,n)=>e in t?gt(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var Xn=(t=>typeof require!="undefined"?require:typeof Proxy!="undefined"?new Proxy(t,{get:(e,n)=>(typeof require!="undefined"?require:e)[n]}):t)(function(t){if(typeof require!="undefined")return require.apply(this,arguments);throw new Error('Dynamic require of "'+t+'" is not supported')});var pe=(t,e)=>()=>(e||t((e={exports:{}}).exports,e),e.exports),Ee=(t,e)=>{for(var n in e)gt(t,n,{get:e[n],enumerable:!0})},Ts=(t,e,n,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of ws(e))!Es.call(t,i)&&i!==n&&gt(t,i,{get:()=>e[i],enumerable:!(r=xs(e,i))||r.enumerable});return t};var As=(t,e,n)=>(n=t!=null?Ss(Is(t)):{},Ts(e||!t||!t.__esModule?gt(n,"default",{value:t,enumerable:!0}):n,t));var C=(t,e,n)=>(vs(t,typeof e!="symbol"?e+"":e,n),n);var Ge=pe(we=>{"use strict";var Ct=0,K=3,dc=2,_e=1,xe=7,Un=0,hc=3,pc=4,gc=5,je=6,Si=7,xi=8,wi=9,lt=11,yc=13,Ii=500,zn=12,On=14,mc=15,Sc=1,Lt=typeof Symbol!="undefined"?Symbol.iterator:"__iterator_symbol__";function Ei(t){t||(t={});var e=t.converterByConstructor;e||(e=new Map),e.set(Map,{name:"Map",toValue:Ic}),e.set(Set,{name:"Set",toValue:Ec}),e.set(Date,{name:"Date",toValue:vc});var n=t.outlet||t.avoidShareUpdate,r=typeof global!="undefined"&&global.Buffer&&!(t&&t.encoding==="utf16le")?we.nodeCharEncoder(t):wc(t),i=r.writeString,s=r.writeToken,o=r.startSequence,c=r.endSequence,a=r.writeBuffer,l=t.forProperty,u,p;t.shared&&(u=t.shared.propertyUsed,p=t.shared.propertyUsed);var h=[],g=8,f,y=we.bufferSymbol||"_bufferSymbol_",d=we.targetSymbol||"_targetSymbol_",S=0,m=Sc++,v=[0,1,2,3,4,5,P,M,b,w,A];function E(I){s(_e,I)}function x(I){s(dc,I.length),i(I)}function b(I){var N,D=f.values;if(D){D.resetTo>-1&&D.serializer!==m&&(D.serializer=m,D.resetTo<D.length&&(D.length=D.resetTo),s(K,yc),s(_e,D.resetTo));var z=D.indexOf(I);if(z>-1)return E(z)}if((N=typeof I)=="string"||N==="object"&&I){if(f.writeSharedValue){if(f.writeSharedValue(I,s,m))return}else if(D){var B=D.length;B<12&&(D[B]=I)}}N==="string"?x(I):P(I)}function w(I){var N=typeof I;if(N==="number")if(I>>>0===I||I>0&&I<70368744177664&&I%1===0)s(_e,I);else{var D=I.toString();x(D)}else N==="object"?P(I):T(I)}function T(I){I===null?s(K,Un):I===!1?s(K,hc):I===!0?s(K,pc):I===void 0?s(K,gc):O(I)}function O(I){var N=typeof I,D;if(N==="object")if(I){var z=I.constructor;if(z!==Object)if(z===Array)N="array";else if(D=e.get(z),D&&D.toValue){if(I=D.toValue(I),N=typeof I,I&&N==="object"&&I.constructor===Array&&(N="array"),f.type===N)return f.extendedType!==D&&(f.extendedType=D,s(K,lt),x(D.name)),v[f.code](I)}else D=!1}else N="undefined";else N==="boolean"?N="undefined":N==="function"&&(I=I.toString(),N="string");f=U(null,N,D),v[f.code](I)}function A(){s(K,Un)}function P(I,N){var D=typeof I;if(D==="object"){if(!I)return s(K,Un)}else return D==="string"?x(I):D==="number"&&(I>>>0===I||I>0&&I<70368744177664&&I%1===0)?s(_e,I):T(I);var z=I,B=z.constructor,F;if(z[d])return j(I);if(B===Object)F=!1;else{if(B===Array)return f=U(f.key,"array"),v[f.code](I);if(z.then)return j(I);if(ne=e.get(B),ne){if(ne.toValue)return T(z)}else{if(z[Lt])return f=U(f.key,"array"),L(z,N);e.set(B,ne={name:B.name})}f.constructs!==B&&(s(K,lt),x(ne.name),f.constructs=B),F=!0}var R=f;R.resetTo<R.length&&R.serializer!=m&&(R.length=R.resetTo,R.serializer=m),o();var k=0,te=-2,G=0;for(var le in z)if(!(F&&!z.hasOwnProperty(le))){var I=z[le];D=typeof I,f=R[G];var B,ne=!1;if(D==="object"&&(I?(B=I.constructor,B===Object||(B===Array?D="array":(ne=e.get(B),ne&&ne.toValue?(I=ne.toValue(I),D=typeof I,I&&D==="object"&&I.constructor===Array&&(D="array")):I[Lt]&&!I.then?D="array":ne=!1))):D="undefined"),!f||f.key!==le||f.type!==D&&D!=="boolean"&&D!=="undefined"&&!(D==="string"&&f.type!=="number")||ne&&f.extendedType!==B){var Ie=G;te>-2&&(G=te);do f=R[++G];while(f&&(f.key!==le||f.type!==D&&D!=="boolean"&&D!=="undefined"&&!(D==="string"&&f.type!=="number")||ne&&f.extendedType!==B));if(f)s(Ct,G),te===-2&&(te=Ie-1);else if(R.getProperty)f=R.getProperty(I,le,D,ne,U,s,Ie),G=f.index,Ie!==G&&te===-2&&(te=Ie-1);else{if(Ie===R.length?G=Ie:(s(Ct,G=R.length),te===-2&&(te=Ie-1)),G<R.resetTo){debugger;throw new Error("overwriting frozen property")}f=R[G]=U(le,D,ne)}}u&&u(f,z,m,k);var Ht=f.code;Ht>7?Ht===8?b(I):w(I):Ht===6?P(I):M(I),G++,k++}f=R,c(k)}function U(I,N,D){var z;return z=[],z.key=I,z.type=N,N==="string"?(s(K,xi),z.values=[],z.code=xi):N==="number"?(s(K,wi),z.code=wi):N==="object"?(s(K,je),z.code=je):N==="array"?(s(K,Si),z.code=Si):N==="boolean"||N==="undefined"?(z.type="object",s(K,je),z.code=je):(s(K,je),z.code=10,console.error("Unable to write value of type "+N)),typeof I=="string"?x(I):I===null&&(N==="object"||N==="array")||P(I),D&&(z.extendedType=D,s(K,lt),x(D.name)),z}function L(I,N,D){try{D||(s(xe,zn),D=I[Lt]());var z=f;f=z.child||(z.child=z);for(var B;!(B=D.next()).done;)if(v[f.code](B.value,z),N&&r.hasWritten){r.hasWritten=!1,f=z,h.unshift({then:function(F){return L(null,!0,D),F()}});return}}catch(F){throw s(K,lt),s(_e,Ii),P(Object.assign(new(typeof F=="object"&&F?F.constructor:Error),{name:F&&F.name,message:F&&F.message||F})),F}f!==z.child&&(z.child=f),f=z,s(xe,On)}function M(I){if(!I)T(I);else{if(I[d])return j(I);if(I.constructor===Array){var N=I.length,D;N>11?(s(xe,zn),D=!0):s(xe,N);var z=f;f=z[0],z.resetTo<z.length&&z.serializer!=m&&(z.length=z.resetTo,z.serializer=m);for(var B=0,F=0;F<N;F++){var R=I[F],k=typeof R;if(k==="object")if(R){var te=R.constructor;if(te!==Object)if(te===Array)k="array";else{var G=e.get(te);G&&G.toValue?(R=G.toValue(R),k=typeof R,R&&k==="object"&&R.constructor===Array&&(k="array")):G=!1}}else k="undefined";if(!f)z.getProperty?f=z.getProperty(R,null,k,G,U,s,0):(k==="string"||k==="number"||k==="array"?f=U(null,k,G):(f=[],f.type=k,f.key=null,f.code=je),z[0]=f);else if(f.type!==k&&k!=="boolean"&&k!=="undefined"&&!(k==="string"&&f.type!=="number")||G&&f.extendedType!==te){B=-1;do f=z[++B];while(f&&(f.type!==k&&k!=="boolean"&&k!=="undefined"&&!(k==="string"&&f.type!=="number")||G&&f.extendedType!==te));f?s(Ct,B):z.getProperty?f=z.getProperty(R,null,k,G,U,s,-1):(s(Ct,B),f=U(null,k,G),z[B]=f)}u&&u(f,I,m,F);var le=f.code;le>7?le===8?b(R):w(R):le===6?P(R):M(R)}D&&s(xe,On),f=z}else{if(typeof I=="object"&&I[Lt])return L(I);if(k==="string")return x(R);if(k==="number"&&(R>>>0===R||R>0&&R<70368744177664&&R%1===0))return s(_e,R);T(I)}}}var W;function j(I,N){s(xe,mc);var D=f,z=I[d]?{then:B}:{then:function(F){return I.then(function(R){I=R,B(F)},function(R){I=Object.assign(new(typeof R=="object"&&R?R.constructor:Error),{name:R&&R.name,message:R&&R.message||R}),D.upgrade||(s(K,lt),s(_e,Ii)),B(F)})}};function B(F){if(t.forBlock&&I)t.forBlock(I,D);else{var R=I&&I[y]&&I[y](D);if(R)a(R);else{f=D;var k=h;h=[],P(I,!0),k.unshift.apply(k,h),h=k}}F()}h.push(z)}var ee={serialize:function(I,N){var D=I&&I[y]&&I[y](N);if(D){r.writeBuffer(D);return}N?(f=N,v[f.code](I)):(f=[],f.key=null,P(I,!0))},getSerialized:function(){if(h.length>0){for(var I=[];h.length>0;){var N=!1,D=h.shift().then(function(){N=!0});N||I.push(D)}if(I.length>0)return Promise.all(I).then(function(){return ee.getSerialized()})}return t&&t.encoding==="utf16le"?Buffer.from(r.getSerialized(),"utf16le"):r.getSerialized()},flush:r.flush,setOffset:r.setOffset,finish:r.finish,pendingEncodings:h,getWriters:function(){return{writeProperty:U,writeToken:s,writeAsDefault:P,writeBuffer:a}}};return ee}function xc(t,e){var n=Ei(e),r=e&&e.shared,i;r&&r.startWrite&&r.startWrite(e.avoidShareUpdate,t),n.serialize(t,r),i=n.getSerialized(),r&&r.endWrite&&r.endWrite(e.avoidShareUpdate,t),n.finish&&n.finish();var s=t&&t[we.sizeTableSymbol];return s&&(i.sizeTable=s),e&&e.lazy?Buffer.concat([t[we.sizeTableSymbol],i]):i}we.serialize=xc;we.createSerializer=Ei;function wc(){var t="";function e(i,s){var o;if(s<16)o=String.fromCharCode((i<<4|s)^64);else if(s<1024)o=String.fromCharCode((i<<4)+(s>>>6),(s&63)+64);else if(s<65536)o=String.fromCharCode((i<<4)+(s>>>12),s>>>6&63,(s&63)+64);else if(s<4194304)o=String.fromCharCode((i<<4)+(s>>>18),s>>>12&63,s>>>6&63,(s&63)+64);else if(s<268435456)o=String.fromCharCode((i<<4)+(s>>>24),s>>>18&63,s>>>12&63,s>>>6&63,(s&63)+64);else if(s<4294967296)o=String.fromCharCode((i<<4)+(s>>>30),s>>>24&63,s>>>18&63,s>>>12&63,s>>>6&63,(s&63)+64);else if(s<17179869184)o=String.fromCharCode((i<<4)+(s/1073741824>>>0),s>>>24&63,s>>>18&63,s>>>12&63,s>>>6&63,(s&63)+64);else if(s<1099511627776)o=String.fromCharCode((i<<4)+(s/68719476736>>>0),s/1073741824&63,s>>>24&63,s>>>18&63,s>>>12&63,s>>>6&63,(s&63)+64);else if(s<70368744177664)o=String.fromCharCode((i<<4)+(s/4398046511104>>>0),s/68719476736&63,s/1073741824&63,s>>>24&63,s>>>18&63,s>>>12&63,s>>>6&63,(s&63)+64);else throw new Error("Too big of number");t+=o}function n(i){t+=i}function r(){return t}return{writeToken:e,writeString:n,getSerialized:r,startSequence:function(){e(xe,zn)},endSequence:function(){e(xe,On)},getOffset:function(){return-1}}}var vi=Array.from||function(t,r){var n=[],r=t.constructor===Map;return t.forEach(function(i,s){r?n.push([s,i]):n.push(i)}),n};function Ic(t){for(var e=vi(t),n=0,r=e.length;n<r;n++){var i=e[n];e[n]={key:i[0],value:i[1]}}return e}function Ec(t){return vi(t)}function vc(t){return t.getTime()}});var Di=pe(Ai=>{"use strict";var{Transform:Tc}=Xn("stream"),{createSerializer:Ti}=Ge(),_n=class extends Tc{constructor(e){e=e||{},super(e),this.options=e,this.continueWriting=!0}write(e){let n=this.serializer||(this.serializer=Ti({asBlock:!0}));n.serialize(e);let r=n.getSerialized();r.then?(r.then(i=>this.push(i)),this.serializer=null):n.flush(this)}end(e){e&&(this.options.outlet=this,(this.serializer||(this.serializer=Ti(this.options))).serialize(e)),this.serializer.pendingEncodings.length>0?(this.endWhenDone=!0,this.writeNext()):(this.serializer.flush(),this.push(null))}writeBytes(e){try{this.continueWriting=this.push(e)}catch(n){throw n}}_read(){this.continueWriting=!0,!this.pausedForPromise&&this.serializer&&this.endWhenDone&&this.serializer.pendingEncodings.length>0&&this.writeNext()}writeNext(){var e;do{var n=this.serializer.pendingEncodings.length>0;if(e=null,n){if(this.serializer.pendingEncodings.shift().then(()=>{e===!1?(this.pausedForPromise=!1,this.continueWriting||this.serializer.pendingEncodings.length===0?this.writeNext():this.serializer.flush()):e=!0},r=>{console.error(r),this.push(r.toString()),this.push(null)}),!e)e=!1,this.pausedForPromise=!0,this.serializer.flush();else if(!this.continueWriting&&this.serializer.pendingEncodings.length>0){this.serializer.flush();return}}else this.endWhenDone&&(this.serializer.flush(),this.push("]"),this.push(null))}while(e)}};Ai.createSerializeStream=()=>new _n});var ft=pe(Nn=>{"use strict";var Ac=3,Dc=4,bi=6,Ui=7,zi=8,Oi=9,_i=11,bc=13,Uc=14,zc=500,Oc=12,_c=14,Nc=15,Hd=1024*1024*16;function Ni(t){t||(t={});var e,n,r,i=t.classByName||new Map;i.set("Map",Rc),i.set("Set",Pc),i.set("Date",Mc);var s,o;function c(y,d){if(y.previous=s,y.resume=!0,s=y,!r)throw new Error("Unexpected end of dpack stream");return f.onResume||(f.onResume=function(S,m,v){var E=s;return s=null,f.onResume=null,d<n.length?n=n.slice(d)+S:v?n=S.slice(0,1)+S.slice(1):n=S,r=m,h+=d,e=0,E.reader?E.reader(E):a(E.length,E)}),y.object}function a(y,d){var S=0;d=d||[];var m,v,E,x,b=0,w=0;if(d.resume){if(m=d.previous,m){var x=m.reader?m.reader(m):a(m.length,m),T=m.values;T&&(s?s.values=T:x.nextPosition>-1?T[T.nextPosition++]=x:T.push(x))}d.code&&d.code!==d.thisProperty.code?d.resume=!1:(b=d.i||0,E=d.object,S=d.propertyState||0,w=d.propertyIndex||0,d=d.thisProperty)}for(v=d.code===Ui,E=E||(d.constructs?new d.constructs:v?[]:{});b<y;){var O,A,P=e,U=n.charCodeAt(e++);if(U>=48)U>12288?(O=U>>>12^4,A=U&4095):(O=U>>>4^4,A=U&15);else if(O=U>>>4&11,A=U&15,U=n.charCodeAt(e++),A=(A<<6)+(U&63),!(U>=64)&&(U=n.charCodeAt(e++),A=(A<<6)+(U&63),!(U>=64)&&(U=n.charCodeAt(e++),A=(A<<6)+(U&63),!(U>=64)&&(U=n.charCodeAt(e++),A=(A<<6)+(U&63),!(U>=64)&&(U=n.charCodeAt(e++),A=A*64+(U&63),!(U>=64)&&(U=n.charCodeAt(e++),A=A*64+(U&63),!(U>=64)&&(U=n.charCodeAt(e++),A=A*64+(U&63),!(U>=0)&&e>n.length)))))))return c({length:y,thisProperty:d,i:b,object:E,propertyIndex:w,propertyState:S},P);if(O===0){w=A,S=0;continue}if(m=d[w],O===3)if(A<6)A<3?A===0?x=null:x="Unknown token, type: "+O+" number: "+A:A===Dc?x=!0:A===Ac?x=!1:x=void 0;else{if(A<=Oi){if(S===1&&(w++,b++,m=d[w]),w<d.resetTo)throw new Error("Overwriting frozen property");m?m.resume||(x=m.key,m=d[w]=[],m.key=x):(m=d[w]=[],m.key=null),m.code=A,m.parent=d,S=2,A===zi?m.values=[]:A===Ui&&(m[0]=[],m[0].key=null,m[0].code=bi,m[0].parent=m)}else S=A;continue}else if(O===2){if(x=n.slice(e,e+=A),e>n.length)return c({length:y,thisProperty:d,i:b,object:E,propertyIndex:w,propertyState:S},P);S<2&&m.code===Oi&&(x=+x)}else if(O===1)x=A;else if(A>13){if(A===_c)return E;A===Nc&&(x=a(0,m),S=0,t.forDeferred?x=t.forDeferred(x,m):(o||(o=[])).push({property:m,value:x}))}else if(A>=Oc&&(A=2e9),S>1?S===2?(S=0,x=a(A,m)):S===_i?x=a(A,[{key:null,code:6}]):m.resume&&(m.code||bi)===m.thisProperty.code?x=a(A,m.thisProperty):x=a(A,m):x=a(A,m),s){if(x===void 0)return s=null,f.onResume=null,c({length:y,thisProperty:d,i:b,object:E,property:m,propertyIndex:w,previousProperty,propertyState:S},P);s.values=m.values instanceof Array?m.values:void 0}if(!m)throw new Error("No property defined for slot"+(d.key?" in "+d.key:""));if(S<2&&m&&m.code===zi){var T=m.values;if(typeof x=="number"){if(x=T[A],x===void 0&&!(A in T))throw new Error("Referencing value that has not been read yet")}else(O===2||O===7)&&T&&(T.nextPosition>-1?(m.recordValueReference&&m.recordValueReference(T),T[T.nextPosition++]=x):T.push(x))}if(S>1){if(S===2)m.key=x;else if(S===_i)if(typeof x=="string"){var L=i.get(x);if(L)L.fromValue?m.fromValue=L.fromValue:m.constructs=L;else if(t.errorOnUnknownClass)throw new Error("Attempt to deserialize to unknown class "+parameter);m.extendedType=L}else m.metadata=x,x===zc&&(m.fromValue=p);else if(S===bc){var T=m.values||(m.values=[]);T.nextPosition=x}else if(S!==Uc)throw new Error("Unknown property type "+S);S=1;continue}else S=0;m.fromValue&&(x=m.fromValue(x)),v&&m.key===null?E.push(x):x!==void 0&&(E[m.key]=x),b++,v||w++}return E}function l(y){throw new Error("Unknown type "+y)}var u;function p(y){var d=typeof global!="undefined"?global:window;if(y&&y.name&&d[y.name]?y=new d[y.name](y.message):typeof y=="string"&&(y=new Error(y)),t.onError)t.onError(y);else throw u=!0,y}var h=0;function g(y){try{if(y&&y.resume){var d=y.previous;S=a(d.length,d),S=y.object||S,y=y.property}else{y=y||[t&&t.shared||{key:null,code:6}];var S=a(1,y)[y[0].key]}for(;;){if(s)return c({reader:g,object:S,property:y});if(!o)return S;var m=o.index||0,v=o[m];if(o.index=m+1,!v){o=o.parent;continue}var E=v.value,x=o;o=[],o.parent=x;var b=v.property,w=a(1,y=[{resume:!0,key:null,thisProperty:b,object:E}]);w=w.null||w[b.key],w!=E&&(Object.assign(E,w),s&&s.object===w&&(s.object=E),w&&w.constructor===Array&&(E.length=w.length,Object.setPrototypeOf(E,Object.getPrototypeOf(w))))}}catch(T){throw u||(T.message="DPack parsing error: "+T.message+" at position: "+(e+h)+" near: "+n.slice(e-10,e+10)),T}}var f={setSource:function(y,d,S){return n=y,e=d||0,h=0,r=S,this},hasMoreData:function(){return n.length>e},isPaused:function(){return s},hasUnfulfilledReferences:function(){return o&&o.length>o.index},getOffset:function(){return e+h},read:g};return f}Nn.parse=function(t,e){var n;if(typeof t=="string")n=t;else if(t&&t.toString)n=t.toString(e&&e.encoding||"utf8");else return t;var r=Ni(e).setSource(n);return e&&e.shared?r.read([e.shared]):r.read()};Nn.createParser=Ni;var Rc={fromValue:function(t){for(var e=new Map,n=0,r=t.length;n<r;n++){var i=t[n];e.set(i.key,i.value)}return e}},Pc={fromValue:function(t){var e=new Set(t);if(e.size===0&&t.length>0)for(var n=0,r=t.length;n<r;n++)e.add(t[n]);return e}},Mc={fromValue:function(t){return new Date(t)}}});var Pi=pe(Ri=>{"use strict";var Bc=Xn("stream").Transform,kc=ft().createParser,Cc={objectMode:!0},Rn=class extends Bc{constructor(e){e?e.objectMode=!0:e=Cc,super(e),this.parser=kc(e),this.waitingValues=[]}_transform(e,n,r){var i;try{var s=e.toString(),o=this.parser;for(o.onResume?(i=o.onResume(s,!0),o.isPaused()||this.sendValue(i)):o.setSource(s,0,!0);o.hasMoreData()&&(i=o.read(),!o.isPaused());)this.sendValue(i)}catch(c){console.error(c)}r&&r()}sendValue(e){if(this.parser.hasUnfulfilledReferences())e!==void 0&&this.waitingValues.push(e);else{for(;this.waitingValues.length>0;)this.push(this.waitingValues.shift());e!==void 0&&this.push(e)}}};Ri.createParseStream=()=>new Rn});var Ci=pe(ki=>{var Mi=32768,Bi=[];function Lc(t){var e=t.startOffset||0,n,r=t.outlet,i=Bi.pop();i&&i.length>e+128?n=i.length:(n=(e>>12<<12)+8192,i=Buffer.allocUnsafeSlow(n));var s=t.encoding,o=[];function c(y){if(r)r.writeBytes(i.slice(0,e)),(n<Mi||y>Mi)&&(n=Math.max(n*4,y)),i=Buffer.allocUnsafeSlow(n),e=0,o=[],f.hasWritten=!0;else{n=Math.max(n*4,n+y,8192);var d=i;i=Buffer.allocUnsafeSlow(n),d.copy(i,0,0,e)}}function a(y){(y||r).writeBytes(i.slice(0,e)),e+128>i.length?i=Buffer.allocUnsafeSlow(n=Math.min(Math.max((e>>10<<10)+8192,n),32768)):(i=i.slice(e),n=i.length),e=0,o=[]}function l(y,d){if(d<16)i[e++]=(y<<4)+d^64;else if(d<1024)i[e++]=(y<<4)+(d>>>6),i[e++]=(d&63)+64;else if(d<65536)i[e++]=(y<<4)+(d>>>12),i[e++]=d>>>6&63,i[e++]=(d&63)+64;else if(d<4194304)i[e++]=(y<<4)+(d>>>18),i[e++]=d>>>12&63,i[e++]=d>>>6&63,i[e++]=(d&63)+64;else if(d<268435456)i[e++]=(y<<4)+(d>>>24),i[e++]=d>>>18&63,i[e++]=d>>>12&63,i[e++]=d>>>6&63,i[e++]=(d&63)+64;else if(d<4294967296)i[e++]=(y<<4)+(d>>>30),i[e++]=d>>>24&63,i[e++]=d>>>18&63,i[e++]=d>>>12&63,i[e++]=d>>>6&63,i[e++]=(d&63)+64;else if(d<17179869184)i[e++]=(y<<4)+(d/1073741824>>>0),i[e++]=d>>>24&63,i[e++]=d>>>18&63,i[e++]=d>>>12&63,i[e++]=d>>>6&63,i[e++]=(d&63)+64;else if(d<1099511627776)i[e++]=(y<<4)+(d/68719476736>>>0),i[e++]=d/1073741824&63,i[e++]=d>>>24&63,i[e++]=d>>>18&63,i[e++]=d>>>12&63,i[e++]=d>>>6&63,i[e++]=(d&63)+64;else if(d<70368744177664)i[e++]=(y<<4)+(d/4398046511104>>>0),i[e++]=d/68719476736&63,i[e++]=d/1073741824&63,i[e++]=d>>>24&63,i[e++]=d>>>18&63,i[e++]=d>>>12&63,i[e++]=d>>>6&63,i[e++]=(d&63)+64;else throw new Error("Invalid number "+d);e>n-10&&c(0)}function u(y){var d=y.length;d+e+10>n&&c(d+10),y.copy(i,e),e+=d}function p(y){var d=y.length,S=d*3+10;e+S>n&&c(S+10);var m=s?i.write(y,e,i.length,s):i.utf8Write(y,e,i.length);e+=m}function h(){return i.slice(0,e)}function g(y,d){var S=y.length;e+S+10>n&&c(S+10),i.copy(i,S+d,d,e),y.copy(i,d),e+=S}var f={writeToken:l,writeString:p,writeBuffer:u,getSerialized:h,insertBuffer:g,flush:a,startSequence(){var y=e;i[e++]=60,o.push(y),e>n-10&&c(0)},endSequence(y){var d=o.pop();if(y<12&&d>-1){i[d]=48+y;return}i[e++]=62},finish(){i.length-e>144&&Bi.push(i.slice(e))},getOffset(){return e},setOffset(y){e=y}};return f}ki.nodeCharEncoder=Lc});var Pn=pe(Fi=>{"use strict";function Li(){var t=this.classByName=new Map;this.converterByConstructor=new Map}Li.prototype.addExtension=function(t,e,n){e&&t.name!==e&&(t.name=e),this.classByName.set(t.name,n&&n.fromArray?n:t),this.converterByConstructor.set(t,n&&n.toArray?n:t)};Fi.Options=Li});var Wt=pe(Ln=>{var Fc=Ge().createSerializer,Zd=Ge().serialize,Wi=ft().createParser,Qd=Pn().Options,Vt=0,Vc=3,Mn=7,He=6,Ne=7,$i=8,Wc=9,$c=14,Yc=11,jc=12,Gc=14;Ln.createSharedStructure=qc;Ln.readSharedStructure=Hc;function Hc(t){var e=Wi(),n=[];return n.code=6,n.key=null,e.setSource(t+"p").read([n]),Yi(n),n.serialized=t,n}function Yi(t){t.resetTo=t.length,t.upgrade=ji,t.type=kn[t.code],t.isFrozen=!0,Object.defineProperty(t,"serialized",{get(){return this._serialized||(this._serialized=Bn(this))}}),typeof t.values=="object"&&t.values&&(t.values.resetTo=t.values.length,t.lastIndex=t.values.length);for(var e=0,n=t.length;e<n;e++)t[e].index=e,t[e].resumeIndex=e,Yi(t[e])}function ji(t){if(!t)return 1;var e;if(t){if(t.insertedFrom===this&&t.insertedVersion===this.version&&(t.recordUpdate||t.isFrozen||t.length==0&&t.code==this.code&&t.values==null))return 0;var n;if(this.code!==t.code&&(n=!0),t.upgrade){var e=Cn(this,t);if(n&&(e=2),t.isFrozen&&e>0)return 2;if(t.insertedFrom=this,t.insertedVersion=this.version,e===2){debugger;return console.error("Inserting incompatible block into property"),2}else return 0}else return t.insertedFrom=this,t.insertedVersion=this.version,t.length=0,t.values=null,t.fromValue&&(t.fromValue=null),1}else this.length>0&&(blockBuffer=Buffer.concat([this.serialized,blockBuffer]));return 1}var Kc={string:$i,number:Wc,object:He,boolean:He,undefined:He,array:Ne},Vi=new WeakMap;function qc(t,e){var n=[];n.key=null,n.code=6,n.type="object";let r=[],i=[];r.iteration=0;var s;class o extends Array{constructor(p){super();let h;this.key=typeof p.key=="string"?Jc(p.key):p.key,this.type=p.type,this.code=p.code,this.count=0,this.comesAfter=[],this.code==$i&&(this.values=[],this.values.resetTo=512,this.values.nextPosition=512,this.previousValues=new Map,this.lastIndex=0,this.repetitions=0)}newProperty(p){return new o(p)}getProperty(p,h,g,f,y,d,S){let m;if(this.insertedFrom){if(E(this.insertedFrom),m)return S!==m.index&&d(Vt,v),m;if(this.insertedFrom.getProperty)return this.insertedFrom.getProperty(p,h,g,f,y,d,S);debugger}this.recordUpdate();let v=this.length;return S!==v&&d(Vt,v),(g==="boolean"||g==="undefined")&&(g="object"),m=this[v]=new o({key:h,type:g,code:Kc[g]}),m.parent=this,m.index=v,m;function E(x){let b=-1;do m=x[++b];while(m&&(m.key!==h||m.type!==g&&g!=="boolean"&&g!=="undefined"||f&&m.extendedType!==constructor))}}writeSharedValue(p,h,g){let f=this.previousValues.get(p);return f?f.serializer==g?this.repetitions++:(f.serializations++,f.serializer=g):this.previousValues.set(p,f={serializations:1,serializer:g}),this.active||(this.active=2,r.push(this)),!1}propertyUsed(p,h,g,f){if(p.lastSerializer!==g&&(p.lastSerializer=g,p.count++),f!==0){let y=Vi.get(h);y&&p.comesAfter.indexOf(y)===-1&&p.comesAfter.push(y)}Vi.set(h,p)}recordUpdate(){var p=this;do p.version=(p.version||0)+1,p.insertedFrom&&(p.insertedFrom=null),p._serialized&&(p._serialized=null);while(p=p.parent)}readingBlock(p){try{return p()}finally{if(this.readReset(),this.length>500)debugger}}startWrite(p,h){if(r.iteration++,h&&h.constructor===Array){if(this.code!==Ne&&this.version>0)throw new Error("Can not change the root type of a shared object to an array");this.code!=Ne&&this.recordUpdate(),this.code=Ne,this.type="array"}this.writing||(this.writing=!0)}endWrite(){if(this.writing)this.writing=!1;else return;let p=this.iterations=(this.iterations||0)+1;for(let h=0;h<r.length;h++){let g=r[h],f=g.previousValues;if(f&&f.size&&!g.isFrozen){if(!Ft){g.values.length==0&&p>((g.repetitions||0)+10)*5&&(console.log("changing referenceable to default",g.key),g.previousValues=null,g.code=He,g.type="object",g.recordUpdate(),r.splice(h--,1),f=[]);for(let[y,d]of f){let S=g.values;((d.serializations+3)*8<p-(d.startingIteration||(d.startingIteration=p))||S.length>500)&&f.delete(y),d.serializations>50&&d.serializations*3>p&&(S[g.lastIndex++]=y,g.recordUpdate(),console.log("adding value",y,"to",g.key),f.delete(y))}}}else g.active=0,r.splice(h--,1)}r.hasUpdates&&(r.hasUpdates=!1,this.version++,this._serialized||(this._serialized=null),e&&e.onUpdate&&e.onUpdate()),Ft=s}upgrade(p){return ji.call(this,p)}get serialized(){return this._serialized||(this._serialized=Bn(this))}serializeCommonStructure(p){var h=Math.sqrt(r.iteration);return Bn(this,g=>g.count>=h,p)}}var c=new o(n);if(c.version=0,c.freeze=function(){this.isFrozen=!0,this.reset()},t){var a=Wi({forDeferred(u,p){return p.isBlock=!0,u},parseDeferreds:!0}),l=[];l.code=6,l.key=null,a.setSource(t+"p").read([l]),Cn(l,c),r.hasUpdates=!1,c.version=1}return c.key=null,c}var kn={6:"object",7:"array",8:"string",9:"number"},Ft;function Bn(t,e,n){var r=Fc(),i=r.getWriters();s(t,!n,!n);function s(c,a,l){if(c.insertedFrom&&c.insertedFrom.serializeCommonStructure)return c=c.insertedFrom,i.writeBuffer(c.serializeCommonStructure(!l));var u=c.code===Ne,p=e?Xc(c.filter(e)):c,h=p.length;if(!(a&&c.code===He)){let m=l?null:c.key;i.writeProperty(m,kn[c.code]),h===0&&m===null&&(c.code===He||c.code===Ne)&&i.writeToken(Mn,0)}if(l&&h>0&&i.writeToken(Vc,$c),h>0){i.writeToken(Mn,jc);for(var g=0;g<h;g++){var f=p[g];f.index=g,u&&g>0&&i.writeToken(Vt,g),s(f,p.code===Ne&&g===0,!1,e)}i.writeToken(Mn,Gc)}var y=!0;if(c.lastIndex>0)for(var g=0,d=c.lastIndex;g<d;g++){var S=c.values[g];y?y=!1:i.writeToken(Vt,c.index),i.writeAsDefault(S)}}return r.getSerialized()}function Cn(t,e,n,r){var i=0;e.code=t.code,e.type=t.type||kn[t.code],n&&(e.isFrozen=!0,e.previousValues&&(e.previousValues=null));let s=t.resetTo>-1?t.resetTo:t.length;e.resetTo>-1&&e.resetTo<e.length&&(e.length=e.resetTo);for(var o=r||0;o<s;o++){var c=e[o],a=t[o];if(c&&(c.key!=a.key||c.extendedType!=a.extendedType||c.code!=a.code&&!(c.code==8&&a.code===6&&(!c.values||!c.values.length)))){if(e.isFrozen)return 2;i=2}if(!c){if(e.isFrozen)return 2;var c=[];c.code=a.code,e.newProperty&&(c=e.newProperty(c)),e[o]=c,a.metadata&&(c.metadata=a.metadata),a.insertedFrom&&(c.insertedFrom=a.insertedFrom,c.insertedVersion=a.insertedVersion),c.parent=e}c.key=a.key,a.values&&a.values.length>0&&(a.values.resetTo>-1&&(a.values.length=a.values.resetTo),(!c.values||a.values.length>(c.values.resetTo>-1?c.values.resetTo:c.values.length))&&(c.values=a.values.slice(0),c.values.nextPosition=a.values.length,c.values.length>=12&&(c.previousValues=null),i==0&&(i=1)));var l=Cn(a,c,n);l>i&&(i=l)}if((e.resetTo>-1?e.resetTo:e.length)>s){if(e.recordUpdate)t.metadata=Yc,t.recordUpdate();else if(e.isFrozen)return 2}return i}function Jc(t){return t.slice(0,1)+t.slice(1)}function Xc(t){var e=[],n=new Set;function r(i){if(!n.has(i)){n.add(i);for(var s of i.comesAfter)r(s);e.push(i)}}for(let i of t)r(i);return e}});var Zi=pe(ie=>{"use strict";var Ke=typeof Symbol!="undefined"?Symbol:function(t){return"symbol-"+t},Zc=1,Yn=Ke("buffer"),ut=Ke("sizeTable"),th=Ke("header"),qe=Ke("parsed"),jn=Ke("shared"),he=Ke("target"),Fn=!1,Hi=6,Ki=7;function Qc(){}var dt=Ge();ie.Block=Qc;ie.bufferSymbol=dt.bufferSymbol=Yn;ie.parsedSymbol=qe;ie.sharedSymbol=jn;ie.targetSymbol=dt.targetSymbol=he;ie.sizeTableSymbol=dt.sizeTableSymbol=ut;var ea=dt.serialize,ta=dt.createSerializer;ie.asBlock=na;function na(t,e){if(t&&t[he])return t;if(Array.isArray(t)){let n=[];return n.parsed=t,n.shared=e,new Proxy(n,$t)}return new Proxy({parsed:t,shared:e},$t)}ie.isBlock=Gn;function Gn(t){return t&&t[he]}ie.makeBlockFromBuffer=qi;function qi(t,e){var n,r;if(t[0]<128)n=t;else{var i=t[0]>>6,s;i===2?s=t.readUInt16BE(0)&16383:s=t.readUInt32BE(0)&1073741823,n=t.slice(s),r=t.slice(0,s)}var o={dpackBuffer:n,sizeTableBuffer:r,shared:e,reassign:function(c){this.buffer=c}};return t.owner=o,new Proxy(o,$t)}ie.getLazyHeader=function(t){return t[ut]};var $t={get:function(t,e){if(J.hasOwnProperty(e))return J[e].call(t);var n=t.parsed;return n||(n=re(t)),n[e]},set:function(t,e,n){if(typeof e=="symbol")return t[e]=n,sa(e),!0;throw new Error("No changes are allowed on frozen parsed object, Use dpack copy() function to modify")},deleteProperty:function(){throw new Error("No changes are allowed on frozen parsed object, Use dpack copy() function to modify")},getOwnPropertyDescriptor:function(t,e){var n=re(t);return Object.getOwnPropertyDescriptor(n,e)},has:function(t,e){var n=re(t);return e in n},ownKeys:function(t){var e=re(t),n=Object.keys(e);return Array.isArray(e)&&n.push("length"),n},getPrototypeOf:function(t){var e=re(t);return Object.getPrototypeOf(e)}};ie.reassignBuffers=Ji;function Ji(t,e,n){var r=t[he],s=r.dpackBuffer;if(n||(n=s.buffer),s&&s.buffer===n){var i=s.byteOffset;r.dpackBuffer=e.slice(i,i+s.length)}var s=r.sizeTableBuffer;if(s&&s.buffer===n){var i=s.byteOffset;r.sizeTableBuffer=e.slice(i,i+s.length)}if(r.parsed){var o=r.parsed;for(var c in o){var a=o[c];Gn(a)&&Ji(a,e,n)}}}var Yt={get:function(t,e){if(J.hasOwnProperty(e))return J[e].call(t);var n=t.cachedParsed;if(n&&n.hasOwnProperty(e)&&!(e=="length"&&Array.isArray(n)))return n[e];var r=t.parsed;r||(r=re(t));var i=r[e];return i&&i[he]&&(n||(t.cachedParsed=n=r instanceof Array?[]:{}),n[e]=i=Vn(i,t)),i},changed:function(t){t.dpackBuffer=null,t.sizeTableBuffer=null,t.shared=null;var e=t.parsed;if(e||(e=re(t)),!t.copied){var n=t.cachedParsed,r=t.parsed=t.cachedParsed=e instanceof Array?[]:{};for(var i in e){var s=n&&n[i];s||(s=e[i],s&&s[he]&&(s=Vn(s,t))),r[i]=s}e=r,t.copied=!0}return t.version=Zc++,e},checkVersion:function(t){var e=t.cachedParsed;let n=t.version||0;if(e)for(let i in e){var r=e[i];r&&r[he]&&(n=Math.max(n,this.checkVersion(r[he])))}return n!=(t.version||0)&&(this.changed(t),t.version=n),n},set:function(t,e,n,r){if(Gi.hasOwnProperty(e))return Gi[e].call(t,n),!0;var i=Yt.changed(t);return i[e]=n,!0},deleteProperty:function(t,e){var n=Yt.changed(t);return delete n[e]},getOwnPropertyDescriptor:function(t,e){var n=re(t);return Object.getOwnPropertyDescriptor(n,e)},has:function(t,e){var n=re(t);return e in n},ownKeys:function(t){var e=re(t),n=Object.keys(e);if(Array.isArray(e)&&n.push("length"),t.copied)for(var r in t.copied)n.indexOf(r)===-1&&n.push(r);return n},getPrototypeOf:function(t){var e=re(t);return Object.getPrototypeOf(e)}},J={};J[Yn]=function(){return function(t,e){var n=t&&t.upgrade,r;if(this.cachedParsed&&this.dpackBuffer&&Yt.checkVersion(this),!(this.shared&&this.shared.upgrade)&&n)return this.dpackBuffer?(this.sizeTableBuffer=null,o(this.dpackBuffer,!0)):Wn(this,this.shared=t);if(this.dpackBuffer||Wn(this,this.shared),this.shared&&this.shared.upgrade&&this.shared!==t){var i=this.shared.upgrade(t,e);if(i>0){this.sizeTableBuffer=null;var s=this.shared.serialized;if(s.length>0)return i==2&&!(t.isFrozen&&t.resetTo===0)&&(s=o(s)),r=Buffer.concat([s,this.dpackBuffer]),r.mustSequence=!0,r}}else t&&(n||(t.length=0),t.insertedFrom&&(t.insertedFrom=null));return this.dpackBuffer;function o(c){var a=ta(),l=c[0]===119,u=a.getWriters().writeToken;return l&&(c=c.slice(1)),u(0,1e3),u(3,l?Ki:Hi),t&&t.key!==null&&a.serialize(t.key),c=Buffer.concat([a.getSerialized(),c]),c.mustSequence=!0,c}}.bind(this)};J[he]=function(){return this};J[jn]=function(){return this.shared};J[qe]=function(){return this.parsed||re(this)};J[ut]=function(){return this.dpackBuffer||Wn(this),this.sizeTableBuffer};J.then=function(){};J.toJSON=function(){return Xi};J.valueOf=function(){return Xi};J.entries=function(){return ra};function ra(){return this[qe].entries()}J[Symbol.iterator]=function(){var t=this.parsed||re(this);return t&&t[Symbol.iterator]&&ia};function ia(){var t=this[qe];return t&&t[Symbol.iterator]?t[Symbol.iterator]():[][Symbol.iterator]()}J.constructor=function(){if(this.parsed)return this.parsed.constructor;if(this.dpackBuffer){let t=this.dpackBuffer[0];if(t>=48&&t<=60)if(this.shared){if(this.shared.code==Hi)return Object;if(this.shared.code==Ki)return Array}else return Object;else if(t===119)return Array}return re(this).constructor};function sa(t){J[t]||(J[t]=function(){return this[t]})}function Xi(){return this[qe]}function oa(t){return Vn(t)}function Vn(t,e){if(!Gn(t))return t;let n=Array.isArray(t),r=n?[]:{};return Object.defineProperties(r,{parsed:{get(){return t[qe]},set(i){Object.defineProperty(this,"parsed",{value:i,writable:!0,enumerable:!0})},configurable:!0},shared:{get(){return t[jn]},set(i){Object.defineProperty(this,"shared",{value:i,writable:!0,enumerable:!0}),this.dpackBuffer=null,this.sizeTableBuffer=null},configurable:!0},dpackBuffer:{get(){return t[he].dpackBuffer},set(i){Object.defineProperty(this,"dpackBuffer",{value:i,writable:!0,enumerable:!0})},configurable:!0},sizeTableBuffer:{get(){return t[ut]},set(i){Object.defineProperty(this,"sizeTableBuffer",{value:i,writable:!0,enumerable:!0})},configurable:!0}}),n&&Object.define,new Proxy(r,Yt)}ie.copy=oa;var Gi={};function re(t){var e=t.parsed;if(e)return e;var n=t.sizeTableBuffer,r=t.dpackBuffer;if(!n)return t.parsed=$n(r,{freezeObjects:Fn,shared:t.shared});var i=n.length,s,o,c=n[0]>>6,a;c===2?(o=n.readUInt16BE(4),a=6):(o=n.readUIntBE(10,6),a=16);for(var l=[],u=[],p=o;a<i;){var c=n[a]>>6,h,g;c<2?c==0?(h=1,g=n[a]):(h=2,g=n.readUInt16BE(a)&16383):c===2?(h=n.readUInt16BE(a)&16383,g=n.readUInt16BE(a+2)):(h=n.readUInt32BE(a)&1073741823,g=n.readUIntBE(a+4,6)),l.push(c<2||c==3&&h==16?void 0:n.slice(a,a+h)),a+=h,u.push(r.slice(p,p+=g))}var f=0,y=t.dpackBuffer.slice(0,o);return t.parsed=$n(y,u.length>0?{shared:t.shared,forDeferred:function(d,S){let m=new d.constructor;return m.dpackBuffer=u[f],m.sizeTableBuffer=l[f++],m.shared=S?S.upgrade?S:{code:S.code,key:null,type:S.type}:null,new Proxy(m,$t)},freezeObjects:Fn}:{shared:t.shared})}function Wn(t,e){var n=[],r=[],i=0,s,o={forBlock:function(u,p){var h=u[Yn](p,!0);if(h.mustSequence)return s=!0,n.push(h),h;var g=u[ut];if(!g){var f=h.length;f<64?g=Buffer.from([f]):f<16384?g=Buffer.from([f>>8|64,f&255]):(g=Buffer.allocUnsafe(16),g.writeUInt32BE(3221225488),g.writeUIntBE(f,4,6),g.writeUIntBE(f,10,6))}return r.push(g),i+=h.length,n.push(h),h},shared:e,freezeObjects:Fn},c=ea(t.parsed,o);if(n.length==0)return t.dpackBuffer=c;n.unshift(c);var a=t.dpackBuffer=Buffer.concat(n);if(s)return a;var l=Buffer.allocUnsafe(a.length>=65536?16:6);return r.unshift(l),l=t.sizeTableBuffer=Buffer.concat(r),a.length>=65536?(l.writeUInt32BE(l.length+3221225472,0),l.writeUIntBE(a.length,4,6),l.writeUIntBE(c.length,10,6)):(l.writeUInt16BE(l.length|32768,0),l.writeUInt16BE(a.length,2),l.writeUInt16BE(c.length,4)),a}var $n=ft().parse,nh=Wt().serializeSharedBlock;ie.parseLazy=function(t,e){return t[0]&128||t[0]>>4===3||t[0]===119?qi(t,e&&e.shared):$n(t,e)}});var es=pe(Q=>{Q.createSerializeStream=Di().createSerializeStream;Q.createParseStream=Pi().createParseStream;var Hn=Ge();Hn.nodeCharEncoder=Ci().nodeCharEncoder;var Qi=ft(),ca=Pn().Options;Q.serialize=Hn.serialize;Q.parse=Qi.parse;Q.createSerializer=Hn.createSerializer;Q.createParser=Qi.createParser;var ht=Zi();Q.parseLazy=ht.parseLazy;Q.asBlock=ht.asBlock;Q.isBlock=ht.isBlock;Q.copy=ht.copy;Q.reassignBuffers=ht.reassignBuffers;Q.Options=ca;Q.createSharedStructure=Wt().createSharedStructure;Q.readSharedStructure=Wt().readSharedStructure});var Zn={arabic:"ar",armenian:"am",bulgarian:"bg",czech:"cz",danish:"dk",dutch:"nl",english:"en",finnish:"fi",french:"fr",german:"de",greek:"gr",hungarian:"hu",indian:"in",indonesian:"id",irish:"ie",italian:"it",lithuanian:"lt",nepali:"np",norwegian:"no",portuguese:"pt",romanian:"ro",russian:"ru",serbian:"rs",slovenian:"ru",spanish:"es",swedish:"se",tamil:"ta",turkish:"tr",ukrainian:"uk",sanskrit:"sk"},Qn={dutch:/[^A-Za-zàèéìòóù0-9_'-]+/gim,english:/[^A-Za-zàèéìòóù0-9_'-]+/gim,french:/[^a-z0-9äâàéèëêïîöôùüûœç-]+/gim,italian:/[^A-Za-zàèéìòóù0-9_'-]+/gim,norwegian:/[^a-z0-9_æøåÆØÅäÄöÖüÜ]+/gim,portuguese:/[^a-z0-9à-úÀ-Ú]/gim,russian:/[^a-z0-9а-яА-ЯёЁ]+/gim,spanish:/[^a-z0-9A-Zá-úÁ-ÚñÑüÜ]+/gim,swedish:/[^a-z0-9_åÅäÄöÖüÜ-]+/gim,german:/[^a-z0-9A-ZäöüÄÖÜß]+/gim,finnish:/[^a-z0-9äöÄÖ]+/gim,danish:/[^a-z0-9æøåÆØÅ]+/gim,hungarian:/[^a-z0-9áéíóöőúüűÁÉÍÓÖŐÚÜŰ]+/gim,romanian:/[^a-z0-9ăâîșțĂÂÎȘȚ]+/gim,serbian:/[^a-z0-9čćžšđČĆŽŠĐ]+/gim,turkish:/[^a-z0-9çÇğĞıİöÖşŞüÜ]+/gim,lithuanian:/[^a-z0-9ąčęėįšųūžĄČĘĖĮŠŲŪŽ]+/gim,arabic:/[^a-z0-9أ-ي]+/gim,nepali:/[^a-z0-9अ-ह]+/gim,irish:/[^a-z0-9áéíóúÁÉÍÓÚ]+/gim,indian:/[^a-z0-9अ-ह]+/gim,armenian:/[^a-z0-9ա-ֆ]+/gim,greek:/[^a-z0-9α-ωά-ώ]+/gim,indonesian:/[^a-z0-9]+/gim,ukrainian:/[^a-z0-9а-яА-ЯіїєІЇЄ]+/gim,slovenian:/[^a-z0-9čžšČŽŠ]+/gim,bulgarian:/[^a-z0-9а-яА-Я]+/gim,tamil:/[^a-z0-9அ-ஹ]+/gim,sanskrit:/[^a-z0-9A-Zāīūṛḷṃṁḥśṣṭḍṇṅñḻḹṝ]+/gim,czech:/[^A-Z0-9a-zěščřžýáíéúůóťďĚŠČŘŽÝÁÍÉÓÚŮŤĎ-]+/gim},Je=Object.keys(Zn);function er(t){return t!==void 0&&Je.includes(t)?Zn[t]:void 0}var Ds=Date.now().toString().slice(5),bs=0,tr=1024,nr=BigInt(1e3),rr=BigInt(1e6),ir=BigInt(1e9);var Kt=65535;function Re(t,e){if(e.length<Kt)Array.prototype.push.apply(t,e);else{let n=e.length;for(let r=0;r<n;r+=Kt)Array.prototype.push.apply(t,e.slice(r,r+Kt))}}function cr(t,...e){return t.replace(/%(?:(?<position>\d+)\$)?(?<width>-?\d*\.?\d*)(?<type>[dfs])/g,function(...n){let r=n[n.length-1],{width:i,type:s,position:o}=r,c=o?e[Number.parseInt(o)-1]:e.shift(),a=i===""?0:Number.parseInt(i);switch(s){case"d":return c.toString().padStart(a,"0");case"f":{let l=c,[u,p]=i.split(".").map(h=>Number.parseFloat(h));return typeof p=="number"&&p>=0&&(l=l.toFixed(p)),typeof u=="number"&&u>=0?l.toString().padStart(a,"0"):l.toString()}case"s":return a<0?c.toString().padEnd(-a," "):c.toString().padStart(a," ");default:return c}})}function ar(t,e=2){if(t===0)return"0 Bytes";let n=e<0?0:e,r=["Bytes","KB","MB","GB","TB","PB","EB","ZB","YB"],i=Math.floor(Math.log(t)/Math.log(tr));return`${parseFloat((t/Math.pow(tr,i)).toFixed(n))} ${r[i]}`}function Us(){return typeof WorkerGlobalScope!="undefined"&&self instanceof WorkerGlobalScope}function zs(){return typeof process!="undefined"&&process.release&&process.release.name==="node"}function sr(){return BigInt(Math.floor(performance.now()*1e6))}function ye(t){return typeof t=="number"&&(t=BigInt(t)),t<nr?`${t}ns`:t<rr?`${t/nr}\u03BCs`:t<ir?`${t/rr}ms`:`${t/ir}s`}function oe(){var t;return Us()?sr():zs()||typeof process!="undefined"&&typeof((t=process==null?void 0:process.hrtime)==null?void 0:t.bigint)=="function"?process.hrtime.bigint():typeof performance!="undefined"?sr():BigInt(0)}function Pe(){return`${Ds}-${bs++}`}function yt(t,e){return Object.hasOwn===void 0?Object.prototype.hasOwnProperty.call(t,e)?t[e]:void 0:Object.hasOwn(t,e)?t[e]:void 0}function mt(t,e){return e[1]===t[1]?t[0]-e[0]:e[1]-t[1]}function lr(t){if(t.length===0)return[];if(t.length===1)return t[0];for(let n=1;n<t.length;n++)if(t[n].length<t[0].length){let r=t[0];t[0]=t[n],t[n]=r}let e=new Map;for(let n of t[0])e.set(n,1);for(let n=1;n<t.length;n++){let r=0;for(let i of t[n]){let s=e.get(i);s===n&&(e.set(i,s+1),r++)}if(r===0)return[]}return t[0].filter(n=>{let r=e.get(n);return r!==void 0&&e.set(n,0),r===t.length})}function Xe(t,e){let n={},r=e.length;for(let i=0;i<r;i++){let s=e[i],o=s.split("."),c=t,a=o.length;for(let l=0;l<a;l++)if(c=c[o[l]],typeof c=="object"){if(c!==null&&"lat"in c&&"lon"in c&&typeof c.lat=="number"&&typeof c.lon=="number"){c=n[s]=c;break}else if(!Array.isArray(c)&&c!==null&&l===a-1){c=void 0;break}}else if((c===null||typeof c!="object")&&l<a-1){c=void 0;break}typeof c!="undefined"&&(n[s]=c)}return n}function Me(t,e){return Xe(t,[e])[e]}var Os={cm:.01,m:1,km:1e3,ft:.3048,yd:.9144,mi:1609.344};function Ze(t,e){let n=Os[e];if(n===void 0)throw new Error(_("INVALID_DISTANCE_SUFFIX",t).message);return t*n}function St(t,e){t.hits=t.hits.map(n=>({...n,document:{...n.document,...e.reduce((r,i)=>{var a;let s=i.split("."),o=s.pop(),c=r;for(let l of s)c[l]=(a=c[l])!=null?a:{},c=c[l];return c[o]=null,r},n.document)}}))}function H(t){var e;return Array.isArray(t)?t.some(n=>H(n)):((e=t==null?void 0:t.constructor)==null?void 0:e.name)==="AsyncFunction"}var or="intersection"in new Set;function Qe(...t){if(t.length===0)return new Set;if(t.length===1)return t[0];if(t.length===2){let r=t[0],i=t[1];if(or)return r.intersection(i);let s=new Set,o=r.size<i.size?r:i,c=o===r?i:r;for(let a of o)c.has(a)&&s.add(a);return s}let e={index:0,size:t[0].size};for(let r=1;r<t.length;r++)t[r].size<e.size&&(e.index=r,e.size=t[r].size);if(or){let r=t[e.index];for(let i=0;i<t.length;i++)i!==e.index&&(r=r.intersection(t[i]));return r}let n=t[e.index];for(let r=0;r<t.length;r++){if(r===e.index)continue;let i=t[r];for(let s of n)i.has(s)||n.delete(s)}return n}var _s="union"in new Set;function ve(t,e){return _s?t?t.union(e):e:t?new Set([...t,...e]):new Set(e)}function xt(t,e){let n=new Set;for(let r of t)e.has(r)||n.add(r);return n}var Ns=Je.join(`
 - `),Rs={NO_LANGUAGE_WITH_CUSTOM_TOKENIZER:"Do not pass the language option to create when using a custom tokenizer.",LANGUAGE_NOT_SUPPORTED:`Language "%s" is not supported.
Supported languages are:
 - ${Ns}`,INVALID_STEMMER_FUNCTION_TYPE:"config.stemmer property must be a function.",MISSING_STEMMER:'As of version 1.0.0 @orama/orama does not ship non English stemmers by default. To solve this, please explicitly import and specify the "%s" stemmer from the package @orama/stemmers. See https://docs.orama.com/docs/orama-js/text-analysis/stemming for more information.',CUSTOM_STOP_WORDS_MUST_BE_FUNCTION_OR_ARRAY:"Custom stop words array must only contain strings.",UNSUPPORTED_COMPONENT:'Unsupported component "%s".',COMPONENT_MUST_BE_FUNCTION:'The component "%s" must be a function.',COMPONENT_MUST_BE_FUNCTION_OR_ARRAY_FUNCTIONS:'The component "%s" must be a function or an array of functions.',INVALID_SCHEMA_TYPE:'Unsupported schema type "%s" at "%s". Expected "string", "boolean" or "number" or array of them.',DOCUMENT_ID_MUST_BE_STRING:'Document id must be of type "string". Got "%s" instead.',DOCUMENT_ALREADY_EXISTS:'A document with id "%s" already exists.',DOCUMENT_DOES_NOT_EXIST:'A document with id "%s" does not exists.',MISSING_DOCUMENT_PROPERTY:'Missing searchable property "%s".',INVALID_DOCUMENT_PROPERTY:'Invalid document property "%s": expected "%s", got "%s"',UNKNOWN_INDEX:'Invalid property name "%s". Expected a wildcard string ("*") or array containing one of the following properties: %s',INVALID_BOOST_VALUE:"Boost value must be a number greater than, or less than 0.",INVALID_FILTER_OPERATION:"You can only use one operation per filter, you requested %d.",SCHEMA_VALIDATION_FAILURE:'Cannot insert document due schema validation failure on "%s" property.',INVALID_SORT_SCHEMA_TYPE:'Unsupported sort schema type "%s" at "%s". Expected "string" or "number".',CANNOT_SORT_BY_ARRAY:'Cannot configure sort for "%s" because it is an array (%s).',UNABLE_TO_SORT_ON_UNKNOWN_FIELD:'Unable to sort on unknown field "%s". Allowed fields: %s',SORT_DISABLED:"Sort is disabled. Please read the documentation at https://docs.orama.com/docs/orama-js for more information.",UNKNOWN_GROUP_BY_PROPERTY:'Unknown groupBy property "%s".',INVALID_GROUP_BY_PROPERTY:'Invalid groupBy property "%s". Allowed types: "%s", but given "%s".',UNKNOWN_FILTER_PROPERTY:'Unknown filter property "%s".',UNKNOWN_VECTOR_PROPERTY:'Unknown vector property "%s". Make sure the property exists in the schema and is configured as a vector.',INVALID_VECTOR_SIZE:'Vector size must be a number greater than 0. Got "%s" instead.',INVALID_VECTOR_VALUE:'Vector value must be a number greater than 0. Got "%s" instead.',INVALID_INPUT_VECTOR:`Property "%s" was declared as a %s-dimensional vector, but got a %s-dimensional vector instead.
Input vectors must be of the size declared in the schema, as calculating similarity between vectors of different sizes can lead to unexpected results.`,WRONG_SEARCH_PROPERTY_TYPE:'Property "%s" is not searchable. Only "string" properties are searchable.',FACET_NOT_SUPPORTED:`Facet doens't support the type "%s".`,INVALID_DISTANCE_SUFFIX:'Invalid distance suffix "%s". Valid suffixes are: cm, m, km, mi, yd, ft.',INVALID_SEARCH_MODE:'Invalid search mode "%s". Valid modes are: "fulltext", "vector", "hybrid".',MISSING_VECTOR_AND_SECURE_PROXY:"No vector was provided and no secure proxy was configured. Please provide a vector or configure an Orama Secure Proxy to perform hybrid search.",MISSING_TERM:'"term" is a required parameter when performing hybrid search. Please provide a search term.',INVALID_VECTOR_INPUT:'Invalid "vector" property. Expected an object with "value" and "property" properties, but got "%s" instead.',PLUGIN_CRASHED:"A plugin crashed during initialization. Please check the error message for more information:",PLUGIN_SECURE_PROXY_NOT_FOUND:`Could not find '@orama/secure-proxy-plugin' installed in your Orama instance.
Please install it before proceeding with creating an answer session.
Read more at https://docs.orama.com/docs/orama-js/plugins/plugin-secure-proxy#plugin-secure-proxy
`,PLUGIN_SECURE_PROXY_MISSING_CHAT_MODEL:`Could not find a chat model defined in the secure proxy plugin configuration.
Please provide a chat model before proceeding with creating an answer session.
Read more at https://docs.orama.com/docs/orama-js/plugins/plugin-secure-proxy#plugin-secure-proxy
`,ANSWER_SESSION_LAST_MESSAGE_IS_NOT_ASSISTANT:"The last message in the session is not an assistant message. Cannot regenerate non-assistant messages.",PLUGIN_COMPONENT_CONFLICT:'The component "%s" is already defined. The plugin "%s" is trying to redefine it.'};function _(t,...e){var r;let n=new Error(cr((r=Rs[t])!=null?r:`Unsupported Orama Error code: ${t}`,...e));return n.code=t,"captureStackTrace"in Error.prototype&&Error.captureStackTrace(n),n}function qt(t){return{raw:Number(t),formatted:ye(t)}}function Jt(t){if(t.id){if(typeof t.id!="string")throw _("DOCUMENT_ID_MUST_BE_STRING",typeof t.id);return t.id}return Pe()}function wt(t,e){for(let[n,r]of Object.entries(e)){let i=t[n];if(typeof i!="undefined"&&!(r==="geopoint"&&typeof i=="object"&&typeof i.lon=="number"&&typeof i.lat=="number")&&!(r==="enum"&&(typeof i=="string"||typeof i=="number"))){if(r==="enum[]"&&Array.isArray(i)){let s=i.length;for(let o=0;o<s;o++)if(typeof i[o]!="string"&&typeof i[o]!="number")return n+"."+o;continue}if(fe(r)){let s=Et(r);if(!Array.isArray(i)||i.length!==s)throw _("INVALID_INPUT_VECTOR",n,s,i.length);continue}if(Te(r)){if(!Array.isArray(i))return n;let s=It(r),o=i.length;for(let c=0;c<o;c++)if(typeof i[c]!==s)return n+"."+c;continue}if(typeof r=="object"){if(!i||typeof i!="object")return n;let s=wt(i,r);if(s)return n+"."+s;continue}if(typeof i!==r)return n}}}var Ps={string:!1,number:!1,boolean:!1,enum:!1,geopoint:!1,"string[]":!0,"number[]":!0,"boolean[]":!0,"enum[]":!0},Ms={"string[]":"string","number[]":"number","boolean[]":"boolean","enum[]":"enum"};function Xt(t){return t==="geopoint"}function fe(t){return typeof t=="string"&&/^vector\[\d+\]$/.test(t)}function Te(t){return typeof t=="string"&&Ps[t]}function It(t){return Ms[t]}function Et(t){let e=Number(t.slice(7,-1));switch(!0){case isNaN(e):throw _("INVALID_VECTOR_VALUE",t);case e<=0:throw _("INVALID_VECTOR_SIZE",t);default:return e}}var Tt={};Ee(Tt,{count:()=>Sr,create:()=>dr,createDocumentsStore:()=>Qt,get:()=>hr,getAll:()=>gr,getMultiple:()=>pr,load:()=>xr,remove:()=>mr,save:()=>wr,store:()=>yr});var vt={};Ee(vt,{createInternalDocumentIDStore:()=>Zt,getDocumentIdFromInternalId:()=>ce,getInternalDocumentId:()=>V,load:()=>ur,save:()=>fr});function Zt(){return{idToInternalId:new Map,internalIdToId:[],save:fr,load:ur}}function fr(t){return{internalIdToId:t.internalIdToId}}function ur(t,e){let{internalIdToId:n}=e;t.internalDocumentIDStore.idToInternalId.clear(),t.internalDocumentIDStore.internalIdToId=[];let r=n.length;for(let i=0;i<r;i++){let s=n[i];t.internalDocumentIDStore.idToInternalId.set(s,i+1),t.internalDocumentIDStore.internalIdToId.push(s)}}function V(t,e){if(typeof e=="string"){let n=t.idToInternalId.get(e);if(n)return n;let r=t.idToInternalId.size+1;return t.idToInternalId.set(e,r),t.internalIdToId.push(e),r}return e>t.internalIdToId.length?V(t,e.toString()):e}function ce(t,e){if(t.internalIdToId.length<e)throw new Error(`Invalid internalId ${e}`);return t.internalIdToId[e-1]}function dr(t,e){return{sharedInternalDocumentStore:e,docs:{},count:0}}function hr(t,e){let n=V(t.sharedInternalDocumentStore,e);return t.docs[n]}function pr(t,e){let n=e.length,r=Array.from({length:n});for(let i=0;i<n;i++){let s=V(t.sharedInternalDocumentStore,e[i]);r[i]=t.docs[s]}return r}function gr(t){return t.docs}function yr(t,e,n,r){return typeof t.docs[n]!="undefined"?!1:(t.docs[n]=r,t.count++,!0)}function mr(t,e){let n=V(t.sharedInternalDocumentStore,e);return typeof t.docs[n]=="undefined"?!1:(delete t.docs[n],t.count--,!0)}function Sr(t){return t.count}function xr(t,e){let n=e;return{docs:n.docs,count:n.count,sharedInternalDocumentStore:t}}function wr(t){return{docs:t.docs,count:t.count}}function Qt(){return{create:dr,get:hr,getMultiple:pr,getAll:gr,store:yr,remove:mr,count:Sr,load:xr,save:wr}}var Ir=["beforeInsert","afterInsert","beforeRemove","afterRemove","beforeUpdate","afterUpdate","beforeUpsert","afterUpsert","beforeSearch","afterSearch","beforeInsertMultiple","afterInsertMultiple","beforeRemoveMultiple","afterRemoveMultiple","beforeUpdateMultiple","afterUpdateMultiple","beforeUpsertMultiple","afterUpsertMultiple","beforeLoad","afterLoad","afterCreate"];function Er(t,e){var i;let n=[],r=(i=t.plugins)==null?void 0:i.length;if(!r)return n;for(let s=0;s<r;s++)try{let o=t.plugins[s];typeof o[e]=="function"&&n.push(o[e])}catch(o){throw console.error("Caught error in getAllPluginsByHook:",o),_("PLUGIN_CRASHED")}return n}var vr=["tokenizer","index","documentsStore","sorter","pinning"],en=["validateSchema","getDocumentIndexId","getDocumentProperties","formatElapsedTime"];function se(t,e,n,r){if(t.some(H))return(async()=>{for(let s of t)await s(e,n,r)})();for(let s of t)s(e,n,r)}function Be(t,e,n,r,i){if(t.some(H))return(async()=>{for(let o of t)await o(e,n,r,i)})();for(let o of t)o(e,n,r,i)}function ke(t,e,n,r){if(t.some(H))return(async()=>{for(let s of t)await s(e,n,r)})();for(let s of t)s(e,n,r)}function Tr(t,e){if(t.some(H))return(async()=>{for(let r of t)await r(e)})();for(let r of t)r(e)}var At={};Ee(At,{calculateResultScores:()=>rn,create:()=>nn,createIndex:()=>sn,getSearchableProperties:()=>Fr,getSearchablePropertiesWithTypes:()=>Vr,insert:()=>Br,insertDocumentScoreParameters:()=>Nr,insertTokenScoreParameters:()=>Rr,insertVector:()=>kr,load:()=>Wr,remove:()=>Cr,removeDocumentScoreParameters:()=>Pr,removeTokenScoreParameters:()=>Mr,save:()=>$r,search:()=>Lr,searchByGeoWhereClause:()=>on,searchByWhereClause:()=>et});var Z=class{constructor(e,n){C(this,"k");C(this,"v");C(this,"l",null);C(this,"r",null);C(this,"h",1);this.k=e,this.v=new Set(n)}updateHeight(){this.h=Math.max(Z.getHeight(this.l),Z.getHeight(this.r))+1}static getHeight(e){return e?e.h:0}getBalanceFactor(){return Z.getHeight(this.l)-Z.getHeight(this.r)}rotateLeft(){let e=this.r;return this.r=e.l,e.l=this,this.updateHeight(),e.updateHeight(),e}rotateRight(){let e=this.l;return this.l=e.r,e.r=this,this.updateHeight(),e.updateHeight(),e}toJSON(){return{k:this.k,v:Array.from(this.v),l:this.l?this.l.toJSON():null,r:this.r?this.r.toJSON():null,h:this.h}}static fromJSON(e){let n=new Z(e.k,e.v);return n.l=e.l?Z.fromJSON(e.l):null,n.r=e.r?Z.fromJSON(e.r):null,n.h=e.h,n}},Ae=class{constructor(e,n){C(this,"root",null);C(this,"insertCount",0);e!==void 0&&n!==void 0&&(this.root=new Z(e,n))}insert(e,n,r=1e3){this.root=this.insertNode(this.root,e,n,r)}insertMultiple(e,n,r=1e3){for(let i of n)this.insert(e,i,r)}rebalance(){this.root&&(this.root=this.rebalanceNode(this.root))}toJSON(){return{root:this.root?this.root.toJSON():null,insertCount:this.insertCount}}static fromJSON(e){let n=new Ae;return n.root=e.root?Z.fromJSON(e.root):null,n.insertCount=e.insertCount||0,n}insertNode(e,n,r,i){if(e===null)return new Z(n,[r]);let s=[],o=e,c=null;for(;o!==null;)if(s.push({parent:c,node:o}),n<o.k)if(o.l===null){o.l=new Z(n,[r]),s.push({parent:o,node:o.l});break}else c=o,o=o.l;else if(n>o.k)if(o.r===null){o.r=new Z(n,[r]),s.push({parent:o,node:o.r});break}else c=o,o=o.r;else return o.v.add(r),e;let a=!1;this.insertCount++%i===0&&(a=!0);for(let l=s.length-1;l>=0;l--){let{parent:u,node:p}=s[l];if(p.updateHeight(),a){let h=this.rebalanceNode(p);u?u.l===p?u.l=h:u.r===p&&(u.r=h):e=h}}return e}rebalanceNode(e){let n=e.getBalanceFactor();if(n>1){if(e.l&&e.l.getBalanceFactor()>=0)return e.rotateRight();if(e.l)return e.l=e.l.rotateLeft(),e.rotateRight()}if(n<-1){if(e.r&&e.r.getBalanceFactor()<=0)return e.rotateLeft();if(e.r)return e.r=e.r.rotateRight(),e.rotateLeft()}return e}find(e){let n=this.findNodeByKey(e);return n?n.v:null}contains(e){return this.find(e)!==null}getSize(){let e=0,n=[],r=this.root;for(;r||n.length>0;){for(;r;)n.push(r),r=r.l;r=n.pop(),e++,r=r.r}return e}isBalanced(){if(!this.root)return!0;let e=[this.root];for(;e.length>0;){let n=e.pop(),r=n.getBalanceFactor();if(Math.abs(r)>1)return!1;n.l&&e.push(n.l),n.r&&e.push(n.r)}return!0}remove(e){this.root=this.removeNode(this.root,e)}removeDocument(e,n){let r=this.findNodeByKey(e);r&&(r.v.size===1?this.root=this.removeNode(this.root,e):r.v=new Set([...r.v.values()].filter(i=>i!==n)))}findNodeByKey(e){let n=this.root;for(;n;)if(e<n.k)n=n.l;else if(e>n.k)n=n.r;else return n;return null}removeNode(e,n){if(e===null)return null;let r=[],i=e;for(;i!==null&&i.k!==n;)r.push(i),n<i.k?i=i.l:i=i.r;if(i===null)return e;if(i.l===null||i.r===null){let s=i.l?i.l:i.r;if(r.length===0)e=s;else{let o=r[r.length-1];o.l===i?o.l=s:o.r=s}}else{let s=i,o=i.r;for(;o.l!==null;)s=o,o=o.l;i.k=o.k,i.v=o.v,s.l===o?s.l=o.r:s.r=o.r,i=s}r.push(i);for(let s=r.length-1;s>=0;s--){let o=r[s];o.updateHeight();let c=this.rebalanceNode(o);if(s>0){let a=r[s-1];a.l===o?a.l=c:a.r===o&&(a.r=c)}else e=c}return e}rangeSearch(e,n){let r=new Set,i=[],s=this.root;for(;s||i.length>0;){for(;s;)i.push(s),s=s.l;if(s=i.pop(),s.k>=e&&s.k<=n)for(let o of s.v)r.add(o);if(s.k>n)break;s=s.r}return r}greaterThan(e,n=!1){let r=new Set,i=[],s=this.root;for(;s||i.length>0;){for(;s;)i.push(s),s=s.r;if(s=i.pop(),n&&s.k>=e||!n&&s.k>e)for(let o of s.v)r.add(o);else if(s.k<=e)break;s=s.l}return r}lessThan(e,n=!1){let r=new Set,i=[],s=this.root;for(;s||i.length>0;){for(;s;)i.push(s),s=s.l;if(s=i.pop(),n&&s.k<=e||!n&&s.k<e)for(let o of s.v)r.add(o);else if(s.k>e)break;s=s.r}return r}};var De=class{constructor(){C(this,"numberToDocumentId");this.numberToDocumentId=new Map}insert(e,n){this.numberToDocumentId.has(e)?this.numberToDocumentId.get(e).add(n):this.numberToDocumentId.set(e,new Set([n]))}find(e){let n=this.numberToDocumentId.get(e);return n?Array.from(n):null}remove(e){this.numberToDocumentId.delete(e)}removeDocument(e,n){let r=this.numberToDocumentId.get(n);r&&(r.delete(e),r.size===0&&this.numberToDocumentId.delete(n))}contains(e){return this.numberToDocumentId.has(e)}getSize(){let e=0;for(let n of this.numberToDocumentId.values())e+=n.size;return e}filter(e){let n=Object.keys(e);if(n.length!==1)throw new Error("Invalid operation");let r=n[0];switch(r){case"eq":{let i=e[r],s=this.numberToDocumentId.get(i);return s?Array.from(s):[]}case"in":{let i=e[r],s=new Set;for(let o of i){let c=this.numberToDocumentId.get(o);if(c)for(let a of c)s.add(a)}return Array.from(s)}case"nin":{let i=new Set(e[r]),s=new Set;for(let[o,c]of this.numberToDocumentId.entries())if(!i.has(o))for(let a of c)s.add(a);return Array.from(s)}default:throw new Error("Invalid operation")}}filterArr(e){let n=Object.keys(e);if(n.length!==1)throw new Error("Invalid operation");let r=n[0];switch(r){case"containsAll":{let s=e[r].map(c=>{var a;return(a=this.numberToDocumentId.get(c))!=null?a:new Set});if(s.length===0)return[];let o=s.reduce((c,a)=>new Set([...c].filter(l=>a.has(l))));return Array.from(o)}case"containsAny":{let s=e[r].map(c=>{var a;return(a=this.numberToDocumentId.get(c))!=null?a:new Set});if(s.length===0)return[];let o=s.reduce((c,a)=>new Set([...c,...a]));return Array.from(o)}default:throw new Error("Invalid operation")}}static fromJSON(e){if(!e.numberToDocumentId)throw new Error("Invalid Flat Tree JSON");let n=new De;for(let[r,i]of e.numberToDocumentId)n.numberToDocumentId.set(r,new Set(i));return n}toJSON(){return{numberToDocumentId:Array.from(this.numberToDocumentId.entries()).map(([e,n])=>[e,Array.from(n)])}}};function Ar(t,e,n){if(n<0)return-1;if(t===e)return 0;let r=t.length,i=e.length;if(r===0)return i<=n?i:-1;if(i===0)return r<=n?r:-1;let s=Math.abs(r-i);if(t.startsWith(e))return s<=n?s:-1;if(e.startsWith(t))return 0;if(s>n)return-1;let o=[];for(let c=0;c<=r;c++){o[c]=[c];for(let a=1;a<=i;a++)o[c][a]=c===0?a:0}for(let c=1;c<=r;c++){let a=1/0;for(let l=1;l<=i;l++)t[c-1]===e[l-1]?o[c][l]=o[c-1][l-1]:o[c][l]=Math.min(o[c-1][l]+1,o[c][l-1]+1,o[c-1][l-1]+1),a=Math.min(a,o[c][l]);if(a>n)return-1}return o[r][i]<=n?o[r][i]:-1}function Dr(t,e,n){let r=Ar(t,e,n);return{distance:r,isBounded:r>=0}}function tn(t,e,n){let r=Ar(t,e,n);return{distance:r,isBounded:r>=0}}var ue=class{constructor(e,n,r){C(this,"k");C(this,"s");C(this,"c",new Map);C(this,"d",new Set);C(this,"e");C(this,"w","");this.k=e,this.s=n,this.e=r}updateParent(e){this.w=e.w+this.s}addDocument(e){this.d.add(e)}removeDocument(e){return this.d.delete(e)}findAllWords(e,n,r,i){let s=[this];for(;s.length>0;){let o=s.pop();if(o.e){let{w:c,d:a}=o;if(r&&c!==n)continue;if(yt(e,c)!==null)if(i)if(Math.abs(n.length-c.length)<=i&&tn(n,c,i).isBounded)e[c]=[];else continue;else e[c]=[];if(yt(e,c)!=null&&a.size>0){let l=e[c];for(let u of a)l.includes(u)||l.push(u)}}o.c.size>0&&s.push(...o.c.values())}return e}insert(e,n){let r=this,i=0,s=e.length;for(;i<s;){let o=e[i],c=r.c.get(o);if(c){let a=c.s,l=a.length,u=0;for(;u<l&&i+u<s&&a[u]===e[i+u];)u++;if(u===l){if(r=c,i+=u,i===s){c.e||(c.e=!0),c.addDocument(n);return}continue}let p=a.slice(0,u),h=a.slice(u),g=e.slice(i+u),f=new ue(p[0],p,!1);if(r.c.set(p[0],f),f.updateParent(r),c.s=h,c.k=h[0],f.c.set(h[0],c),c.updateParent(f),g){let y=new ue(g[0],g,!0);y.addDocument(n),f.c.set(g[0],y),y.updateParent(f)}else f.e=!0,f.addDocument(n);return}else{let a=new ue(o,e.slice(i),!0);a.addDocument(n),r.c.set(o,a),a.updateParent(r);return}}r.e||(r.e=!0),r.addDocument(n)}_findLevenshtein(e,n,r,i,s){let o=[{node:this,index:n,tolerance:r}];for(;o.length>0;){let{node:c,index:a,tolerance:l}=o.pop();if(c.w.startsWith(e)){c.findAllWords(s,e,!1,0);continue}if(l<0)continue;if(c.e){let{w:p,d:h}=c;if(p&&(tn(e,p,i).isBounded&&(s[p]=[]),yt(s,p)!==void 0&&h.size>0)){let g=new Set(s[p]);for(let f of h)g.add(f);s[p]=Array.from(g)}}if(a>=e.length)continue;let u=e[a];if(c.c.has(u)){let p=c.c.get(u);o.push({node:p,index:a+1,tolerance:l})}o.push({node:c,index:a+1,tolerance:l-1});for(let[p,h]of c.c)o.push({node:h,index:a,tolerance:l-1}),p!==u&&o.push({node:h,index:a+1,tolerance:l-1})}}find(e){let{term:n,exact:r,tolerance:i}=e;if(i&&!r){let s={};return this._findLevenshtein(n,0,i,i,s),s}else{let s=this,o=0,c=n.length;for(;o<c;){let l=n[o],u=s.c.get(l);if(u){let p=u.s,h=p.length,g=0;for(;g<h&&o+g<c&&p[g]===n[o+g];)g++;if(g===h)s=u,o+=g;else if(o+g===c)if(g===c-o){if(r)return{};{let f={};return u.findAllWords(f,n,r,i),f}}else return{};else return{}}else return{}}let a={};return s.findAllWords(a,n,r,i),a}}contains(e){let n=this,r=0,i=e.length;for(;r<i;){let s=e[r],o=n.c.get(s);if(o){let c=o.s,a=c.length,l=0;for(;l<a&&r+l<i&&c[l]===e[r+l];)l++;if(l<a)return!1;r+=a,n=o}else return!1}return!0}removeWord(e){if(!e)return!1;let n=this,r=e.length,i=[];for(let s=0;s<r;s++){let o=e[s];if(n.c.has(o)){let c=n.c.get(o);i.push({parent:n,character:o}),s+=c.s.length-1,n=c}else return!1}for(n.d.clear(),n.e=!1;i.length>0&&n.c.size===0&&!n.e&&n.d.size===0;){let{parent:s,character:o}=i.pop();s.c.delete(o),n=s}return!0}removeDocumentByWord(e,n,r=!0){if(!e)return!0;let i=this,s=e.length;for(let o=0;o<s;o++){let c=e[o];if(i.c.has(c)){let a=i.c.get(c);o+=a.s.length-1,i=a,r&&i.w!==e||i.removeDocument(n)}else return!1}return!0}static getCommonPrefix(e,n){let r=Math.min(e.length,n.length),i=0;for(;i<r&&e.charCodeAt(i)===n.charCodeAt(i);)i++;return e.slice(0,i)}toJSON(){var e,n;return{w:this.w,s:this.s,e:this.e,k:this.k,d:Array.from(this.d),c:(n=Array.from((e=this.c)==null?void 0:e.entries()))==null?void 0:n.map(([r,i])=>[r,i.toJSON()])}}static fromJSON(e){var r;let n=new ue(e.k,e.s,e.e);return n.w=e.w,n.d=new Set(e.d),n.c=new Map(((r=e==null?void 0:e.c)==null?void 0:r.map(([i,s])=>[i,ue.fromJSON(s)]))||[]),n}},be=class extends ue{constructor(){super("","",!1)}static fromJSON(e){var r;let n=new be;return n.w=e.w,n.s=e.s,n.e=e.e,n.k=e.k,n.d=new Set(e.d),n.c=new Map(((r=e==null?void 0:e.c)==null?void 0:r.map(([i,s])=>[i,ue.fromJSON(s)]))||[]),n}toJSON(){return super.toJSON()}};var me=class{constructor(e,n){C(this,"point");C(this,"docIDs");C(this,"left");C(this,"right");C(this,"parent");this.point=e,this.docIDs=new Set(n),this.left=null,this.right=null,this.parent=null}toJSON(){return{point:this.point,docIDs:Array.from(this.docIDs),left:this.left?this.left.toJSON():null,right:this.right?this.right.toJSON():null}}static fromJSON(e,n=null){let r=new me(e.point,e.docIDs);return r.parent=n,e.left&&(r.left=me.fromJSON(e.left,r)),e.right&&(r.right=me.fromJSON(e.right,r)),r}},X=class{constructor(){C(this,"root");C(this,"nodeMap");this.root=null,this.nodeMap=new Map}getPointKey(e){return`${e.lon},${e.lat}`}insert(e,n){let r=this.getPointKey(e),i=this.nodeMap.get(r);if(i){n.forEach(a=>i.docIDs.add(a));return}let s=new me(e,n);if(this.nodeMap.set(r,s),this.root==null){this.root=s;return}let o=this.root,c=0;for(;;){if(c%2===0)if(e.lon<o.point.lon){if(o.left==null){o.left=s,s.parent=o;return}o=o.left}else{if(o.right==null){o.right=s,s.parent=o;return}o=o.right}else if(e.lat<o.point.lat){if(o.left==null){o.left=s,s.parent=o;return}o=o.left}else{if(o.right==null){o.right=s,s.parent=o;return}o=o.right}c++}}contains(e){let n=this.getPointKey(e);return this.nodeMap.has(n)}getDocIDsByCoordinates(e){let n=this.getPointKey(e),r=this.nodeMap.get(n);return r?Array.from(r.docIDs):null}removeDocByID(e,n){let r=this.getPointKey(e),i=this.nodeMap.get(r);i&&(i.docIDs.delete(n),i.docIDs.size===0&&(this.nodeMap.delete(r),this.deleteNode(i)))}deleteNode(e){let n=e.parent,r=e.left?e.left:e.right;r&&(r.parent=n),n?n.left===e?n.left=r:n.right===e&&(n.right=r):(this.root=r,this.root&&(this.root.parent=null))}searchByRadius(e,n,r=!0,i="asc",s=!1){let o=s?X.vincentyDistance:X.haversineDistance,c=[{node:this.root,depth:0}],a=[];for(;c.length>0;){let{node:l,depth:u}=c.pop();if(l==null)continue;let p=o(e,l.point);(r?p<=n:p>n)&&a.push({point:l.point,docIDs:Array.from(l.docIDs)}),l.left!=null&&c.push({node:l.left,depth:u+1}),l.right!=null&&c.push({node:l.right,depth:u+1})}return i&&a.sort((l,u)=>{let p=o(e,l.point),h=o(e,u.point);return i.toLowerCase()==="asc"?p-h:h-p}),a}searchByPolygon(e,n=!0,r=null,i=!1){let s=[{node:this.root,depth:0}],o=[];for(;s.length>0;){let{node:a,depth:l}=s.pop();if(a==null)continue;a.left!=null&&s.push({node:a.left,depth:l+1}),a.right!=null&&s.push({node:a.right,depth:l+1});let u=X.isPointInPolygon(e,a.point);(u&&n||!u&&!n)&&o.push({point:a.point,docIDs:Array.from(a.docIDs)})}let c=X.calculatePolygonCentroid(e);if(r){let a=i?X.vincentyDistance:X.haversineDistance;o.sort((l,u)=>{let p=a(c,l.point),h=a(c,u.point);return r.toLowerCase()==="asc"?p-h:h-p})}return o}toJSON(){return{root:this.root?this.root.toJSON():null}}static fromJSON(e){let n=new X;return e.root&&(n.root=me.fromJSON(e.root),n.buildNodeMap(n.root)),n}buildNodeMap(e){if(e==null)return;let n=this.getPointKey(e.point);this.nodeMap.set(n,e),e.left&&this.buildNodeMap(e.left),e.right&&this.buildNodeMap(e.right)}static calculatePolygonCentroid(e){let n=0,r=0,i=0,s=e.length;for(let c=0,a=s-1;c<s;a=c++){let l=e[c].lon,u=e[c].lat,p=e[a].lon,h=e[a].lat,g=l*h-p*u;n+=g,r+=(l+p)*g,i+=(u+h)*g}n/=2;let o=6*n;return r/=o,i/=o,{lon:r,lat:i}}static isPointInPolygon(e,n){let r=!1,i=n.lon,s=n.lat,o=e.length;for(let c=0,a=o-1;c<o;a=c++){let l=e[c].lon,u=e[c].lat,p=e[a].lon,h=e[a].lat;u>s!=h>s&&i<(p-l)*(s-u)/(h-u)+l&&(r=!r)}return r}static haversineDistance(e,n){let r=Math.PI/180,i=e.lat*r,s=n.lat*r,o=(n.lat-e.lat)*r,c=(n.lon-e.lon)*r,a=Math.sin(o/2)*Math.sin(o/2)+Math.cos(i)*Math.cos(s)*Math.sin(c/2)*Math.sin(c/2);return 6371e3*(2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)))}static vincentyDistance(e,n){let i=.0033528106647474805,s=(1-i)*6378137,o=Math.PI/180,c=e.lat*o,a=n.lat*o,l=(n.lon-e.lon)*o,u=Math.atan((1-i)*Math.tan(c)),p=Math.atan((1-i)*Math.tan(a)),h=Math.sin(u),g=Math.cos(u),f=Math.sin(p),y=Math.cos(p),d=l,S,m=1e3,v,E,x,b,w,T;do{let M=Math.sin(d),W=Math.cos(d);if(v=Math.sqrt(y*M*(y*M)+(g*f-h*y*W)*(g*f-h*y*W)),v===0)return 0;E=h*f+g*y*W,x=Math.atan2(v,E),b=g*y*M/v,w=1-b*b,T=E-2*h*f/w,isNaN(T)&&(T=0);let j=i/16*w*(4+i*(4-3*w));S=d,d=l+(1-j)*i*b*(x+j*v*(T+j*E*(-1+2*T*T)))}while(Math.abs(d-S)>1e-12&&--m>0);if(m===0)return NaN;let O=w*(6378137*6378137-s*s)/(s*s),A=1+O/16384*(4096+O*(-768+O*(320-175*O))),P=O/1024*(256+O*(-128+O*(74-47*O))),U=P*v*(T+P/4*(E*(-1+2*T*T)-P/6*T*(-3+4*v*v)*(-3+4*T*T)));return s*A*(x-U)}};var Ue=class{constructor(){C(this,"true");C(this,"false");this.true=new Set,this.false=new Set}insert(e,n){n?this.true.add(e):this.false.add(e)}delete(e,n){n?this.true.delete(e):this.false.delete(e)}getSize(){return this.true.size+this.false.size}toJSON(){return{true:Array.from(this.true),false:Array.from(this.false)}}static fromJSON(e){let n=new Ue;return n.true=new Set(e.true),n.false=new Set(e.false),n}};function br(t,e,n,r,i,{k:s,b:o,d:c}){return Math.log(1+(n-e+.5)/(e+.5))*(c+t*(s+1))/(t+s*(1-o+o*r/i))}var ze=class{constructor(e){C(this,"size");C(this,"vectors",new Map);this.size=e}add(e,n){n instanceof Float32Array||(n=new Float32Array(n));let r=Ur(n,this.size);this.vectors.set(e,[r,n])}remove(e){this.vectors.delete(e)}find(e,n,r){return e instanceof Float32Array||(e=new Float32Array(e)),Bs(e,r,this.vectors,this.size,n)}toJSON(){let e=[];for(let[n,[r,i]]of this.vectors)e.push([n,[r,Array.from(i)]]);return{size:this.size,vectors:e}}static fromJSON(e){let n=e,r=new ze(n.size);for(let[i,[s,o]]of n.vectors)r.vectors.set(i,[s,new Float32Array(o)]);return r}};function Ur(t,e){let n=0;for(let r=0;r<e;r++)n+=t[r]*t[r];return Math.sqrt(n)}function Bs(t,e,n,r,i){let s=Ur(t,r),o=[],c=e||n.keys();for(let a of c){let l=n.get(a);if(!l)continue;let u=l[0],p=l[1],h=0;for(let f=0;f<r;f++)h+=t[f]*p[f];let g=h/(s*u);g>=i&&o.push([a,g])}return o}function Nr(t,e,n,r,i){var o;let s=V(t.sharedInternalDocumentStore,n);t.avgFieldLength[e]=(((o=t.avgFieldLength[e])!=null?o:0)*(i-1)+r.length)/i,t.fieldLengths[e][s]=r.length,t.frequencies[e][s]={}}function Rr(t,e,n,r,i){var a;let s=0;for(let l of r)l===i&&s++;let o=V(t.sharedInternalDocumentStore,n),c=s/r.length;t.frequencies[e][o][i]=c,i in t.tokenOccurrences[e]||(t.tokenOccurrences[e][i]=0),t.tokenOccurrences[e][i]=((a=t.tokenOccurrences[e][i])!=null?a:0)+1}function Pr(t,e,n,r){let i=V(t.sharedInternalDocumentStore,n);r>1?t.avgFieldLength[e]=(t.avgFieldLength[e]*r-t.fieldLengths[e][i])/(r-1):t.avgFieldLength[e]=void 0,t.fieldLengths[e][i]=void 0,t.frequencies[e][i]=void 0}function Mr(t,e,n){t.tokenOccurrences[e][n]--}function nn(t,e,n,r,i=""){r||(r={sharedInternalDocumentStore:e,indexes:{},vectorIndexes:{},searchableProperties:[],searchablePropertiesWithTypes:{},frequencies:{},tokenOccurrences:{},avgFieldLength:{},fieldLengths:{}});for(let[s,o]of Object.entries(n)){let c=`${i}${i?".":""}${s}`;if(typeof o=="object"&&!Array.isArray(o)){nn(t,e,o,r,c);continue}if(fe(o))r.searchableProperties.push(c),r.searchablePropertiesWithTypes[c]=o,r.vectorIndexes[c]={type:"Vector",node:new ze(Et(o)),isArray:!1};else{let a=/\[/.test(o);switch(o){case"boolean":case"boolean[]":r.indexes[c]={type:"Bool",node:new Ue,isArray:a};break;case"number":case"number[]":r.indexes[c]={type:"AVL",node:new Ae(0,[]),isArray:a};break;case"string":case"string[]":r.indexes[c]={type:"Radix",node:new be,isArray:a},r.avgFieldLength[c]=0,r.frequencies[c]={},r.tokenOccurrences[c]={},r.fieldLengths[c]={};break;case"enum":case"enum[]":r.indexes[c]={type:"Flat",node:new De,isArray:a};break;case"geopoint":r.indexes[c]={type:"BKD",node:new X,isArray:a};break;default:throw _("INVALID_SCHEMA_TYPE",Array.isArray(o)?"array":o,c)}r.searchableProperties.push(c),r.searchablePropertiesWithTypes[c]=o}}return r}function ks(t,e,n,r,i,s,o,c){return a=>{var p;let{type:l,node:u}=e.indexes[n];switch(l){case"Bool":{u[a?"true":"false"].add(r);break}case"AVL":{let h=(p=c==null?void 0:c.avlRebalanceThreshold)!=null?p:1;u.insert(a,r,h);break}case"Radix":{let h=s.tokenize(a,i,n,!1);t.insertDocumentScoreParameters(e,n,r,h,o);for(let g of h)t.insertTokenScoreParameters(e,n,r,h,g),u.insert(g,r);break}case"Flat":{u.insert(a,r);break}case"BKD":{u.insert(a,[r]);break}}}}function Br(t,e,n,r,i,s,o,c,a,l,u){if(fe(o))return kr(e,n,s,r,i);let p=ks(t,e,n,i,c,a,l,u);if(!Te(o))return p(s);let h=s,g=h.length;for(let f=0;f<g;f++)p(h[f])}function kr(t,e,n,r,i){t.vectorIndexes[e].node.add(i,n)}function zr(t,e,n,r,i,s,o,c,a,l){if(fe(o))return e.vectorIndexes[n].node.remove(i),!0;let{type:u,node:p}=e.indexes[n];switch(u){case"AVL":return p.removeDocument(s,i),!0;case"Bool":return p[s?"true":"false"].delete(i),!0;case"Radix":{let h=a.tokenize(s,c,n);t.removeDocumentScoreParameters(e,n,r,l);for(let g of h)t.removeTokenScoreParameters(e,n,g),p.removeDocumentByWord(g,i);return!0}case"Flat":return p.removeDocument(i,s),!0;case"BKD":return p.removeDocByID(s,i),!1}}function Cr(t,e,n,r,i,s,o,c,a,l){if(!Te(o))return zr(t,e,n,r,i,s,o,c,a,l);let u=It(o),p=s,h=p.length;for(let g=0;g<h;g++)zr(t,e,n,r,i,p[g],u,c,a,l);return!0}function rn(t,e,n,r,i,s,o,c,a,l){var S,m,v;let u=Array.from(r),p=t.avgFieldLength[e],h=t.fieldLengths[e],g=t.tokenOccurrences[e],f=t.frequencies[e],y=typeof g[n]=="number"&&(S=g[n])!=null?S:0,d=u.length;for(let E=0;E<d;E++){let x=u[E];if(a&&!a.has(x))continue;l.has(x)||l.set(x,new Map);let b=l.get(x);b.set(e,(b.get(e)||0)+1);let w=(v=(m=f==null?void 0:f[x])==null?void 0:m[n])!=null?v:0,T=br(w,y,i,h[x],p,s);o.has(x)?o.set(x,o.get(x)+T*c):o.set(x,T*c)}}function Lr(t,e,n,r,i,s,o,c,a,l,u,p=0){var v;let h=n.tokenize(e,r),g=h.length||1,f=new Map,y=new Map,d=new Map;for(let E of i){if(!(E in t.indexes))continue;let x=t.indexes[E],{type:b}=x;if(b!=="Radix")throw _("WRONG_SEARCH_PROPERTY_TYPE",E);let w=(v=c[E])!=null?v:1;if(w<=0)throw _("INVALID_BOOST_VALUE",w);h.length===0&&!e&&h.push("");let T=h.length;for(let O=0;O<T;O++){let A=h[O],P=x.node.find({term:A,exact:s,tolerance:o}),U=Object.keys(P);U.length>0&&y.set(A,!0);let L=U.length;for(let M=0;M<L;M++){let W=U[M],j=P[W];rn(t,E,W,j,l,a,d,w,u,f)}}}let S=Array.from(d.entries()).map(([E,x])=>[E,x]).sort((E,x)=>x[1]-E[1]);if(S.length===0)return[];if(p===1)return S;if(p===0){if(g===1)return S;for(let x of h)if(!y.get(x))return[];return S.filter(([x])=>{let b=f.get(x);return b?Array.from(b.values()).some(w=>w===g):!1})}let m=S.filter(([E])=>{let x=f.get(E);return x?Array.from(x.values()).some(b=>b===g):!1});if(m.length>0){let E=S.filter(([b])=>!m.some(([w])=>w===b)),x=Math.ceil(E.length*p);return[...m,...E.slice(0,x)]}return S}function et(t,e,n,r){if("and"in n&&n.and&&Array.isArray(n.and)){let o=n.and;if(o.length===0)return new Set;let c=o.map(a=>et(t,e,a,r));return Qe(...c)}if("or"in n&&n.or&&Array.isArray(n.or)){let o=n.or;return o.length===0?new Set:o.map(a=>et(t,e,a,r)).reduce((a,l)=>ve(a,l),new Set)}if("not"in n&&n.not){let o=n.not,c=new Set,a=t.sharedInternalDocumentStore;for(let u=1;u<=a.internalIdToId.length;u++)c.add(u);let l=et(t,e,o,r);return xt(c,l)}let i=Object.keys(n),s=i.reduce((o,c)=>({[c]:new Set,...o}),{});for(let o of i){let c=n[o];if(typeof t.indexes[o]=="undefined")throw _("UNKNOWN_FILTER_PROPERTY",o);let{node:a,type:l,isArray:u}=t.indexes[o];if(l==="Bool"){let h=a,g=c?h.true:h.false;s[o]=ve(s[o],g);continue}if(l==="BKD"){let h;if("radius"in c)h="radius";else if("polygon"in c)h="polygon";else throw new Error(`Invalid operation ${c}`);if(h==="radius"){let{value:g,coordinates:f,unit:y="m",inside:d=!0,highPrecision:S=!1}=c[h],m=Ze(g,y),v=a.searchByRadius(f,m,d,void 0,S);s[o]=Or(s[o],v)}else{let{coordinates:g,inside:f=!0,highPrecision:y=!1}=c[h],d=a.searchByPolygon(g,f,void 0,y);s[o]=Or(s[o],d)}continue}if(l==="Radix"&&(typeof c=="string"||Array.isArray(c))){for(let h of[c].flat()){let g=e.tokenize(h,r,o);for(let f of g){let y=a.find({term:f,exact:!0});s[o]=Ls(s[o],y)}}continue}let p=Object.keys(c);if(p.length>1)throw _("INVALID_FILTER_OPERATION",p.length);if(l==="Flat"){let h=new Set(u?a.filterArr(c):a.filter(c));s[o]=ve(s[o],h);continue}if(l==="AVL"){let h=p[0],g=c[h],f;switch(h){case"gt":{f=a.greaterThan(g,!1);break}case"gte":{f=a.greaterThan(g,!0);break}case"lt":{f=a.lessThan(g,!1);break}case"lte":{f=a.lessThan(g,!0);break}case"eq":{let y=a.find(g);f=y!=null?y:new Set;break}case"between":{let[y,d]=g;f=a.rangeSearch(y,d);break}default:throw _("INVALID_FILTER_OPERATION",h)}s[o]=ve(s[o],f)}}return Qe(...Object.values(s))}function Fr(t){return t.searchableProperties}function Vr(t){return t.searchablePropertiesWithTypes}function Wr(t,e){let{indexes:n,vectorIndexes:r,searchableProperties:i,searchablePropertiesWithTypes:s,frequencies:o,tokenOccurrences:c,avgFieldLength:a,fieldLengths:l}=e,u={},p={};for(let h of Object.keys(n)){let{node:g,type:f,isArray:y}=n[h];switch(f){case"Radix":u[h]={type:"Radix",node:be.fromJSON(g),isArray:y};break;case"Flat":u[h]={type:"Flat",node:De.fromJSON(g),isArray:y};break;case"AVL":u[h]={type:"AVL",node:Ae.fromJSON(g),isArray:y};break;case"BKD":u[h]={type:"BKD",node:X.fromJSON(g),isArray:y};break;case"Bool":u[h]={type:"Bool",node:Ue.fromJSON(g),isArray:y};break;default:u[h]=n[h]}}for(let h of Object.keys(r))p[h]={type:"Vector",isArray:!1,node:ze.fromJSON(r[h])};return{sharedInternalDocumentStore:t,indexes:u,vectorIndexes:p,searchableProperties:i,searchablePropertiesWithTypes:s,frequencies:o,tokenOccurrences:c,avgFieldLength:a,fieldLengths:l}}function $r(t){let{indexes:e,vectorIndexes:n,searchableProperties:r,searchablePropertiesWithTypes:i,frequencies:s,tokenOccurrences:o,avgFieldLength:c,fieldLengths:a}=t,l={};for(let p of Object.keys(n))l[p]=n[p].node.toJSON();let u={};for(let p of Object.keys(e)){let{type:h,node:g,isArray:f}=e[p];h==="Flat"||h==="Radix"||h==="AVL"||h==="BKD"||h==="Bool"?u[p]={type:h,node:g.toJSON(),isArray:f}:(u[p]=e[p],u[p].node=u[p].node.toJSON())}return{indexes:u,vectorIndexes:l,searchableProperties:r,searchablePropertiesWithTypes:i,frequencies:s,tokenOccurrences:o,avgFieldLength:c,fieldLengths:a}}function sn(){return{create:nn,insert:Br,remove:Cr,insertDocumentScoreParameters:Nr,insertTokenScoreParameters:Rr,removeDocumentScoreParameters:Pr,removeTokenScoreParameters:Mr,calculateResultScores:rn,search:Lr,searchByWhereClause:et,getSearchableProperties:Fr,getSearchablePropertiesWithTypes:Vr,load:Wr,save:$r}}function Or(t,e){t||(t=new Set);let n=e.length;for(let r=0;r<n;r++){let i=e[r].docIDs,s=i.length;for(let o=0;o<s;o++)t.add(i[o])}return t}function _r(t,e,n=!1){let r=n?X.vincentyDistance:X.haversineDistance,i=[],s=[];for(let{point:a}of t)s.push(r(e,a));let o=Math.max(...s),c=0;for(let{docIDs:a}of t){let l=s[c],u=o-l+1;for(let p of a)i.push([p,u]);c++}return i.sort((a,l)=>l[1]-a[1]),i}function Cs(t,e){let n=Object.keys(t);if(n.length!==1)return{isGeoOnly:!1};let r=n[0],i=t[r];if(typeof e.indexes[r]=="undefined")return{isGeoOnly:!1};let{type:s}=e.indexes[r];return s==="BKD"&&i&&("radius"in i||"polygon"in i)?{isGeoOnly:!0,geoProperty:r,geoOperation:i}:{isGeoOnly:!1}}function on(t,e){let n=t,r=Cs(e,n);if(!r.isGeoOnly||!r.geoProperty||!r.geoOperation)return null;let{node:i}=n.indexes[r.geoProperty],s=r.geoOperation,o=i,c;if("radius"in s){let{value:a,coordinates:l,unit:u="m",inside:p=!0,highPrecision:h=!1}=s.radius,g=l,f=Ze(a,u);return c=o.searchByRadius(g,f,p,"asc",h),_r(c,g,h)}else if("polygon"in s){let{coordinates:a,inside:l=!0,highPrecision:u=!1}=s.polygon;c=o.searchByPolygon(a,l,"asc",u);let p=X.calculatePolygonCentroid(a);return _r(c,p,u)}return null}function Ls(t,e){t||(t=new Set);let n=Object.keys(e),r=n.length;for(let i=0;i<r;i++){let s=e[n[i]],o=s.length;for(let c=0;c<o;c++)t.add(s[c])}return t}var Dt={};Ee(Dt,{createSorter:()=>an,load:()=>Gr,save:()=>Hr});function Yr(t,e,n,r,i){let s={language:t.tokenizer.language,sharedInternalDocumentStore:e,enabled:!0,isSorted:!0,sortableProperties:[],sortablePropertiesWithTypes:{},sorts:{}};for(let[o,c]of Object.entries(n)){let a=`${i}${i?".":""}${o}`;if(!r.includes(a)){if(typeof c=="object"&&!Array.isArray(c)){let l=Yr(t,e,c,r,a);Re(s.sortableProperties,l.sortableProperties),s.sorts={...s.sorts,...l.sorts},s.sortablePropertiesWithTypes={...s.sortablePropertiesWithTypes,...l.sortablePropertiesWithTypes};continue}if(!fe(c))switch(c){case"boolean":case"number":case"string":s.sortableProperties.push(a),s.sortablePropertiesWithTypes[a]=c,s.sorts[a]={docs:new Map,orderedDocsToRemove:new Map,orderedDocs:[],type:c};break;case"geopoint":case"enum":continue;case"enum[]":case"boolean[]":case"number[]":case"string[]":continue;default:throw _("INVALID_SORT_SCHEMA_TYPE",Array.isArray(c)?"array":c,a)}}}return s}function Fs(t,e,n,r){return(r==null?void 0:r.enabled)!==!1?Yr(t,e,n,(r||{}).unsortableProperties||[],""):{disabled:!0}}function Vs(t,e,n,r){if(!t.enabled)return;t.isSorted=!1;let i=V(t.sharedInternalDocumentStore,n),s=t.sorts[e];s.orderedDocsToRemove.has(i)&&cn(t,e),s.docs.set(i,s.orderedDocs.length),s.orderedDocs.push([i,r])}function jr(t){if(t.isSorted||!t.enabled)return;let e=Object.keys(t.sorts);for(let n of e)js(t,n);t.isSorted=!0}function Ws(t,e,n){return e[1].localeCompare(n[1],er(t))}function $s(t,e){return t[1]-e[1]}function Ys(t,e){return e[1]?-1:1}function js(t,e){let n=t.sorts[e],r;switch(n.type){case"string":r=Ws.bind(null,t.language);break;case"number":r=$s.bind(null);break;case"boolean":r=Ys.bind(null);break}n.orderedDocs.sort(r);let i=n.orderedDocs.length;for(let s=0;s<i;s++){let o=n.orderedDocs[s][0];n.docs.set(o,s)}}function Gs(t){let e=Object.keys(t.sorts);for(let n of e)cn(t,n)}function cn(t,e){let n=t.sorts[e];n.orderedDocsToRemove.size&&(n.orderedDocs=n.orderedDocs.filter(r=>!n.orderedDocsToRemove.has(r[0])),n.orderedDocsToRemove.clear())}function Hs(t,e,n){if(!t.enabled)return;let r=t.sorts[e],i=V(t.sharedInternalDocumentStore,n);r.docs.get(i)&&(r.docs.delete(i),r.orderedDocsToRemove.set(i,!0))}function Ks(t,e,n){if(!t.enabled)throw _("SORT_DISABLED");let r=n.property,i=n.order==="DESC",s=t.sorts[r];if(!s)throw _("UNABLE_TO_SORT_ON_UNKNOWN_FIELD",r,t.sortableProperties.join(", "));return cn(t,r),jr(t),e.sort((o,c)=>{let a=s.docs.get(V(t.sharedInternalDocumentStore,o[0])),l=s.docs.get(V(t.sharedInternalDocumentStore,c[0])),u=typeof a!="undefined",p=typeof l!="undefined";return!u&&!p?0:u?p?i?l-a:a-l:-1:1}),e}function qs(t){return t.enabled?t.sortableProperties:[]}function Js(t){return t.enabled?t.sortablePropertiesWithTypes:{}}function Gr(t,e){let n=e;if(!n.enabled)return{enabled:!1};let r=Object.keys(n.sorts).reduce((i,s)=>{let{docs:o,orderedDocs:c,type:a}=n.sorts[s];return i[s]={docs:new Map(Object.entries(o).map(([l,u])=>[+l,u])),orderedDocsToRemove:new Map,orderedDocs:c,type:a},i},{});return{sharedInternalDocumentStore:t,language:n.language,sortableProperties:n.sortableProperties,sortablePropertiesWithTypes:n.sortablePropertiesWithTypes,sorts:r,enabled:!0,isSorted:n.isSorted}}function Hr(t){if(!t.enabled)return{enabled:!1};Gs(t),jr(t);let e=Object.keys(t.sorts).reduce((n,r)=>{let{docs:i,orderedDocs:s,type:o}=t.sorts[r];return n[r]={docs:Object.fromEntries(i.entries()),orderedDocs:s,type:o},n},{});return{language:t.language,sortableProperties:t.sortableProperties,sortablePropertiesWithTypes:t.sortablePropertiesWithTypes,sorts:e,enabled:t.enabled,isSorted:t.isSorted}}function an(){return{create:Fs,insert:Vs,remove:Hs,save:Hr,load:Gr,sortBy:Ks,getSortableProperties:qs,getSortablePropertiesWithTypes:Js}}var Ot={};Ee(Ot,{createTokenizer:()=>zt,normalizeToken:()=>nt});var Xs=[65,65,65,65,65,65,65,67,69,69,69,69,73,73,73,73,69,78,79,79,79,79,79,null,79,85,85,85,85,89,80,115,97,97,97,97,97,97,97,99,101,101,101,101,105,105,105,105,101,110,111,111,111,111,111,null,111,117,117,117,117,121,112,121,65,97,65,97,65,97,67,99,67,99,67,99,67,99,68,100,68,100,69,101,69,101,69,101,69,101,69,101,71,103,71,103,71,103,71,103,72,104,72,104,73,105,73,105,73,105,73,105,73,105,73,105,74,106,75,107,107,76,108,76,108,76,108,76,108,76,108,78,110,78,110,78,110,110,78,110,79,111,79,111,79,111,79,111,82,114,82,114,82,114,83,115,83,115,83,115,83,115,84,116,84,116,84,116,85,117,85,117,85,117,85,117,85,117,85,117,87,119,89,121,89,90,122,90,122,90,122,115];function Zs(t){return t<192||t>383?t:Xs[t-192]||t}function Kr(t){let e=[];for(let n=0;n<t.length;n++)e[n]=Zs(t.charCodeAt(n));return String.fromCharCode(...e)}var Qs={ational:"ate",tional:"tion",enci:"ence",anci:"ance",izer:"ize",bli:"ble",alli:"al",entli:"ent",eli:"e",ousli:"ous",ization:"ize",ation:"ate",ator:"ate",alism:"al",iveness:"ive",fulness:"ful",ousness:"ous",aliti:"al",iviti:"ive",biliti:"ble",logi:"log"},eo={icate:"ic",ative:"",alize:"al",iciti:"ic",ical:"ic",ful:"",ness:""},to="[^aeiou]",Ut="[aeiouy]",de=to+"[^aeiouy]*",tt=Ut+"[aeiou]*",ln="^("+de+")?"+tt+de,no="^("+de+")?"+tt+de+"("+tt+")?$",bt="^("+de+")?"+tt+de+tt+de,qr="^("+de+")?"+Ut;function Jr(t){var a,l;let e,n,r,i,s,o;if(t.length<3)return t;let c=t.substring(0,1);if(c=="y"&&(t=c.toUpperCase()+t.substring(1)),r=/^(.+?)(ss|i)es$/,i=/^(.+?)([^s])s$/,r.test(t)?t=t.replace(r,"$1$2"):i.test(t)&&(t=t.replace(i,"$1$2")),r=/^(.+?)eed$/,i=/^(.+?)(ed|ing)$/,r.test(t)){let u=r.exec(t);r=new RegExp(ln),r.test(u[1])&&(r=/.$/,t=t.replace(r,""))}else i.test(t)&&(e=i.exec(t)[1],i=new RegExp(qr),i.test(e)&&(t=e,i=/(at|bl|iz)$/,s=new RegExp("([^aeiouylsz])\\1$"),o=new RegExp("^"+de+Ut+"[^aeiouwxy]$"),i.test(t)?t=t+"e":s.test(t)?(r=/.$/,t=t.replace(r,"")):o.test(t)&&(t=t+"e")));if(r=/^(.+?)y$/,r.test(t)){let u=r.exec(t);e=u==null?void 0:u[1],r=new RegExp(qr),e&&r.test(e)&&(t=e+"i")}if(r=/^(.+?)(ational|tional|enci|anci|izer|bli|alli|entli|eli|ousli|ization|ation|ator|alism|iveness|fulness|ousness|aliti|iviti|biliti|logi)$/,r.test(t)){let u=r.exec(t);e=u==null?void 0:u[1],n=u==null?void 0:u[2],r=new RegExp(ln),e&&r.test(e)&&(t=e+Qs[n])}if(r=/^(.+?)(icate|ative|alize|iciti|ical|ful|ness)$/,r.test(t)){let u=r.exec(t);e=u==null?void 0:u[1],n=u==null?void 0:u[2],r=new RegExp(ln),e&&r.test(e)&&(t=e+eo[n])}if(r=/^(.+?)(al|ance|ence|er|ic|able|ible|ant|ement|ment|ent|ou|ism|ate|iti|ous|ive|ize)$/,i=/^(.+?)(s|t)(ion)$/,r.test(t)){let u=r.exec(t);e=u==null?void 0:u[1],r=new RegExp(bt),e&&r.test(e)&&(t=e)}else if(i.test(t)){let u=i.exec(t);e=(l=(a=u==null?void 0:u[1])!=null?a:""+(u==null?void 0:u[2]))!=null?l:"",i=new RegExp(bt),i.test(e)&&(t=e)}if(r=/^(.+?)e$/,r.test(t)){let u=r.exec(t);e=u==null?void 0:u[1],r=new RegExp(bt),i=new RegExp(no),s=new RegExp("^"+de+Ut+"[^aeiouwxy]$"),e&&(r.test(e)||i.test(e)&&!s.test(e))&&(t=e)}return r=/ll$/,i=new RegExp(bt),r.test(t)&&i.test(t)&&(r=/.$/,t=t.replace(r,"")),c=="y"&&(t=c.toLowerCase()+t.substring(1)),t}function nt(t,e,n=!0){var i;let r=`${this.language}:${t}:${e}`;return n&&this.normalizationCache.has(r)?this.normalizationCache.get(r):(i=this.stopWords)!=null&&i.includes(e)?(n&&this.normalizationCache.set(r,""),""):(this.stemmer&&!this.stemmerSkipProperties.has(t)&&(e=this.stemmer(e)),e=Kr(e),n&&this.normalizationCache.set(r,e),e)}function ro(t){for(;t[t.length-1]==="";)t.pop();for(;t[0]==="";)t.shift();return t}function Xr(t,e,n,r=!0){if(e&&e!==this.language)throw _("LANGUAGE_NOT_SUPPORTED",e);if(typeof t!="string")return[t];let i=this.normalizeToken.bind(this,n!=null?n:""),s;if(n&&this.tokenizeSkipProperties.has(n))s=[i(t,r)];else{let c=Qn[this.language];s=t.toLowerCase().split(c).map(a=>i(a,r)).filter(Boolean)}let o=ro(s);return this.allowDuplicates?o:Array.from(new Set(o))}function zt(t={}){if(!t.language)t.language="english";else if(!Je.includes(t.language))throw _("LANGUAGE_NOT_SUPPORTED",t.language);let e;if(t.stemming||t.stemmer&&!("stemming"in t))if(t.stemmer){if(typeof t.stemmer!="function")throw _("INVALID_STEMMER_FUNCTION_TYPE");e=t.stemmer}else if(t.language==="english")e=Jr;else throw _("MISSING_STEMMER",t.language);let n;if(t.stopWords!==!1){if(n=[],Array.isArray(t.stopWords))n=t.stopWords;else if(typeof t.stopWords=="function")n=t.stopWords(n);else if(t.stopWords)throw _("CUSTOM_STOP_WORDS_MUST_BE_FUNCTION_OR_ARRAY");if(!Array.isArray(n))throw _("CUSTOM_STOP_WORDS_MUST_BE_FUNCTION_OR_ARRAY");for(let i of n)if(typeof i!="string")throw _("CUSTOM_STOP_WORDS_MUST_BE_FUNCTION_OR_ARRAY")}let r={tokenize:Xr,language:t.language,stemmer:e,stemmerSkipProperties:new Set(t.stemmerSkipProperties?[t.stemmerSkipProperties].flat():[]),tokenizeSkipProperties:new Set(t.tokenizeSkipProperties?[t.tokenizeSkipProperties].flat():[]),stopWords:n,allowDuplicates:Boolean(t.allowDuplicates),normalizeToken:nt,normalizationCache:new Map};return r.tokenize=Xr.bind(r),r.normalizeToken=nt,r}function io(t){return{sharedInternalDocumentStore:t,rules:new Map}}function so(t,e){if(t.rules.has(e.id))throw new Error(`PINNING_RULE_ALREADY_EXISTS: A pinning rule with id "${e.id}" already exists. Use updateRule to modify it.`);t.rules.set(e.id,e)}function oo(t,e){if(!t.rules.has(e.id))throw new Error(`PINNING_RULE_NOT_FOUND: Cannot update pinning rule with id "${e.id}" because it does not exist. Use addRule to create it.`);t.rules.set(e.id,e)}function co(t,e){return t.rules.delete(e)}function ao(t,e){return t.rules.get(e)}function lo(t){return Array.from(t.rules.values())}function fo(t,e){let n=t.toLowerCase().trim(),r=e.pattern.toLowerCase().trim();switch(e.anchoring){case"is":return n===r;case"starts_with":return n.startsWith(r);case"contains":return n.includes(r);default:return!1}}function uo(t,e){return t?e.conditions.every(n=>fo(t,n)):!1}function fn(t,e){if(!e)return[];let n=[];for(let r of t.rules.values())uo(e,r)&&n.push(r);return n}function ho(t,e){var r;let n=e;return{sharedInternalDocumentStore:t,rules:new Map((r=n==null?void 0:n.rules)!=null?r:[])}}function po(t){return{rules:Array.from(t.rules.entries())}}function Zr(){return{create:io,addRule:so,updateRule:oo,removeRule:co,getRule:ao,getAllRules:lo,getMatchingRules:fn,load:ho,save:po}}function go(t){let e={formatElapsedTime:qt,getDocumentIndexId:Jt,getDocumentProperties:Xe,validateSchema:wt};for(let n of en){let r=n;if(t[r]){if(typeof t[r]!="function")throw _("COMPONENT_MUST_BE_FUNCTION",r)}else t[r]=e[r]}for(let n of Object.keys(t))if(!vr.includes(n)&&!en.includes(n))throw _("UNSUPPORTED_COMPONENT",n)}function rt({schema:t,sort:e,language:n,components:r,id:i,plugins:s}){var m;r||(r={});for(let v of s!=null?s:[]){if(!("getComponents"in v)||typeof v.getComponents!="function")continue;let E=v.getComponents(t),x=Object.keys(E);for(let b of x)if(r[b])throw _("PLUGIN_COMPONENT_CONFLICT",b,v.name);r={...r,...E}}i||(i=Pe());let o=r.tokenizer,c=r.index,a=r.documentsStore,l=r.sorter,u=r.pinning;if(o?o.tokenize?o=o:o=zt(o):o=zt({language:n!=null?n:"english"}),r.tokenizer&&n)throw _("NO_LANGUAGE_WITH_CUSTOM_TOKENIZER");let p=Zt();c||(c=sn()),l||(l=an()),a||(a=Qt()),u||(u=Zr()),go(r);let{getDocumentProperties:h,getDocumentIndexId:g,validateSchema:f,formatElapsedTime:y}=r,d={data:{},caches:{},schema:t,tokenizer:o,index:c,sorter:l,documentsStore:a,pinning:u,internalDocumentIDStore:p,getDocumentProperties:h,getDocumentIndexId:g,validateSchema:f,beforeInsert:[],afterInsert:[],beforeRemove:[],afterRemove:[],beforeUpdate:[],afterUpdate:[],beforeUpsert:[],afterUpsert:[],beforeSearch:[],afterSearch:[],beforeInsertMultiple:[],afterInsertMultiple:[],beforeRemoveMultiple:[],afterRemoveMultiple:[],beforeUpdateMultiple:[],afterUpdateMultiple:[],beforeUpsertMultiple:[],afterUpsertMultiple:[],afterCreate:[],formatElapsedTime:y,id:i,plugins:s,version:yo()};d.data={index:d.index.create(d,p,t),docs:d.documentsStore.create(d,p),sorting:d.sorter.create(d,p,t,e),pinning:d.pinning.create(p)};for(let v of Ir)d[v]=((m=d[v])!=null?m:[]).concat(Er(d,v));let S=d.afterCreate;return S&&Tr(S,d),d}function yo(){return"{{VERSION}}"}function un(t){return t.documentsStore.count(t.data.docs)}var dn={};Ee(dn,{documentsStore:()=>Tt,formatElapsedTime:()=>qt,getDocumentIndexId:()=>Jt,getDocumentProperties:()=>Xe,getInnerType:()=>It,getVectorSize:()=>Et,index:()=>At,internalDocumentIDStore:()=>vt,isArrayType:()=>Te,isGeoPointType:()=>Xt,isVectorType:()=>fe,sorter:()=>Dt,tokenizer:()=>Ot,validateSchema:()=>wt});function Ce(t,e,n,r,i){let s=t.validateSchema(e,t.schema);if(s)throw _("SCHEMA_VALIDATION_FAILURE",s);return H(t.beforeInsert)||H(t.afterInsert)||H(t.index.beforeInsert)||H(t.index.insert)||H(t.index.afterInsert)?xo(t,e,n,r,i):wo(t,e,n,r,i)}var mo=new Set(["enum","enum[]"]),So=new Set(["string","number"]);async function xo(t,e,n,r,i){let{index:s,docs:o}=t.data,c=t.getDocumentIndexId(e);if(typeof c!="string")throw _("DOCUMENT_ID_MUST_BE_STRING",typeof c);let a=V(t.internalDocumentIDStore,c);if(r||await se(t.beforeInsert,t,c,e),!t.documentsStore.store(o,c,a,e))throw _("DOCUMENT_ALREADY_EXISTS",c);let l=t.documentsStore.count(o),u=t.index.getSearchableProperties(s),p=t.index.getSearchablePropertiesWithTypes(s),h=t.getDocumentProperties(e,u);for(let[g,f]of Object.entries(h)){if(typeof f=="undefined")continue;let y=typeof f,d=p[g];Qr(y,d,g,f)}return await Io(t,c,u,h,l,n,e,i),r||await se(t.afterInsert,t,c,e),c}function wo(t,e,n,r,i){let{index:s,docs:o}=t.data,c=t.getDocumentIndexId(e);if(typeof c!="string")throw _("DOCUMENT_ID_MUST_BE_STRING",typeof c);let a=V(t.internalDocumentIDStore,c);if(r||se(t.beforeInsert,t,c,e),!t.documentsStore.store(o,c,a,e))throw _("DOCUMENT_ALREADY_EXISTS",c);let l=t.documentsStore.count(o),u=t.index.getSearchableProperties(s),p=t.index.getSearchablePropertiesWithTypes(s),h=t.getDocumentProperties(e,u);for(let[g,f]of Object.entries(h)){if(typeof f=="undefined")continue;let y=typeof f,d=p[g];Qr(y,d,g,f)}return Eo(t,c,u,h,l,n,e,i),r||se(t.afterInsert,t,c,e),c}function Qr(t,e,n,r){if(!(Xt(e)&&typeof r=="object"&&typeof r.lon=="number"&&typeof r.lat=="number")&&!(fe(e)&&Array.isArray(r))&&!(Te(e)&&Array.isArray(r))&&!(mo.has(e)&&So.has(t))&&t!==e)throw _("INVALID_DOCUMENT_PROPERTY",n,e,t)}async function Io(t,e,n,r,i,s,o,c){var u,p,h,g;for(let f of n){let y=r[f];if(typeof y=="undefined")continue;let d=t.index.getSearchablePropertiesWithTypes(t.data.index)[f];await((p=(u=t.index).beforeInsert)==null?void 0:p.call(u,t.data.index,f,e,y,d,s,t.tokenizer,i));let S=t.internalDocumentIDStore.idToInternalId.get(e);await t.index.insert(t.index,t.data.index,f,e,S,y,d,s,t.tokenizer,i,c),await((g=(h=t.index).afterInsert)==null?void 0:g.call(h,t.data.index,f,e,y,d,s,t.tokenizer,i))}let a=t.sorter.getSortableProperties(t.data.sorting),l=t.getDocumentProperties(o,a);for(let f of a){let y=l[f];if(typeof y=="undefined")continue;let d=t.sorter.getSortablePropertiesWithTypes(t.data.sorting)[f];t.sorter.insert(t.data.sorting,f,e,y,d,s)}}function Eo(t,e,n,r,i,s,o,c){var u,p,h,g;for(let f of n){let y=r[f];if(typeof y=="undefined")continue;let d=t.index.getSearchablePropertiesWithTypes(t.data.index)[f],S=V(t.internalDocumentIDStore,e);(p=(u=t.index).beforeInsert)==null||p.call(u,t.data.index,f,e,y,d,s,t.tokenizer,i),t.index.insert(t.index,t.data.index,f,e,S,y,d,s,t.tokenizer,i,c),(g=(h=t.index).afterInsert)==null||g.call(h,t.data.index,f,e,y,d,s,t.tokenizer,i)}let a=t.sorter.getSortableProperties(t.data.sorting),l=t.getDocumentProperties(o,a);for(let f of a){let y=l[f];if(typeof y=="undefined")continue;let d=t.sorter.getSortablePropertiesWithTypes(t.data.sorting)[f];t.sorter.insert(t.data.sorting,f,e,y,d,s)}}function _t(t,e,n,r){return H(t.index.beforeRemove)||H(t.index.remove)||H(t.index.afterRemove)?vo(t,e,n,r):To(t,e,n,r)}async function vo(t,e,n,r){var d,S,m,v;let i=!0,{index:s,docs:o}=t.data,c=t.documentsStore.get(o,e);if(!c)return!1;let a=V(t.internalDocumentIDStore,e),l=ce(t.internalDocumentIDStore,a),u=t.documentsStore.count(o);r||await se(t.beforeRemove,t,l);let p=t.index.getSearchableProperties(s),h=t.index.getSearchablePropertiesWithTypes(s),g=t.getDocumentProperties(c,p);for(let E of p){let x=g[E];if(typeof x=="undefined")continue;let b=h[E];await((S=(d=t.index).beforeRemove)==null?void 0:S.call(d,t.data.index,E,l,x,b,n,t.tokenizer,u)),await t.index.remove(t.index,t.data.index,E,e,a,x,b,n,t.tokenizer,u)||(i=!1),await((v=(m=t.index).afterRemove)==null?void 0:v.call(m,t.data.index,E,l,x,b,n,t.tokenizer,u))}let f=await t.sorter.getSortableProperties(t.data.sorting),y=await t.getDocumentProperties(c,f);for(let E of f)typeof y[E]!="undefined"&&t.sorter.remove(t.data.sorting,E,e);return r||await se(t.afterRemove,t,l),t.documentsStore.remove(t.data.docs,e,a),i}function To(t,e,n,r){var d,S,m,v;let i=!0,{index:s,docs:o}=t.data,c=t.documentsStore.get(o,e);if(!c)return!1;let a=V(t.internalDocumentIDStore,e),l=ce(t.internalDocumentIDStore,a),u=t.documentsStore.count(o);r||se(t.beforeRemove,t,l);let p=t.index.getSearchableProperties(s),h=t.index.getSearchablePropertiesWithTypes(s),g=t.getDocumentProperties(c,p);for(let E of p){let x=g[E];if(typeof x=="undefined")continue;let b=h[E];(S=(d=t.index).beforeRemove)==null||S.call(d,t.data.index,E,l,x,b,n,t.tokenizer,u),t.index.remove(t.index,t.data.index,E,e,a,x,b,n,t.tokenizer,u)||(i=!1),(v=(m=t.index).afterRemove)==null||v.call(m,t.data.index,E,l,x,b,n,t.tokenizer,u)}let f=t.sorter.getSortableProperties(t.data.sorting),y=t.getDocumentProperties(c,f);for(let E of f)typeof y[E]!="undefined"&&t.sorter.remove(t.data.sorting,E,e);return r||se(t.afterRemove,t,l),t.documentsStore.remove(t.data.docs,e,a),i}var Nt="fulltext",pn="hybrid",gn="vector";function Ao(t,e){return t[1]-e[1]}function Do(t,e){return e[1]-t[1]}function bo(t="desc"){return t.toLowerCase()==="asc"?Ao:Do}function Le(t,e,n){var l,u;let r={},i=e.map(([p])=>p),s=t.documentsStore.getMultiple(t.data.docs,i),o=Object.keys(n),c=t.index.getSearchablePropertiesWithTypes(t.data.index);for(let p of o){let h;if(c[p]==="number"){let{ranges:g}=n[p],f=g.length,y=Array.from({length:f});for(let d=0;d<f;d++){let S=g[d];y[d]=[`${S.from}-${S.to}`,0]}h=Object.fromEntries(y)}r[p]={count:0,values:h!=null?h:{}}}let a=s.length;for(let p=0;p<a;p++){let h=s[p];for(let g of o){let f=g.includes(".")?Me(h,g):h[g],y=c[g],d=r[g].values;switch(y){case"number":{let S=n[g].ranges;ei(S,d)(f);break}case"number[]":{let S=new Set,m=n[g].ranges,v=ei(m,d,S);for(let E of f)v(E);break}case"boolean":case"enum":case"string":{ti(d,y)(f);break}case"boolean[]":case"enum[]":case"string[]":{let v=ti(d,y==="boolean[]"?"boolean":"string",new Set);for(let E of f)v(E);break}default:throw _("FACET_NOT_SUPPORTED",y)}}}for(let p of o){let h=r[p];if(h.count=Object.keys(h.values).length,c[p]==="string"){let g=n[p],f=bo(g.sort);h.values=Object.fromEntries(Object.entries(h.values).sort(f).slice((l=g.offset)!=null?l:0,(u=g.limit)!=null?u:10))}}return r}function ei(t,e,n){return r=>{for(let i of t){let s=`${i.from}-${i.to}`;n!=null&&n.has(s)||r>=i.from&&r<=i.to&&(e[s]===void 0?e[s]=1:(e[s]++,n==null||n.add(s)))}}}function ti(t,e,n){let r=e==="boolean"?"false":"";return i=>{var o,c;let s=(o=i==null?void 0:i.toString())!=null?o:r;n!=null&&n.has(s)||(t[s]=((c=t[s])!=null?c:0)+1,n==null||n.add(s))}}var Uo={reducer:(t,e,n,r)=>(e[r]=n,e),getInitialValue:t=>Array.from({length:t})},ni=["string","number","boolean"];function Fe(t,e,n){var S;let r=n.properties,i=r.length,s=t.index.getSearchablePropertiesWithTypes(t.data.index);for(let m=0;m<i;m++){let v=r[m];if(typeof s[v]=="undefined")throw _("UNKNOWN_GROUP_BY_PROPERTY",v);if(!ni.includes(s[v]))throw _("INVALID_GROUP_BY_PROPERTY",v,ni.join(", "),s[v])}let o=e.map(([m])=>ce(t.internalDocumentIDStore,m)),c=t.documentsStore.getMultiple(t.data.docs,o),a=c.length,l=n.maxResult||Number.MAX_SAFE_INTEGER,u=[],p={};for(let m=0;m<i;m++){let v=r[m],E={property:v,perValue:{}},x=new Set;for(let b=0;b<a;b++){let w=c[b],T=Me(w,v);if(typeof T=="undefined")continue;let O=typeof T!="boolean"?T:""+T,A=(S=E.perValue[O])!=null?S:{indexes:[],count:0};A.count>=l||(A.indexes.push(b),A.count++,E.perValue[O]=A,x.add(T))}u.push(Array.from(x)),p[v]=E}let h=ri(u),g=h.length,f=[];for(let m=0;m<g;m++){let v=h[m],E=v.length,x={values:[],indexes:[]},b=[];for(let w=0;w<E;w++){let T=v[w],O=r[w];b.push(p[O].perValue[typeof T!="boolean"?T:""+T].indexes),x.values.push(T)}x.indexes=lr(b).sort((w,T)=>w-T),x.indexes.length!==0&&f.push(x)}let y=f.length,d=Array.from({length:y});for(let m=0;m<y;m++){let v=f[m],E=n.reduce||Uo,x=v.indexes.map(O=>({id:o[O],score:e[O][1],document:c[O]})),b=E.reducer.bind(null,v.values),w=E.getInitialValue(v.indexes.length),T=x.reduce(b,w);d[m]={values:v.values,result:T}}return d}function ri(t,e=0){if(e+1===t.length)return t[e].map(s=>[s]);let n=t[e],r=ri(t,e+1),i=[];for(let s of n)for(let o of r){let c=[s];Re(c,o),i.push(c)}return i}function Ve(t,e,n,r){let i=fn(e,r);if(i.length===0)return n;let s=i.flatMap(d=>d.consequence.promote);s.sort((d,S)=>d.position-S.position);let o=new Set,c=new Map,a=new Set;for(let d of s){let S=V(t.internalDocumentIDStore,d.doc_id);if(S!==void 0){if(c.has(S)){let m=c.get(S);d.position<m&&c.set(S,d.position);continue}a.has(d.position)||(o.add(S),c.set(S,d.position),a.add(d.position))}}if(c.size===0)return n;let l=n.filter(([d])=>!o.has(d)),u=1e6,p=[];for(let[d,S]of c.entries())n.find(([v])=>v===d)?p.push([d,u-S]):t.documentsStore.get(t.data.docs,d)&&p.push([d,0]);p.sort((d,S)=>{var E,x;let m=(E=c.get(d[0]))!=null?E:1/0,v=(x=c.get(S[0]))!=null?x:1/0;return m-v});let h=[],g=new Map;for(let d of p){let S=c.get(d[0]);g.set(S,d)}let f=0,y=0;for(;y<l.length+p.length;)if(g.has(y))h.push(g.get(y)),y++;else if(f<l.length)h.push(l[f]),f++,y++;else break;for(let[d,S]of g.entries())d>=h.length&&h.push(S);return h}function mn(t,e,n){var p;let{term:r,properties:i}=e,s=t.data.index,o=t.caches.propertiesToSearch;if(!o){let h=t.index.getSearchablePropertiesWithTypes(s);o=t.index.getSearchableProperties(s),o=o.filter(g=>h[g].startsWith("string")),t.caches.propertiesToSearch=o}if(i&&i!=="*"){for(let h of i)if(!o.includes(h))throw _("UNKNOWN_INDEX",h,o.join(", "));o=o.filter(h=>i.includes(h))}let c=Object.keys((p=e.where)!=null?p:{}).length>0,a;c&&(a=t.index.searchByWhereClause(s,t.tokenizer,e.where,n));let l,u=e.threshold!==void 0&&e.threshold!==null?e.threshold:1;if(r||i){let h=un(t);if(l=t.index.search(s,r||"",t.tokenizer,n,o,e.exact||!1,e.tolerance||0,e.boost||{},_o(e.relevance),h,a,u),e.exact&&r){let g=r.trim().split(/\s+/);l=l.filter(([f])=>{let y=t.documentsStore.get(t.data.docs,f);if(!y)return!1;for(let d of o){let S=Oo(y,d);if(typeof S=="string"&&g.every(v=>new RegExp(`\\b${zo(v)}\\b`).test(S)))return!0}return!1})}}else if(c){let h=on(s,e.where);h?l=h:l=(a?Array.from(a):[]).map(f=>[+f,0])}else l=Object.keys(t.documentsStore.getAll(t.data.docs)).map(g=>[+g,0]);return l}function zo(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function Oo(t,e){let n=e.split("."),r=t;for(let i of n)if(r&&typeof r=="object"&&i in r)r=r[i];else return;return r}function ii(t,e,n){var c,a;let r=oe();function i(){let l=Object.keys(t.data.index.vectorIndexes),u=e.facets&&Object.keys(e.facets).length>0,{limit:p=10,offset:h=0,distinctOn:g,includeVectors:f=!1}=e,y=e.preflight===!0,d=mn(t,e,n);if(e.sortBy)if(typeof e.sortBy=="function"){let v=d.map(([b])=>b),x=t.documentsStore.getMultiple(t.data.docs,v).map((b,w)=>[d[w][0],d[w][1],b]);x.sort(e.sortBy),d=x.map(([b,w])=>[b,w])}else d=t.sorter.sortBy(t.data.sorting,d,e.sortBy).map(([v,E])=>[V(t.internalDocumentIDStore,v),E]);else d=d.sort(mt);d=Ve(t,t.data.pinning,d,e.term);let S;y||(S=g?si(t,d,h,p,g):Rt(t,d,h,p));let m={elapsed:{formatted:"",raw:0},hits:[],count:d.length};if(typeof S!="undefined"&&(m.hits=S.filter(Boolean),f||St(m,l)),u){let v=Le(t,d,e.facets);m.facets=v}return e.groupBy&&(m.groups=Fe(t,d,e.groupBy)),m.elapsed=t.formatElapsedTime(oe()-r),m}async function s(){t.beforeSearch&&await ke(t.beforeSearch,t,e,n);let l=i();return t.afterSearch&&await Be(t.afterSearch,t,e,n,l),l}return((c=t.beforeSearch)==null?void 0:c.length)||((a=t.afterSearch)==null?void 0:a.length)?s():i()}var yn={k:1.2,b:.75,d:.5};function _o(t){var n,r,i;let e=t!=null?t:{};return e.k=(n=e.k)!=null?n:yn.k,e.b=(r=e.b)!=null?r:yn.b,e.d=(i=e.d)!=null?i:yn.d,e}function Sn(t,e,n){var l,u;let r=e.vector;if(r&&(!("value"in r)||!("property"in r)))throw _("INVALID_VECTOR_INPUT",Object.keys(r).join(", "));let i=t.data.index.vectorIndexes[r.property];if(!i)throw _("UNKNOWN_VECTOR_PROPERTY",r.property);let s=i.node.size;if((r==null?void 0:r.value.length)!==s)throw(r==null?void 0:r.property)===void 0||(r==null?void 0:r.value.length)===void 0?_("INVALID_INPUT_VECTOR","undefined",s,"undefined"):_("INVALID_INPUT_VECTOR",r.property,s,r.value.length);let o=t.data.index,c;return Object.keys((l=e.where)!=null?l:{}).length>0&&(c=t.index.searchByWhereClause(o,t.tokenizer,e.where,n)),i.node.find(r.value,(u=e.similarity)!=null?u:.8,c)}function We(t,e,n="english"){var c,a;let r=oe();function i(){var E,x,b;let l=Sn(t,e,n).sort(mt);l=Ve(t,t.data.pinning,l,void 0);let u=[];e.facets&&Object.keys(e.facets).length>0&&(u=Le(t,l,e.facets));let h=e.vector.property,g=(E=e.includeVectors)!=null?E:!1,f=(x=e.limit)!=null?x:10,y=(b=e.offset)!=null?b:0,d=Array.from({length:f});for(let w=0;w<f;w++){let T=l[w+y];if(!T)break;let O=t.data.docs.docs[T[0]];if(O){g||(O[h]=null);let A={id:ce(t.internalDocumentIDStore,T[0]),score:T[1],document:O};d[w]=A}}let S=[];e.groupBy&&(S=Fe(t,l,e.groupBy));let v=oe()-r;return{count:l.length,hits:d.filter(Boolean),elapsed:{raw:Number(v),formatted:ye(v)},...u?{facets:u}:{},...S?{groups:S}:{}}}async function s(){t.beforeSearch&&await ke(t.beforeSearch,t,e,n);let l=i();return t.afterSearch&&await Be(t.afterSearch,t,e,n,l),l}return((c=t.beforeSearch)==null?void 0:c.length)||((a=t.afterSearch)==null?void 0:a.length)?s():i()}function Ro(t,e,n){var o;let r=Po(mn(t,e,n)),i=Sn(t,e,n),s=e.hybridWeights;return Bo(r,i,(o=e.term)!=null?o:"",s)}function ci(t,e,n){var c,a;let r=oe();function i(){var v,E,x;let l=Ro(t,e,n);l=Ve(t,t.data.pinning,l,e.term);let u;e.facets&&Object.keys(e.facets).length>0&&(u=Le(t,l,e.facets));let h;e.groupBy&&(h=Fe(t,l,e.groupBy));let g=(v=e.offset)!=null?v:0,f=(E=e.limit)!=null?E:10,y=Rt(t,l,g,f).filter(Boolean),d=oe(),S={count:l.length,elapsed:{raw:Number(d-r),formatted:ye(d-r)},hits:y,...u?{facets:u}:{},...h?{groups:h}:{}};if(!((x=e.includeVectors)!=null?x:!1)){let b=Object.keys(t.data.index.vectorIndexes);St(S,b)}return S}async function s(){t.beforeSearch&&await ke(t.beforeSearch,t,e,n);let l=i();return t.afterSearch&&await Be(t.afterSearch,t,e,n,l),l}return((c=t.beforeSearch)==null?void 0:c.length)||((a=t.afterSearch)==null?void 0:a.length)?s():i()}function xn(t){return t[1]}function Po(t){let e=Math.max.apply(Math,t.map(xn));return t.map(([n,r])=>[n,r/e])}function oi(t,e){return t/e}function Mo(t,e){return(n,r)=>n*t+r*e}function Bo(t,e,n,r){var g;let i=Math.max.apply(Math,t.map(xn)),s=Math.max.apply(Math,e.map(xn)),o=r&&r.text&&r.vector,{text:c,vector:a}=o?r:ko(n),l=new Map,u=t.length,p=Mo(c,a);for(let f=0;f<u;f++){let[y,d]=t[f],S=oi(d,i),m=p(S,0);l.set(y,m)}let h=e.length;for(let f=0;f<h;f++){let[y,d]=e[f],S=oi(d,s),m=(g=l.get(y))!=null?g:0;l.set(y,m+p(0,S))}return[...l].sort((f,y)=>y[1]-f[1])}function ko(t){return{text:.5,vector:.5}}function ge(t,e,n){var i;let r=(i=e.mode)!=null?i:Nt;if(r===Nt)return ii(t,e,n);if(r===gn)return We(t,e);if(r===pn)return ci(t,e);throw _("INVALID_SEARCH_MODE",r)}function si(t,e,n,r,i){let s=t.data.docs,o=new Map,c=[],a=new Set,l=e.length,u=0;for(let p=0;p<l;p++){let h=e[p];if(typeof h=="undefined")continue;let[g,f]=h;if(a.has(g))continue;let y=t.documentsStore.get(s,g),d=Me(y,i);if(!(typeof d=="undefined"||o.has(d))&&(o.set(d,!0),u++,!(u<=n)&&(c.push({id:ce(t.internalDocumentIDStore,g),score:f,document:y}),a.add(g),u>=n+r)))break}return c}function Rt(t,e,n,r){let i=t.data.docs,s=Array.from({length:r}),o=new Set;for(let c=n;c<r+n;c++){let a=e[c];if(typeof a=="undefined")break;let[l,u]=a;if(!o.has(l)){let p=t.documentsStore.get(i,l);s[c]={id:ce(t.internalDocumentIDStore,l),score:u,document:p},o.add(l)}}return s}function wn(t,e){t.internalDocumentIDStore.load(t,e.internalDocumentIDStore),t.data.index=t.index.load(t.internalDocumentIDStore,e.index),t.data.docs=t.documentsStore.load(t.internalDocumentIDStore,e.docs),t.data.sorting=t.sorter.load(t.internalDocumentIDStore,e.sorting),t.data.pinning=t.pinning.load(t.internalDocumentIDStore,e.pinning),t.tokenizer.language=e.language}function it(t){return{internalDocumentIDStore:t.internalDocumentIDStore.save(t.internalDocumentIDStore),index:t.index.save(t.data.index),docs:t.documentsStore.save(t.data.docs),sorting:t.sorter.save(t.data.sorting),pinning:t.pinning.save(t.data.pinning),language:t.tokenizer.language}}var Ru=Symbol("orama.insertions"),Pu=Symbol("orama.removals");var In={};Ee(In,{boundedLevenshtein:()=>Dr,convertDistanceToMeters:()=>Ze,formatBytes:()=>ar,formatNanoseconds:()=>ye,getNanosecondsTime:()=>oe,normalizeToken:()=>nt,safeArrayPush:()=>Re,setDifference:()=>xt,setIntersection:()=>Qe,setUnion:()=>ve,uniqueId:()=>Pe});function ai(t=1536){return{filePath:"string",title:"string",content:"string",vector:`vector[${t}]`}}var li=1536;function fi(t){let e=t.length,n=0,r=0;for(;r<e;){let i=t.charCodeAt(r++);if(i&4294967168)if(!(i&4294965248))n+=2;else{if(i>=55296&&i<=56319&&r<e){let s=t.charCodeAt(r);(s&64512)===56320&&(++r,i=((i&1023)<<10)+(s&1023)+65536)}i&4294901760?n+=4:n+=3}else{n++;continue}}return n}function Wo(t,e,n){let r=t.length,i=n,s=0;for(;s<r;){let o=t.charCodeAt(s++);if(o&4294967168)if(!(o&4294965248))e[i++]=o>>6&31|192;else{if(o>=55296&&o<=56319&&s<r){let c=t.charCodeAt(s);(c&64512)===56320&&(++s,o=((o&1023)<<10)+(c&1023)+65536)}o&4294901760?(e[i++]=o>>18&7|240,e[i++]=o>>12&63|128,e[i++]=o>>6&63|128):(e[i++]=o>>12&15|224,e[i++]=o>>6&63|128)}else{e[i++]=o;continue}e[i++]=o&63|128}}var $o=new TextEncoder,Yo=50;function jo(t,e,n){$o.encodeInto(t,e.subarray(n))}function ui(t,e,n){t.length>Yo?jo(t,e,n):Wo(t,e,n)}var Go=4096;function En(t,e,n){let r=e,i=r+n,s=[],o="";for(;r<i;){let c=t[r++];if(!(c&128))s.push(c);else if((c&224)===192){let a=t[r++]&63;s.push((c&31)<<6|a)}else if((c&240)===224){let a=t[r++]&63,l=t[r++]&63;s.push((c&31)<<12|a<<6|l)}else if((c&248)===240){let a=t[r++]&63,l=t[r++]&63,u=t[r++]&63,p=(c&7)<<18|a<<12|l<<6|u;p>65535&&(p-=65536,s.push(p>>>10&1023|55296),p=56320|p&1023),s.push(p)}else s.push(c);s.length>=Go&&(o+=String.fromCharCode(...s),s.length=0)}return s.length>0&&(o+=String.fromCharCode(...s)),o}var Ho=new TextDecoder,Ko=200;function qo(t,e,n){let r=t.subarray(e,e+n);return Ho.decode(r)}function di(t,e,n){return n>Ko?qo(t,e,n):En(t,e,n)}var Oe=class{constructor(e,n){this.type=e,this.data=n}};var q=class extends Error{constructor(e){super(e);let n=Object.create(q.prototype);Object.setPrototypeOf(this,n),Object.defineProperty(this,"name",{configurable:!0,enumerable:!1,value:q.name})}};function hi(t,e,n){let r=n/4294967296,i=n;t.setUint32(e,r),t.setUint32(e+4,i)}function Pt(t,e,n){let r=Math.floor(n/4294967296),i=n;t.setUint32(e,r),t.setUint32(e+4,i)}function Mt(t,e){let n=t.getInt32(e),r=t.getUint32(e+4);return n*4294967296+r}function pi(t,e){let n=t.getUint32(e),r=t.getUint32(e+4);return n*4294967296+r}var Jo=-1,Xo=4294967296-1,Zo=17179869184-1;function Qo({sec:t,nsec:e}){if(t>=0&&e>=0&&t<=Zo)if(e===0&&t<=Xo){let n=new Uint8Array(4);return new DataView(n.buffer).setUint32(0,t),n}else{let n=t/4294967296,r=t&4294967295,i=new Uint8Array(8),s=new DataView(i.buffer);return s.setUint32(0,e<<2|n&3),s.setUint32(4,r),i}else{let n=new Uint8Array(12),r=new DataView(n.buffer);return r.setUint32(0,e),Pt(r,4,t),n}}function ec(t){let e=t.getTime(),n=Math.floor(e/1e3),r=(e-n*1e3)*1e6,i=Math.floor(r/1e9);return{sec:n+i,nsec:r-i*1e9}}function tc(t){if(t instanceof Date){let e=ec(t);return Qo(e)}else return null}function nc(t){let e=new DataView(t.buffer,t.byteOffset,t.byteLength);switch(t.byteLength){case 4:return{sec:e.getUint32(0),nsec:0};case 8:{let n=e.getUint32(0),r=e.getUint32(4),i=(n&3)*4294967296+r,s=n>>>2;return{sec:i,nsec:s}}case 12:{let n=Mt(e,4),r=e.getUint32(0);return{sec:n,nsec:r}}default:throw new q(`Unrecognized data size for timestamp (expected 4, 8, or 12): ${t.length}`)}}function rc(t){let e=nc(t);return new Date(e.sec*1e3+e.nsec/1e6)}var gi={type:Jo,encode:tc,decode:rc};var Se=class{constructor(){this.builtInEncoders=[],this.builtInDecoders=[],this.encoders=[],this.decoders=[],this.register(gi)}register({type:e,encode:n,decode:r}){if(e>=0)this.encoders[e]=n,this.decoders[e]=r;else{let i=-1-e;this.builtInEncoders[i]=n,this.builtInDecoders[i]=r}}tryToEncode(e,n){for(let r=0;r<this.builtInEncoders.length;r++){let i=this.builtInEncoders[r];if(i!=null){let s=i(e,n);if(s!=null){let o=-1-r;return new Oe(o,s)}}}for(let r=0;r<this.encoders.length;r++){let i=this.encoders[r];if(i!=null){let s=i(e,n);if(s!=null){let o=r;return new Oe(o,s)}}}return e instanceof Oe?e:null}decode(e,n,r){let i=n<0?this.builtInDecoders[-1-n]:this.decoders[n];return i?i(e,n,r):new Oe(n,e)}};Se.defaultCodec=new Se;function ic(t){return t instanceof ArrayBuffer||typeof SharedArrayBuffer!="undefined"&&t instanceof SharedArrayBuffer}function st(t){return t instanceof Uint8Array?t:ArrayBuffer.isView(t)?new Uint8Array(t.buffer,t.byteOffset,t.byteLength):ic(t)?new Uint8Array(t):Uint8Array.from(t)}var sc=100,oc=2048,$e=class{constructor(e){var n,r,i,s,o,c,a,l;this.entered=!1,this.extensionCodec=(n=e==null?void 0:e.extensionCodec)!=null?n:Se.defaultCodec,this.context=e==null?void 0:e.context,this.useBigInt64=(r=e==null?void 0:e.useBigInt64)!=null?r:!1,this.maxDepth=(i=e==null?void 0:e.maxDepth)!=null?i:sc,this.initialBufferSize=(s=e==null?void 0:e.initialBufferSize)!=null?s:oc,this.sortKeys=(o=e==null?void 0:e.sortKeys)!=null?o:!1,this.forceFloat32=(c=e==null?void 0:e.forceFloat32)!=null?c:!1,this.ignoreUndefined=(a=e==null?void 0:e.ignoreUndefined)!=null?a:!1,this.forceIntegerToFloat=(l=e==null?void 0:e.forceIntegerToFloat)!=null?l:!1,this.pos=0,this.view=new DataView(new ArrayBuffer(this.initialBufferSize)),this.bytes=new Uint8Array(this.view.buffer)}clone(){return new $e({extensionCodec:this.extensionCodec,context:this.context,useBigInt64:this.useBigInt64,maxDepth:this.maxDepth,initialBufferSize:this.initialBufferSize,sortKeys:this.sortKeys,forceFloat32:this.forceFloat32,ignoreUndefined:this.ignoreUndefined,forceIntegerToFloat:this.forceIntegerToFloat})}reinitializeState(){this.pos=0}encodeSharedRef(e){if(this.entered)return this.clone().encodeSharedRef(e);try{return this.entered=!0,this.reinitializeState(),this.doEncode(e,1),this.bytes.subarray(0,this.pos)}finally{this.entered=!1}}encode(e){if(this.entered)return this.clone().encode(e);try{return this.entered=!0,this.reinitializeState(),this.doEncode(e,1),this.bytes.slice(0,this.pos)}finally{this.entered=!1}}doEncode(e,n){if(n>this.maxDepth)throw new Error(`Too deep objects in depth ${n}`);e==null?this.encodeNil():typeof e=="boolean"?this.encodeBoolean(e):typeof e=="number"?this.forceIntegerToFloat?this.encodeNumberAsFloat(e):this.encodeNumber(e):typeof e=="string"?this.encodeString(e):this.useBigInt64&&typeof e=="bigint"?this.encodeBigInt64(e):this.encodeObject(e,n)}ensureBufferSizeToWrite(e){let n=this.pos+e;this.view.byteLength<n&&this.resizeBuffer(n*2)}resizeBuffer(e){let n=new ArrayBuffer(e),r=new Uint8Array(n),i=new DataView(n);r.set(this.bytes),this.view=i,this.bytes=r}encodeNil(){this.writeU8(192)}encodeBoolean(e){e===!1?this.writeU8(194):this.writeU8(195)}encodeNumber(e){!this.forceIntegerToFloat&&Number.isSafeInteger(e)?e>=0?e<128?this.writeU8(e):e<256?(this.writeU8(204),this.writeU8(e)):e<65536?(this.writeU8(205),this.writeU16(e)):e<4294967296?(this.writeU8(206),this.writeU32(e)):this.useBigInt64?this.encodeNumberAsFloat(e):(this.writeU8(207),this.writeU64(e)):e>=-32?this.writeU8(224|e+32):e>=-128?(this.writeU8(208),this.writeI8(e)):e>=-32768?(this.writeU8(209),this.writeI16(e)):e>=-2147483648?(this.writeU8(210),this.writeI32(e)):this.useBigInt64?this.encodeNumberAsFloat(e):(this.writeU8(211),this.writeI64(e)):this.encodeNumberAsFloat(e)}encodeNumberAsFloat(e){this.forceFloat32?(this.writeU8(202),this.writeF32(e)):(this.writeU8(203),this.writeF64(e))}encodeBigInt64(e){e>=BigInt(0)?(this.writeU8(207),this.writeBigUint64(e)):(this.writeU8(211),this.writeBigInt64(e))}writeStringHeader(e){if(e<32)this.writeU8(160+e);else if(e<256)this.writeU8(217),this.writeU8(e);else if(e<65536)this.writeU8(218),this.writeU16(e);else if(e<4294967296)this.writeU8(219),this.writeU32(e);else throw new Error(`Too long string: ${e} bytes in UTF-8`)}encodeString(e){let r=fi(e);this.ensureBufferSizeToWrite(5+r),this.writeStringHeader(r),ui(e,this.bytes,this.pos),this.pos+=r}encodeObject(e,n){let r=this.extensionCodec.tryToEncode(e,this.context);if(r!=null)this.encodeExtension(r);else if(Array.isArray(e))this.encodeArray(e,n);else if(ArrayBuffer.isView(e))this.encodeBinary(e);else if(typeof e=="object")this.encodeMap(e,n);else throw new Error(`Unrecognized object: ${Object.prototype.toString.apply(e)}`)}encodeBinary(e){let n=e.byteLength;if(n<256)this.writeU8(196),this.writeU8(n);else if(n<65536)this.writeU8(197),this.writeU16(n);else if(n<4294967296)this.writeU8(198),this.writeU32(n);else throw new Error(`Too large binary: ${n}`);let r=st(e);this.writeU8a(r)}encodeArray(e,n){let r=e.length;if(r<16)this.writeU8(144+r);else if(r<65536)this.writeU8(220),this.writeU16(r);else if(r<4294967296)this.writeU8(221),this.writeU32(r);else throw new Error(`Too large array: ${r}`);for(let i of e)this.doEncode(i,n+1)}countWithoutUndefined(e,n){let r=0;for(let i of n)e[i]!==void 0&&r++;return r}encodeMap(e,n){let r=Object.keys(e);this.sortKeys&&r.sort();let i=this.ignoreUndefined?this.countWithoutUndefined(e,r):r.length;if(i<16)this.writeU8(128+i);else if(i<65536)this.writeU8(222),this.writeU16(i);else if(i<4294967296)this.writeU8(223),this.writeU32(i);else throw new Error(`Too large map object: ${i}`);for(let s of r){let o=e[s];this.ignoreUndefined&&o===void 0||(this.encodeString(s),this.doEncode(o,n+1))}}encodeExtension(e){if(typeof e.data=="function"){let r=e.data(this.pos+6),i=r.length;if(i>=4294967296)throw new Error(`Too large extension object: ${i}`);this.writeU8(201),this.writeU32(i),this.writeI8(e.type),this.writeU8a(r);return}let n=e.data.length;if(n===1)this.writeU8(212);else if(n===2)this.writeU8(213);else if(n===4)this.writeU8(214);else if(n===8)this.writeU8(215);else if(n===16)this.writeU8(216);else if(n<256)this.writeU8(199),this.writeU8(n);else if(n<65536)this.writeU8(200),this.writeU16(n);else if(n<4294967296)this.writeU8(201),this.writeU32(n);else throw new Error(`Too large extension object: ${n}`);this.writeI8(e.type),this.writeU8a(e.data)}writeU8(e){this.ensureBufferSizeToWrite(1),this.view.setUint8(this.pos,e),this.pos++}writeU8a(e){let n=e.length;this.ensureBufferSizeToWrite(n),this.bytes.set(e,this.pos),this.pos+=n}writeI8(e){this.ensureBufferSizeToWrite(1),this.view.setInt8(this.pos,e),this.pos++}writeU16(e){this.ensureBufferSizeToWrite(2),this.view.setUint16(this.pos,e),this.pos+=2}writeI16(e){this.ensureBufferSizeToWrite(2),this.view.setInt16(this.pos,e),this.pos+=2}writeU32(e){this.ensureBufferSizeToWrite(4),this.view.setUint32(this.pos,e),this.pos+=4}writeI32(e){this.ensureBufferSizeToWrite(4),this.view.setInt32(this.pos,e),this.pos+=4}writeF32(e){this.ensureBufferSizeToWrite(4),this.view.setFloat32(this.pos,e),this.pos+=4}writeF64(e){this.ensureBufferSizeToWrite(8),this.view.setFloat64(this.pos,e),this.pos+=8}writeU64(e){this.ensureBufferSizeToWrite(8),hi(this.view,this.pos,e),this.pos+=8}writeI64(e){this.ensureBufferSizeToWrite(8),Pt(this.view,this.pos,e),this.pos+=8}writeBigUint64(e){this.ensureBufferSizeToWrite(8),this.view.setBigUint64(this.pos,e),this.pos+=8}writeBigInt64(e){this.ensureBufferSizeToWrite(8),this.view.setBigInt64(this.pos,e),this.pos+=8}};function vn(t,e){return new $e(e).encodeSharedRef(t)}function Bt(t){return`${t<0?"-":""}0x${Math.abs(t).toString(16).padStart(2,"0")}`}var cc=16,ac=16,kt=class{constructor(e=cc,n=ac){this.hit=0,this.miss=0,this.maxKeyLength=e,this.maxLengthPerKey=n,this.caches=[];for(let r=0;r<this.maxKeyLength;r++)this.caches.push([])}canBeCached(e){return e>0&&e<=this.maxKeyLength}find(e,n,r){let i=this.caches[r-1];e:for(let s of i){let o=s.bytes;for(let c=0;c<r;c++)if(o[c]!==e[n+c])continue e;return s.str}return null}store(e,n){let r=this.caches[e.length-1],i={bytes:e,str:n};r.length>=this.maxLengthPerKey?r[Math.random()*r.length|0]=i:r.push(i)}decode(e,n,r){let i=this.find(e,n,r);if(i!=null)return this.hit++,i;this.miss++;let s=En(e,n,r),o=Uint8Array.prototype.slice.call(e,n,n+r);return this.store(o,s),s}};var Tn="array",at="map_key",mi="map_value",lc=t=>{if(typeof t=="string"||typeof t=="number")return t;throw new q("The type of key must be string or number but "+typeof t)},An=class{constructor(){this.stack=[],this.stackHeadPosition=-1}get length(){return this.stackHeadPosition+1}top(){return this.stack[this.stackHeadPosition]}pushArrayState(e){let n=this.getUninitializedStateFromPool();n.type=Tn,n.position=0,n.size=e,n.array=new Array(e)}pushMapState(e){let n=this.getUninitializedStateFromPool();n.type=at,n.readCount=0,n.size=e,n.map={}}getUninitializedStateFromPool(){if(this.stackHeadPosition++,this.stackHeadPosition===this.stack.length){let e={type:void 0,size:0,array:void 0,position:0,readCount:0,map:void 0,key:null};this.stack.push(e)}return this.stack[this.stackHeadPosition]}release(e){if(this.stack[this.stackHeadPosition]!==e)throw new Error("Invalid stack state. Released state is not on top of the stack.");if(e.type===Tn){let r=e;r.size=0,r.array=void 0,r.position=0,r.type=void 0}if(e.type===at||e.type===mi){let r=e;r.size=0,r.map=void 0,r.readCount=0,r.type=void 0}this.stackHeadPosition--}reset(){this.stack.length=0,this.stackHeadPosition=-1}},ct=-1,Dn=new DataView(new ArrayBuffer(0)),fc=new Uint8Array(Dn.buffer);try{Dn.getInt8(0)}catch(t){if(!(t instanceof RangeError))throw new Error("This module is not supported in the current JavaScript engine because DataView does not throw RangeError on out-of-bounds access")}var yi=new RangeError("Insufficient data"),uc=new kt,Ye=class{constructor(e){var n,r,i,s,o,c,a,l,u;this.totalPos=0,this.pos=0,this.view=Dn,this.bytes=fc,this.headByte=ct,this.stack=new An,this.entered=!1,this.extensionCodec=(n=e==null?void 0:e.extensionCodec)!=null?n:Se.defaultCodec,this.context=e==null?void 0:e.context,this.useBigInt64=(r=e==null?void 0:e.useBigInt64)!=null?r:!1,this.rawStrings=(i=e==null?void 0:e.rawStrings)!=null?i:!1,this.maxStrLength=(s=e==null?void 0:e.maxStrLength)!=null?s:4294967295,this.maxBinLength=(o=e==null?void 0:e.maxBinLength)!=null?o:4294967295,this.maxArrayLength=(c=e==null?void 0:e.maxArrayLength)!=null?c:4294967295,this.maxMapLength=(a=e==null?void 0:e.maxMapLength)!=null?a:4294967295,this.maxExtLength=(l=e==null?void 0:e.maxExtLength)!=null?l:4294967295,this.keyDecoder=(e==null?void 0:e.keyDecoder)!==void 0?e.keyDecoder:uc,this.mapKeyConverter=(u=e==null?void 0:e.mapKeyConverter)!=null?u:lc}clone(){return new Ye({extensionCodec:this.extensionCodec,context:this.context,useBigInt64:this.useBigInt64,rawStrings:this.rawStrings,maxStrLength:this.maxStrLength,maxBinLength:this.maxBinLength,maxArrayLength:this.maxArrayLength,maxMapLength:this.maxMapLength,maxExtLength:this.maxExtLength,keyDecoder:this.keyDecoder})}reinitializeState(){this.totalPos=0,this.headByte=ct,this.stack.reset()}setBuffer(e){let n=st(e);this.bytes=n,this.view=new DataView(n.buffer,n.byteOffset,n.byteLength),this.pos=0}appendBuffer(e){if(this.headByte===ct&&!this.hasRemaining(1))this.setBuffer(e);else{let n=this.bytes.subarray(this.pos),r=st(e),i=new Uint8Array(n.length+r.length);i.set(n),i.set(r,n.length),this.setBuffer(i)}}hasRemaining(e){return this.view.byteLength-this.pos>=e}createExtraByteError(e){let{view:n,pos:r}=this;return new RangeError(`Extra ${n.byteLength-r} of ${n.byteLength} byte(s) found at buffer[${e}]`)}decode(e){if(this.entered)return this.clone().decode(e);try{this.entered=!0,this.reinitializeState(),this.setBuffer(e);let n=this.doDecodeSync();if(this.hasRemaining(1))throw this.createExtraByteError(this.pos);return n}finally{this.entered=!1}}*decodeMulti(e){if(this.entered){yield*this.clone().decodeMulti(e);return}try{for(this.entered=!0,this.reinitializeState(),this.setBuffer(e);this.hasRemaining(1);)yield this.doDecodeSync()}finally{this.entered=!1}}async decodeAsync(e){if(this.entered)return this.clone().decodeAsync(e);try{this.entered=!0;let n=!1,r;for await(let c of e){if(n)throw this.entered=!1,this.createExtraByteError(this.totalPos);this.appendBuffer(c);try{r=this.doDecodeSync(),n=!0}catch(a){if(!(a instanceof RangeError))throw a}this.totalPos+=this.pos}if(n){if(this.hasRemaining(1))throw this.createExtraByteError(this.totalPos);return r}let{headByte:i,pos:s,totalPos:o}=this;throw new RangeError(`Insufficient data in parsing ${Bt(i)} at ${o} (${s} in the current buffer)`)}finally{this.entered=!1}}decodeArrayStream(e){return this.decodeMultiAsync(e,!0)}decodeStream(e){return this.decodeMultiAsync(e,!1)}async*decodeMultiAsync(e,n){if(this.entered){yield*this.clone().decodeMultiAsync(e,n);return}try{this.entered=!0;let r=n,i=-1;for await(let s of e){if(n&&i===0)throw this.createExtraByteError(this.totalPos);this.appendBuffer(s),r&&(i=this.readArraySize(),r=!1,this.complete());try{for(;yield this.doDecodeSync(),--i!==0;);}catch(o){if(!(o instanceof RangeError))throw o}this.totalPos+=this.pos}}finally{this.entered=!1}}doDecodeSync(){e:for(;;){let e=this.readHeadByte(),n;if(e>=224)n=e-256;else if(e<192)if(e<128)n=e;else if(e<144){let i=e-128;if(i!==0){this.pushMapState(i),this.complete();continue e}else n={}}else if(e<160){let i=e-144;if(i!==0){this.pushArrayState(i),this.complete();continue e}else n=[]}else{let i=e-160;n=this.decodeString(i,0)}else if(e===192)n=null;else if(e===194)n=!1;else if(e===195)n=!0;else if(e===202)n=this.readF32();else if(e===203)n=this.readF64();else if(e===204)n=this.readU8();else if(e===205)n=this.readU16();else if(e===206)n=this.readU32();else if(e===207)this.useBigInt64?n=this.readU64AsBigInt():n=this.readU64();else if(e===208)n=this.readI8();else if(e===209)n=this.readI16();else if(e===210)n=this.readI32();else if(e===211)this.useBigInt64?n=this.readI64AsBigInt():n=this.readI64();else if(e===217){let i=this.lookU8();n=this.decodeString(i,1)}else if(e===218){let i=this.lookU16();n=this.decodeString(i,2)}else if(e===219){let i=this.lookU32();n=this.decodeString(i,4)}else if(e===220){let i=this.readU16();if(i!==0){this.pushArrayState(i),this.complete();continue e}else n=[]}else if(e===221){let i=this.readU32();if(i!==0){this.pushArrayState(i),this.complete();continue e}else n=[]}else if(e===222){let i=this.readU16();if(i!==0){this.pushMapState(i),this.complete();continue e}else n={}}else if(e===223){let i=this.readU32();if(i!==0){this.pushMapState(i),this.complete();continue e}else n={}}else if(e===196){let i=this.lookU8();n=this.decodeBinary(i,1)}else if(e===197){let i=this.lookU16();n=this.decodeBinary(i,2)}else if(e===198){let i=this.lookU32();n=this.decodeBinary(i,4)}else if(e===212)n=this.decodeExtension(1,0);else if(e===213)n=this.decodeExtension(2,0);else if(e===214)n=this.decodeExtension(4,0);else if(e===215)n=this.decodeExtension(8,0);else if(e===216)n=this.decodeExtension(16,0);else if(e===199){let i=this.lookU8();n=this.decodeExtension(i,1)}else if(e===200){let i=this.lookU16();n=this.decodeExtension(i,2)}else if(e===201){let i=this.lookU32();n=this.decodeExtension(i,4)}else throw new q(`Unrecognized type byte: ${Bt(e)}`);this.complete();let r=this.stack;for(;r.length>0;){let i=r.top();if(i.type===Tn)if(i.array[i.position]=n,i.position++,i.position===i.size)n=i.array,r.release(i);else continue e;else if(i.type===at){if(n==="__proto__")throw new q("The key __proto__ is not allowed");i.key=this.mapKeyConverter(n),i.type=mi;continue e}else if(i.map[i.key]=n,i.readCount++,i.readCount===i.size)n=i.map,r.release(i);else{i.key=null,i.type=at;continue e}}return n}}readHeadByte(){return this.headByte===ct&&(this.headByte=this.readU8()),this.headByte}complete(){this.headByte=ct}readArraySize(){let e=this.readHeadByte();switch(e){case 220:return this.readU16();case 221:return this.readU32();default:{if(e<160)return e-144;throw new q(`Unrecognized array type byte: ${Bt(e)}`)}}}pushMapState(e){if(e>this.maxMapLength)throw new q(`Max length exceeded: map length (${e}) > maxMapLengthLength (${this.maxMapLength})`);this.stack.pushMapState(e)}pushArrayState(e){if(e>this.maxArrayLength)throw new q(`Max length exceeded: array length (${e}) > maxArrayLength (${this.maxArrayLength})`);this.stack.pushArrayState(e)}decodeString(e,n){return!this.rawStrings||this.stateIsMapKey()?this.decodeUtf8String(e,n):this.decodeBinary(e,n)}decodeUtf8String(e,n){var s;if(e>this.maxStrLength)throw new q(`Max length exceeded: UTF-8 byte length (${e}) > maxStrLength (${this.maxStrLength})`);if(this.bytes.byteLength<this.pos+n+e)throw yi;let r=this.pos+n,i;return this.stateIsMapKey()&&((s=this.keyDecoder)!=null&&s.canBeCached(e))?i=this.keyDecoder.decode(this.bytes,r,e):i=di(this.bytes,r,e),this.pos+=n+e,i}stateIsMapKey(){return this.stack.length>0?this.stack.top().type===at:!1}decodeBinary(e,n){if(e>this.maxBinLength)throw new q(`Max length exceeded: bin length (${e}) > maxBinLength (${this.maxBinLength})`);if(!this.hasRemaining(e+n))throw yi;let r=this.pos+n,i=this.bytes.subarray(r,r+e);return this.pos+=n+e,i}decodeExtension(e,n){if(e>this.maxExtLength)throw new q(`Max length exceeded: ext length (${e}) > maxExtLength (${this.maxExtLength})`);let r=this.view.getInt8(this.pos+n),i=this.decodeBinary(e,n+1);return this.extensionCodec.decode(i,r,this.context)}lookU8(){return this.view.getUint8(this.pos)}lookU16(){return this.view.getUint16(this.pos)}lookU32(){return this.view.getUint32(this.pos)}readU8(){let e=this.view.getUint8(this.pos);return this.pos++,e}readI8(){let e=this.view.getInt8(this.pos);return this.pos++,e}readU16(){let e=this.view.getUint16(this.pos);return this.pos+=2,e}readI16(){let e=this.view.getInt16(this.pos);return this.pos+=2,e}readU32(){let e=this.view.getUint32(this.pos);return this.pos+=4,e}readI32(){let e=this.view.getInt32(this.pos);return this.pos+=4,e}readU64(){let e=pi(this.view,this.pos);return this.pos+=8,e}readI64(){let e=Mt(this.view,this.pos);return this.pos+=8,e}readU64AsBigInt(){let e=this.view.getBigUint64(this.pos);return this.pos+=8,e}readI64AsBigInt(){let e=this.view.getBigInt64(this.pos);return this.pos+=8,e}readF32(){let e=this.view.getFloat32(this.pos);return this.pos+=4,e}readF64(){let e=this.view.getFloat64(this.pos);return this.pos+=8,e}};function bn(t,e){return new Ye(e).decode(t)}var Gt=As(es(),1);function Kn(t){return`Unsupported serialization format: ${t}`}function qn(){return typeof process!="undefined"&&process.versions!==void 0?"node":typeof Deno!="undefined"?"deno":typeof Bun!="undefined"?"bun":typeof window!="undefined"?"browser":"unknown"}function ts({bufferSize:t}={}){let e=t!=null?t:16777216;if(e>=4294967296)throw new Error("bufferSize option must be strictly less than 2 ** 32");let n=new ArrayBuffer(e);return{index:0,buffer:n,uint32Array:new Uint32Array(n),float32Array:new Float32Array(n),reset:function(){this.index=0},serializeBoolean:aa,serializeUInt32:fa,serializeFloat32:da,serializeNumber:pa,serializeString:ma,serializeArray:wa,serializeIterable:Ea,serializeIndexableArray:Da,unsafeSerializeUint32Array:Ta,getBuffer:function(){return this.buffer.slice(0,this.index*4)}}}function ns(t){let e=Math.floor(t.byteLength/4);return{index:0,buffer:t,uint32Array:new Uint32Array(t,0,e),float32Array:new Float32Array(t,0,e),setBuffer:function(n,r,i){if(typeof r=="number"&&typeof i=="number"){this.index=Math.floor(r/4);let o=this.index+Math.ceil(i/4);this.buffer=n,this.uint32Array=new Uint32Array(n,0,o),this.float32Array=new Float32Array(n,0,o);return}let s=Math.floor(n.byteLength/4);this.buffer=n,this.index=0,this.uint32Array=new Uint32Array(n,0,s),this.float32Array=new Float32Array(n,0,s)},deserializeBoolean:la,deserializeUInt32:ua,deserializeFloat32:ha,deserializeNumber:ga,deserializeString:xa,deserializeArray:Ia,deserializeIterable:va,getArrayElements:ba,unsafeDeserializeUint32Array:Aa}}function aa(t){this.uint32Array[this.index++]=t?1:0}function la(){return this.uint32Array[this.index++]===1}function fa(t){this.uint32Array[this.index++]=t}function ua(){return this.uint32Array[this.index++]}function da(t){this.float32Array[this.index++]=t}function ha(){return this.float32Array[this.index++]}function pa(t){t%1!==0?(this.uint32Array[this.index++]=0,this.serializeFloat32(t)):t>=0?(this.uint32Array[this.index++]=1,this.serializeUInt32(t)):(this.uint32Array[this.index++]=2,this.uint32Array[this.index++]=4294967296+t)}function ga(){let t=this.uint32Array[this.index++];if(t===0)return this.deserializeFloat32();if(t===1)return this.deserializeUInt32();if(t===2)return this.uint32Array[this.index++]-4294967296;throw new Error("Unknown type")}var ya=new TextEncoder;function ma(t){let e=ya.encodeInto(t,new Uint8Array(this.buffer,(this.index+1)*4));this.uint32Array[this.index]=e.written,this.index+=Math.ceil(e.written/4)+1}var Sa=new TextDecoder;function xa(){let t=this.uint32Array[this.index++],e=Sa.decode(new Uint8Array(this.buffer,this.index*4,t));return this.index+=Math.ceil(t/4),e}function wa(t,e){let n=t.length;this.serializeUInt32(n);for(let r=0;r<n;r++)e(this,t[r])}function Ia(t){let e=this.deserializeUInt32(),n=new Array(e);for(let r=0;r<e;r++)n[r]=t(this);return n}function Ea(t,e){let n=this.index++,r=0;for(let i of t)r++,e(this,i);this.uint32Array[n]=r}function va(t){let e=this.deserializeUInt32(),n=function*(r){for(let i=0;i<e;i++)yield t(r)}(this);return{[Symbol.iterator](){return n}}}function Ta(t){let e=Math.ceil(t.byteLength/4);this.uint32Array[this.index++]=e,this.uint32Array.set(t,this.index),this.index+=e}function Aa(){let t=this.uint32Array[this.index++],e=new Uint32Array(this.buffer,this.index*4,t);return this.index+=t,e}function Da(t,e){let n=t.length;this.uint32Array[this.index++]=n;let r=this.index;this.index+=n*2;for(let i=0;i<n;i++){let s=this.index;e(this,t[i]);let o=this.index;this.uint32Array[r++]=s,this.uint32Array[r++]=o-s}}function ba(t,e){let n=this.index+1,r=t.length,i=new Array(r);for(let s=0;s<r;s++){let o=n+t[s]*2,c=this.uint32Array[o],a=this.uint32Array[o+1];i[s]=e(this,c*4,a)}return i}function Ua(t,e){t.serializeUInt32(e.length);for(let n=0;n<e.length;n++)t.serializeString(e[n])}function za(t){let e=t.deserializeUInt32(),n=new Array(e);for(let r=0;r<e;r++)n[r]=t.deserializeString();return n}function Oa(t){let e=t.deserializeUInt32(),n=new Array(e);for(let r=0;r<e;r++)n[r]=t.deserializeNumber();return n}function rs(t,e,n){if(e==="Radix"){if(t.serializeUInt32(1),t.serializeString(n.w||""),t.serializeString(n.s||""),t.serializeBoolean(n.e||!1),t.serializeString(n.k||""),Array.isArray(n.d)){t.serializeUInt32(n.d.length);for(let r=0;r<n.d.length;r++)t.serializeNumber(n.d[r])}else t.serializeUInt32(0);if(Array.isArray(n.c)){t.serializeUInt32(n.c.length);for(let r=0;r<n.c.length;r++){let[i,s]=n.c[r];t.serializeString(i),rs(t,"Radix",s)}}else t.serializeUInt32(0)}else if(e==="Flat")if(t.serializeUInt32(2),n.numberToDocumentId&&Array.isArray(n.numberToDocumentId)){t.serializeUInt32(n.numberToDocumentId.length);for(let r=0;r<n.numberToDocumentId.length;r++){let[i,s]=n.numberToDocumentId[r];t.serializeString(String(i));let o=Array.isArray(s)?s.map(c=>String(c)):[];Ua(t,o)}}else t.serializeUInt32(0);else t.serializeUInt32(0),jt(t,n)}function is(t){let e=t.deserializeUInt32();if(e===1){let n=t.deserializeString(),r=t.deserializeString(),i=t.deserializeBoolean(),s=t.deserializeString(),o=Oa(t),c=t.deserializeUInt32(),a=[];for(let l=0;l<c;l++){let u=t.deserializeString(),p=is(t);a.push([u,p])}return{w:n||"",s:r||"",e:i,k:s||"",d:o,c:a}}else if(e===2){let n=t.deserializeUInt32(),r=[];for(let i=0;i<n;i++){let s=t.deserializeString(),o=za(t);r.push([s,o])}return{numberToDocumentId:r}}else return pt(t)}function ss(t,e){let n=Object.keys(e);t.serializeUInt32(n.length);let r=n.length;for(let i=0;i<r;i++){let s=n[i];t.serializeString(s),t.serializeNumber(e[s])}}function os(t){let e=t.deserializeUInt32(),n={};for(let r=0;r<e;r++){let i=t.deserializeString();n[i]=t.deserializeNumber()}return n}function _a(t,e){let n=Object.keys(e),r=n.length;t.serializeUInt32(r);for(let i=0;i<r;i++){let s=n[i];t.serializeString(s);let o=e[s]||{},c=Object.keys(o);t.serializeUInt32(c.length);for(let a=0;a<c.length;a++){let l=c[a];t.serializeString(l),ss(t,o[l]||{})}}}function Na(t){let e=t.deserializeUInt32(),n={};for(let r=0;r<e;r++){let i=t.deserializeString(),s=t.deserializeUInt32(),o={};for(let c=0;c<s;c++){let a=t.deserializeString();o[a]=os(t)}n[i]=o}return n}function Ra(t,e){let n=Object.keys(e);t.serializeUInt32(n.length);for(let r=0;r<n.length;r++){let i=n[r];t.serializeString(i),ss(t,e[i]||{})}}function Pa(t){let e=t.deserializeUInt32(),n={};for(let r=0;r<e;r++){let i=t.deserializeString();n[i]=os(t)}return n}function jt(t,e){if(e===null){t.serializeUInt32(0);return}if(e===void 0){t.serializeUInt32(1);return}let n=typeof e;if(n==="string"){t.serializeUInt32(2),t.serializeString(e);return}if(n==="number"){t.serializeUInt32(3),t.serializeNumber(e);return}if(n==="boolean"){t.serializeUInt32(4),t.serializeBoolean(e);return}if(Array.isArray(e)){t.serializeUInt32(5),t.serializeUInt32(e.length);for(let o=0;o<e.length;o++)jt(t,e[o]);return}t.serializeUInt32(6);let r=e,i=Object.keys(r),s=i.length;t.serializeUInt32(s);for(let o=0;o<s;o++){let c=i[o];t.serializeString(c),jt(t,r[c])}}function pt(t){let e=t.deserializeUInt32();if(e===0)return null;if(e!==1){if(e===2)return t.deserializeString();if(e===3)return t.deserializeNumber();if(e===4)return t.deserializeBoolean();if(e===5){let n=t.deserializeUInt32(),r=new Array(n);for(let i=0;i<n;i++)r[i]=pt(t);return r}if(e===6){let n=t.deserializeUInt32(),r={};for(let i=0;i<n;i++){let s=t.deserializeString();r[s]=pt(t)}return r}throw new Error(`Unknown type: ${e}`)}}function cs(t){var h,g,f,y,d,S,m,v,E,x,b;let e=it(t),n=ts();n.serializeUInt32(2);let r=((h=e.internalDocumentIDStore)==null?void 0:h.internalIdToId)||[];n.serializeUInt32(r.length);for(let w=0;w<r.length;w++)n.serializeString(r[w]);if(n.serializeUInt32(((g=e.docs)==null?void 0:g.count)||0),(f=e.docs)!=null&&f.docs){let w=Object.keys(e.docs.docs);n.serializeUInt32(w.length);for(let T=0;T<w.length;T++){let O=w[T],A=e.docs.docs[O];n.serializeString(O);let P=Object.keys(A);n.serializeUInt32(P.length);for(let U=0;U<P.length;U++){let L=P[U];n.serializeString(L);let M=A[L];if(Array.isArray(M)){n.serializeUInt32(M.length|2147483648);for(let W=0;W<M.length;W++)n.serializeString(M[W])}else n.serializeUInt32(0),n.serializeString(String(M))}}}else n.serializeUInt32(0);if((y=e.index)!=null&&y.indexes){let w=Object.keys(e.index.indexes);n.serializeUInt32(w.length);for(let T=0;T<w.length;T++){let O=w[T],A=e.index.indexes[O];n.serializeString(O),n.serializeString(A.type||""),n.serializeBoolean(A.isArray||!1);let P=A.node||{};if(A.type==="Radix"){n.serializeUInt32(1),n.serializeString(P.w||""),n.serializeString(P.s||""),n.serializeBoolean(P.e||!1),n.serializeString(P.k||"");let U=P.d||[];n.serializeUInt32(U.length);for(let M=0;M<U.length;M++)n.serializeNumber(U[M]);let L=P.c||[];n.serializeUInt32(L.length);for(let M=0;M<L.length;M++){let[W,j]=L[M];n.serializeString(W),rs(n,"Radix",j)}}else if(A.type==="Flat"){n.serializeUInt32(2);let U=P.numberToDocumentId||[];n.serializeUInt32(U.length);for(let L=0;L<U.length;L++){let[M,W]=U[L];n.serializeString(String(M));let j=Array.isArray(W)?W.map(ee=>String(ee)):[];n.serializeUInt32(j.length);for(let ee=0;ee<j.length;ee++)n.serializeString(j[ee])}}else n.serializeUInt32(0)}}else n.serializeUInt32(0);let i=((d=e.index)==null?void 0:d.searchableProperties)||[];n.serializeUInt32(i.length);for(let w=0;w<i.length;w++)n.serializeString(i[w]);let s=((S=e.index)==null?void 0:S.searchablePropertiesWithTypes)||{},o=Object.keys(s);n.serializeUInt32(o.length);for(let w=0;w<o.length;w++){let T=o[w];n.serializeString(T),n.serializeString(s[T])}_a(n,((m=e.index)==null?void 0:m.frequencies)||{}),Ra(n,((v=e.index)==null?void 0:v.tokenOccurrences)||{});let c=((E=e.index)==null?void 0:E.avgFieldLength)||{},a=Object.keys(c);n.serializeUInt32(a.length);for(let w=0;w<a.length;w++){let T=a[w];n.serializeString(T),n.serializeNumber(c[T])}let l=((x=e.index)==null?void 0:x.fieldLengths)||{},u=Object.keys(l);n.serializeUInt32(u.length);for(let w=0;w<u.length;w++){let T=u[w];n.serializeString(T);let O=l[T]||{},A=Object.keys(O);n.serializeUInt32(A.length);for(let P=0;P<A.length;P++){let U=A[P];n.serializeString(U),n.serializeNumber(O[U])}}n.serializeString(e.language||"");let p=((b=e.pinning)==null?void 0:b.rules)||[];n.serializeUInt32(p.length);for(let w=0;w<p.length;w++){let[T,O]=p[w];n.serializeString(T),jt(n,O)}return n.getBuffer()}function as(t){let e=ns(t),n=e.deserializeUInt32();if(n===1)return pt(e);if(n!==2)throw new Error(`Unsupported seqproto Orama serialization version: ${n}`);let r={},i=e.deserializeUInt32(),s=new Array(i);for(let w=0;w<i;w++)s[w]=e.deserializeString();r.internalDocumentIDStore={internalIdToId:s};let o=e.deserializeUInt32(),c=e.deserializeUInt32(),a={};for(let w=0;w<c;w++){let T=e.deserializeString(),O={},A=e.deserializeUInt32();for(let P=0;P<A;P++){let U=e.deserializeString(),L=e.deserializeUInt32();if(L&2147483648){let M=L&2147483647,W=new Array(M);for(let j=0;j<M;j++)W[j]=e.deserializeString();O[U]=W}else O[U]=e.deserializeString()}a[T]=O}r.docs={docs:a,count:o};let l=e.deserializeUInt32(),u={};for(let w=0;w<l;w++){let T=e.deserializeString(),O=e.deserializeString(),A=e.deserializeBoolean(),P=e.deserializeUInt32(),U;if(P===1){let L=e.deserializeString(),M=e.deserializeString(),W=e.deserializeBoolean(),j=e.deserializeString(),ee=e.deserializeUInt32(),I=new Array(ee);for(let z=0;z<ee;z++)I[z]=e.deserializeNumber();let N=e.deserializeUInt32(),D=new Array(N);for(let z=0;z<N;z++){let B=e.deserializeString(),F=is(e);D[z]=[B,F]}U={w:L,s:M,e:W,k:j,d:I,c:D}}else if(P===2){let L=e.deserializeUInt32(),M=new Array(L);for(let W=0;W<L;W++){let j=e.deserializeString(),ee=e.deserializeUInt32(),I=new Array(ee);for(let N=0;N<ee;N++)I[N]=e.deserializeString();M[W]=[j,I]}U={numberToDocumentId:M}}else U={};u[T]={type:O,isArray:A,node:U}}let p=e.deserializeUInt32(),h=new Array(p);for(let w=0;w<p;w++)h[w]=e.deserializeString();let g=e.deserializeUInt32(),f={};for(let w=0;w<g;w++){let T=e.deserializeString(),O=e.deserializeString();f[T]=O}let y=Na(e),d=Pa(e),S=e.deserializeUInt32(),m={};for(let w=0;w<S;w++){let T=e.deserializeString();m[T]=e.deserializeNumber()}let v=e.deserializeUInt32(),E={};for(let w=0;w<v;w++){let T=e.deserializeString(),O=e.deserializeUInt32(),A={};for(let P=0;P<O;P++){let U=e.deserializeString();A[U]=e.deserializeNumber()}E[T]=A}r.index={indexes:u,vectorIndexes:{},searchableProperties:h,searchablePropertiesWithTypes:f,frequencies:y,tokenOccurrences:d,avgFieldLength:m,fieldLengths:E},r.language=e.deserializeString();let x=e.deserializeUInt32(),b=new Array(x);for(let w=0;w<x;w++){let T=e.deserializeString(),O=pt(e);b[w]=[T,O]}return r.pinning={rules:b},r.sorting={},r}var Jn={0:0,1:1,2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9,a:10,b:11,c:12,d:13,e:14,f:15},ls=Object.keys(Jn);function Ma(t){let e=new Uint8Array(Math.floor(t.length/2));t=t.toLowerCase();for(let n=0;n<t.length;n++){let r=Jn[t[n*2]],i=Jn[t[n*2+1]];if(r===void 0||i===void 0)break;e[n]=r<<4|i}return e}function Ba(t){return Array.from(t||[]).map(e=>ls[e>>4]+ls[e&15]).join("")}async function fs(t,e="binary",n){n||(n=qn());let r=await it(t),i;switch(e){case"json":i=JSON.stringify(r);break;case"dpack":i=Gt.serialize(r);break;case"binary":{let s=vn(r);n==="node"?(i=Buffer.from(s.buffer,s.byteOffset,s.byteLength),i=i.toString("hex")):i=Ba(s);break}case"seqproto":i=cs(t);break;default:throw new Error(Kn(e))}return i}async function us(t,e,n){n||(n=qn());let r=rt({schema:{__placeholder:"string"}}),i;switch(t){case"json":i=JSON.parse(e.toString());break;case"dpack":i=Gt.parse(e);break;case"binary":{n==="node"?e=Buffer.from(e.toString(),"hex"):e=Ma(e),i=bn(e);break}case"seqproto":{let s;if(e instanceof ArrayBuffer)s=e;else if(ArrayBuffer.isView(e)){let o=e,c=o.buffer.slice(o.byteOffset,o.byteOffset+o.byteLength),a=new Uint8Array(o.byteLength);a.set(new Uint8Array(c)),s=a.buffer}else if(typeof e=="string"){let o=Buffer.from(e,"binary"),c=o.buffer.slice(o.byteOffset,o.byteOffset+o.byteLength),a=new Uint8Array(o.byteLength);a.set(new Uint8Array(c)),s=a.buffer}else throw new Error("Unsupported data type for seqproto restore");i=as(s)}break;default:throw new Error(Kn(t))}return wn(r,i),r}async function ds(t){try{let e=await fs(t,"dpack","browser");if(e instanceof ArrayBuffer)return e;if(e instanceof Buffer)return e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength);if(typeof e=="string")return new TextEncoder().encode(e).buffer;throw new Error("Unexpected data type from persist")}catch(e){let n=e instanceof Error?e.message:"Unknown error";throw new Error(`Failed to serialize index: ${n}`)}}async function hs(t,e,n=1536){try{return await us("dpack",t,"browser")}catch(r){let i=r instanceof Error?r.message:"Unknown error";throw new Error(`Failed to deserialize index: ${i}`)}}var $=null;console.log("[SearchWorker] Worker script loaded and ready");self.onmessage=async t=>{let{type:e,payload:n}=t.data;console.log("[SearchWorker] Received message:",e,n?"(with payload)":"(no payload)");try{switch(e){case"INIT_DB":console.log("[SearchWorker] Handling INIT_DB..."),await ka(n);break;case"ADD_DOCUMENT":await ps(n);break;case"UPDATE_DOCUMENT":await Ca(n);break;case"REMOVE_DOCUMENT":await gs(n);break;case"SEARCH_KEYWORD":await ys(n);break;case"SEARCH_VECTOR":await ms(n);break;case"SEARCH_HYBRID":await Fa(n);break;case"SAVE_INDEX":await Va();break;case"LOAD_INDEX":await Wa(n);break;case"VECTORIZE_FILE":await $a(n);break;case"CHECK_DOCUMENT_EXISTS":await Ga(n);break;default:Y(`Unknown message type: ${e}`)}}catch(r){let i=r instanceof Error?r.message:"Unknown error",s=r instanceof Error?r.stack:void 0;console.error("[SearchWorker] Unhandled error in message handler:",{message:i,stack:s,error:r,messageType:e}),Y(`Unhandled error: ${i}`)}};self.onerror=t=>{console.error("[SearchWorker] Global error handler:",{message:t.message,filename:t.filename,lineno:t.lineno,colno:t.colno,error:t.error})};self.onunhandledrejection=t=>{console.error("[SearchWorker] Unhandled promise rejection:",t.reason)};async function ka(t){try{console.log("[SearchWorker] Starting DB initialization...");let e=(t==null?void 0:t.vectorDimensions)||li;console.log("[SearchWorker] Vector dimensions:",e),console.log("[SearchWorker] Creating schema...");let n=ai(e);console.log("[SearchWorker] Schema created:",Object.keys(n)),console.log("[SearchWorker] Creating Orama instance..."),$=await rt({schema:n}),console.log("[SearchWorker] Orama DB created successfully, db type:",typeof $),console.log("[SearchWorker] Sending INIT_DB_DONE message..."),ae({type:"INIT_DB_DONE",payload:{success:!0,vectorDimensions:e}}),console.log("[SearchWorker] INIT_DB_DONE message sent successfully")}catch(e){let n=e instanceof Error?e.message:String(e),r=e instanceof Error?e.stack:void 0;console.error("[SearchWorker] DB initialization error:",{message:n,stack:r,error:e}),Y(`Failed to initialize DB: ${n}`)}}async function ps(t){if(!$){Y("DB not initialized");return}try{let{filePath:e,title:n,content:r,vector:i,metadata:s}=t;await Ce($,{filePath:e,title:n,content:r,vector:i,...s?{metadata:s}:{}}),ae({type:"DOCUMENT_ADDED",payload:{filePath:e,success:!0}})}catch(e){Y(`Failed to add document: ${e}`)}}async function Ca(t){if(!$){Y("DB not initialized");return}try{let{filePath:e,title:n,content:r,vector:i,metadata:s}=t;await gs({filePath:e}),await ps({filePath:e,title:n,content:r,vector:i,metadata:s}),ae({type:"DOCUMENT_UPDATED",payload:{filePath:e,success:!0}})}catch(e){Y(`Failed to update document: ${e}`)}}async function gs(t){if(!$){Y("DB not initialized");return}try{let{filePath:e}=t,n=await ge($,{term:e,properties:["filePath"]});n.hits.length>0&&await _t($,n.hits[0].id),ae({type:"DOCUMENT_REMOVED",payload:{filePath:e,success:!0}})}catch(e){Y(`Failed to remove document: ${e}`)}}async function ys(t){if(!$){Y("DB not initialized");return}try{let{query:e,limit:n=20}=t,r=e.trim().split(/\s+/).filter(u=>u.length>0);if(r.length===0){ae({type:"SEARCH_KEYWORD_RESULTS",payload:{hits:[],count:0}});return}let i=[];if(r.length>1){let u=new Map;for(let h of r){let g=await ge($,{term:h,limit:n*2});u.set(h,g.hits)}let p=u.get(r[0])||[];for(let h of p){let g=h.document.filePath,f=!0;for(let y=1;y<r.length;y++)if(!(u.get(r[y])||[]).some(m=>m.document.filePath===g)){f=!1;break}if(f){let y=r.reduce((d,S)=>{let v=(u.get(S)||[]).find(E=>E.document.filePath===g);return d+((v==null?void 0:v.score)||0)},0);i.push({...h,score:y/r.length})}}}else{let u=await ge($,{term:r[0],limit:n*2});i.push(...u.hits)}let s=[],o=new Set(i.map(u=>u.document.filePath));for(let u of r){let p=await ge($,{term:u,limit:n*2});for(let h of p.hits)o.has(h.document.filePath)||s.some(f=>f.document.filePath===h.document.filePath)||s.push(h)}let c=(u,p)=>{var f,y;let h=((f=u.document.metadata)==null?void 0:f.lastModified)||0;return(((y=p.document.metadata)==null?void 0:y.lastModified)||0)-h};i.sort((u,p)=>Math.abs(u.score-p.score)>.001?p.score-u.score:c(u,p)),s.sort(c);let a=[...i,...s].slice(0,n),l={hits:a.map(u=>({id:u.id,score:u.score,document:{filePath:u.document.filePath,title:u.document.title,content:u.document.content,metadata:u.document.metadata}})),count:a.length};ae({type:"SEARCH_KEYWORD_RESULTS",payload:l})}catch(e){Y(`Failed to search keyword: ${e}`)}}async function ms(t){if(!$){Y("DB not initialized");return}try{let{vector:e,limit:n=10}=t;n=Math.max(10,Math.min(100,n));let i=(await We($,{mode:"vector",vector:{value:e,property:"vector"},limit:n})).hits.sort((o,c)=>c.score-o.score),s={hits:i.map(o=>{var c;return{id:o.id,score:o.score,document:{filePath:o.document.filePath,title:o.document.title,content:((c=o.document.content)==null?void 0:c.substring(0,500))||"",metadata:o.document.metadata}}}),count:i.length};ae({type:"SEARCH_VECTOR_RESULTS",payload:s})}catch(e){Y(`Failed to search vector: ${e}`)}}function La(t,e,n=60){var i,s;let r=new Map;for(let o=0;o<t.length;o++){let c=t[o],a=c.id||((i=c.document)==null?void 0:i.filePath)||String(o),l=1/(n+o);r.has(a)?r.get(a).rrfScore+=l:r.set(a,{id:a,rrfScore:l,document:c.document||c,ranks:[o+1]})}for(let o=0;o<e.length;o++){let c=e[o],a=c.id||((s=c.document)==null?void 0:s.filePath)||String(o),l=1/(n+o);if(r.has(a)){let u=r.get(a);u.rrfScore+=l,u.ranks.push(o+1)}else r.set(a,{id:a,rrfScore:l,document:c.document||c,ranks:[o+1]})}return Array.from(r.values()).sort((o,c)=>c.rrfScore-o.rrfScore).map(o=>({id:o.id,score:o.rrfScore,document:o.document,ranks:o.ranks}))}async function Fa(t){if(!$){Y("DB not initialized");return}try{let{query:e,vector:n,limit:r=10}=t,i=Math.max(r*2,20),s=new Promise(g=>{ys({query:e,limit:i}).then(()=>{g(null)}).catch(()=>g(null))}),o=new Promise(g=>{ms({vector:n,limit:i}).then(()=>{g(null)}).catch(()=>g(null))}),c=e.trim().split(/\s+/).filter(g=>g.length>0),a=[];c.length>0&&(a=(await ge($,{term:c[0],limit:i})).hits.map(f=>{var y;return{id:f.id||((y=f.document)==null?void 0:y.filePath),score:f.score,document:{filePath:f.document.filePath,title:f.document.title,content:f.document.content,metadata:f.document.metadata}}}));let u=(await We($,{mode:"vector",vector:{value:n,property:"vector"},limit:i})).hits.map(g=>{var f;return{id:g.id||((f=g.document)==null?void 0:f.filePath),score:g.score,document:{filePath:g.document.filePath,title:g.document.title,content:g.document.content,metadata:g.document.metadata}}}),h=La(a,u,60).slice(0,r);ae({type:"SEARCH_HYBRID_RESULTS",payload:{hits:h,count:h.length}})}catch(e){Y(`Failed to search hybrid: ${e}`)}}async function Va(){if(!$){Y("DB not initialized");return}try{let t=await ds($);self.postMessage({type:"INDEX_SAVED",payload:{data:t}},[t])}catch(t){Y(`Failed to save index: ${t}`)}}async function Wa(t){try{let{data:e,vectorDimensions:n}=t;$=await hs(e,null,n),ae({type:"INDEX_LOADED",payload:{success:!0}})}catch(e){Y(`Failed to load index: ${e}`)}}function ae(t){try{self.postMessage(t)}catch(e){console.error("[SearchWorker] Failed to send response:",e,t),Y(`Failed to send response: ${e instanceof Error?e.message:String(e)}`)}}async function $a(t){if(!$){Y("DB not initialized");return}try{let{filePath:e,title:n,content:r,metadata:i,apiKey:s,model:o,timeoutSeconds:c}=t,a=ja(r);if(!a||a.trim().length===0){Y(`File has no extractable text: ${e}`);return}let l=await Ya(a,s,o,c);await Ce($,{filePath:e,title:n,content:a.substring(0,1e3),vector:l,...i?{metadata:i}:{}}),ae({type:"FILE_VECTORIZED",payload:{filePath:e,success:!0,dimensions:l.length}})}catch(e){let n=e instanceof Error?e.message:"Unknown error";Y(`Failed to vectorize file: ${n}`)}}async function Ya(t,e,n,r){var o;let i=new AbortController,s=setTimeout(()=>i.abort(),r*1e3);try{let c=await fetch("https://openrouter.ai/api/v1/embeddings",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`,"HTTP-Referer":"https://obsidian.md","X-Title":"Knowledge Connect Plugin"},body:JSON.stringify({model:n,input:t}),signal:i.signal});if(clearTimeout(s),!c.ok){let u=await c.json().catch(()=>({}));throw new Error(`OpenRouter Embedding API \u30A8\u30E9\u30FC: ${c.status} ${c.statusText}. ${((o=u.error)==null?void 0:o.message)||""}`)}let a=await c.json();if(!a.data||!Array.isArray(a.data)||a.data.length===0)throw new Error("OpenRouter Embedding API\u304B\u3089\u306E\u5FDC\u7B54\u5F62\u5F0F\u304C\u4E0D\u6B63\u3067\u3059\u3002");let l=a.data[0];if(!l.embedding||!Array.isArray(l.embedding))throw new Error("Embedding\u30C7\u30FC\u30BF\u304C\u4E0D\u6B63\u3067\u3059\u3002");return l.embedding}catch(c){throw clearTimeout(s),c instanceof Error?c.name==="AbortError"?new Error(`\u30EA\u30AF\u30A8\u30B9\u30C8\u304C\u30BF\u30A4\u30E0\u30A2\u30A6\u30C8\u3057\u307E\u3057\u305F\uFF08${r}\u79D2\uFF09\u3002`):c:new Error("\u4E88\u671F\u3057\u306A\u3044\u30A8\u30E9\u30FC\u304C\u767A\u751F\u3057\u307E\u3057\u305F\u3002")}}function ja(t){let e=t,n=/^---\s*\n([\s\S]*?)\n---\s*\n/;return e=e.replace(n,""),e=e.replace(/```[\s\S]*?```/g,""),e=e.replace(/`[^`]+`/g,""),e=e.replace(/!\[([^\]]*)\]\([^\)]+\)/g,""),e=e.replace(/\[([^\]]+)\]\([^\)]+\)/g,"$1"),e=e.replace(/^#{1,6}\s+/gm,""),e=e.replace(/^[\*\-\+]\s+/gm,""),e=e.replace(/^\d+\.\s+/gm,""),e=e.replace(/^---+\s*$/gm,""),e=e.replace(/\n{3,}/g,`

`),e=e.trim(),e}async function Ga(t){if(!$){Y("DB not initialized");return}try{let{filePath:e}=t,n=e.split("/").pop()||e,i=(await ge($,{term:n,limit:100})).hits.some(s=>s.document.filePath===e);ae({type:"CHECK_DOCUMENT_EXISTS_RESULT",payload:{exists:i}})}catch(e){Y(`Failed to check document exists: ${e}`)}}function Y(t){console.error("[SearchWorker] Sending error to main thread:",t);try{self.postMessage({type:"ERROR",error:t})}catch(e){console.error("[SearchWorker] Failed to send error message:",e)}}})();
